
﻿<!DOCTYPE html>
<html>
<head>  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,user-scalable=0">
  <meta name="author" content="微信公众号：颜家大少">
  <meta name="email" content="3056432@qq.com">
  <meta name="description" content="一个Markdown在线转换工具，让Markdown内容，不需作任何调整就能同时在微信公众号、博客园、掘金、csdn等平台正确显示当前预览的效果">
  <title>Md2All export document</title>  
  <style type="text/css" id="markdown_preview_css"> 
 .output_wrapper pre code{font-family: Consolas, Inconsolata, Courier, monospace; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important;  overflow: auto !important;}  
.output_wrapper a:hover { text-decoration: underline; color: rgb(0, 96, 100); }
.output_wrapper figcaption { margin-top: 10px; text-align: center; color: rgb(153, 153, 153); font-size: 0.7em; }
.output_wrapper pre code .linenum { padding-right: 20px; word-spacing: 0px; }
.task-list-list { list-style-type: none; }
.task-list-list.checked { color: rgb(62, 62, 62); }
.task-list-list.uncheck { color: rgb(191, 193, 191); }
.task-list-list .icon_uncheck, .task-list-list .icon_check { display: inline-block; vertical-align: middle; margin-right: 10px; }
.task-list-list .icon_check::before { content: "√"; border: 2px solid rgb(62, 62, 62); color: red; }
.task-list-list .icon_uncheck::before { content: "x"; border: 2px solid rgb(191, 193, 191); color: rgb(191, 193, 191); }
.task-list-list .icon_check::before, .task-list-list .icon_uncheck::before { padding: 2px 8px 2px 5px; border-radius: 5px; }
@font-face { font-family: "KaTeX_AMS"; src: url("fonts/KaTeX_AMS-Regular.woff2") format("woff2"), url("fonts/KaTeX_AMS-Regular.woff") format("woff"), url("fonts/KaTeX_AMS-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Caligraphic"; src: url("fonts/KaTeX_Caligraphic-Bold.woff2") format("woff2"), url("fonts/KaTeX_Caligraphic-Bold.woff") format("woff"), url("fonts/KaTeX_Caligraphic-Bold.ttf") format("truetype"); font-style: normal; font-weight: bold; }
@font-face { font-family: "KaTeX_Caligraphic"; src: url("fonts/KaTeX_Caligraphic-Regular.woff2") format("woff2"), url("fonts/KaTeX_Caligraphic-Regular.woff") format("woff"), url("fonts/KaTeX_Caligraphic-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Fraktur"; src: url("fonts/KaTeX_Fraktur-Bold.woff2") format("woff2"), url("fonts/KaTeX_Fraktur-Bold.woff") format("woff"), url("fonts/KaTeX_Fraktur-Bold.ttf") format("truetype"); font-style: normal; font-weight: bold; }
@font-face { font-family: "KaTeX_Fraktur"; src: url("fonts/KaTeX_Fraktur-Regular.woff2") format("woff2"), url("fonts/KaTeX_Fraktur-Regular.woff") format("woff"), url("fonts/KaTeX_Fraktur-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Main"; src: url("fonts/KaTeX_Main-Bold.woff2") format("woff2"), url("fonts/KaTeX_Main-Bold.woff") format("woff"), url("fonts/KaTeX_Main-Bold.ttf") format("truetype"); font-style: normal; font-weight: bold; }
@font-face { font-family: "KaTeX_Main"; src: url("fonts/KaTeX_Main-BoldItalic.woff2") format("woff2"), url("fonts/KaTeX_Main-BoldItalic.woff") format("woff"), url("fonts/KaTeX_Main-BoldItalic.ttf") format("truetype"); font-style: italic; font-weight: bold; }
@font-face { font-family: "KaTeX_Main"; src: url("fonts/KaTeX_Main-Italic.woff2") format("woff2"), url("fonts/KaTeX_Main-Italic.woff") format("woff"), url("fonts/KaTeX_Main-Italic.ttf") format("truetype"); font-style: italic; font-weight: normal; }
@font-face { font-family: "KaTeX_Main"; src: url("fonts/KaTeX_Main-Regular.woff2") format("woff2"), url("fonts/KaTeX_Main-Regular.woff") format("woff"), url("fonts/KaTeX_Main-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Math"; src: url("fonts/KaTeX_Math-BoldItalic.woff2") format("woff2"), url("fonts/KaTeX_Math-BoldItalic.woff") format("woff"), url("fonts/KaTeX_Math-BoldItalic.ttf") format("truetype"); font-style: italic; font-weight: bold; }
@font-face { font-family: "KaTeX_Math"; src: url("fonts/KaTeX_Math-Italic.woff2") format("woff2"), url("fonts/KaTeX_Math-Italic.woff") format("woff"), url("fonts/KaTeX_Math-Italic.ttf") format("truetype"); font-style: italic; font-weight: normal; }
@font-face { font-family: "KaTeX_SansSerif"; src: url("fonts/KaTeX_SansSerif-Bold.woff2") format("woff2"), url("fonts/KaTeX_SansSerif-Bold.woff") format("woff"), url("fonts/KaTeX_SansSerif-Bold.ttf") format("truetype"); font-style: normal; font-weight: bold; }
@font-face { font-family: "KaTeX_SansSerif"; src: url("fonts/KaTeX_SansSerif-Italic.woff2") format("woff2"), url("fonts/KaTeX_SansSerif-Italic.woff") format("woff"), url("fonts/KaTeX_SansSerif-Italic.ttf") format("truetype"); font-style: italic; font-weight: normal; }
@font-face { font-family: "KaTeX_SansSerif"; src: url("fonts/KaTeX_SansSerif-Regular.woff2") format("woff2"), url("fonts/KaTeX_SansSerif-Regular.woff") format("woff"), url("fonts/KaTeX_SansSerif-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Script"; src: url("fonts/KaTeX_Script-Regular.woff2") format("woff2"), url("fonts/KaTeX_Script-Regular.woff") format("woff"), url("fonts/KaTeX_Script-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Size1"; src: url("fonts/KaTeX_Size1-Regular.woff2") format("woff2"), url("fonts/KaTeX_Size1-Regular.woff") format("woff"), url("fonts/KaTeX_Size1-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Size2"; src: url("fonts/KaTeX_Size2-Regular.woff2") format("woff2"), url("fonts/KaTeX_Size2-Regular.woff") format("woff"), url("fonts/KaTeX_Size2-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Size3"; src: url("fonts/KaTeX_Size3-Regular.woff2") format("woff2"), url("fonts/KaTeX_Size3-Regular.woff") format("woff"), url("fonts/KaTeX_Size3-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Size4"; src: url("fonts/KaTeX_Size4-Regular.woff2") format("woff2"), url("fonts/KaTeX_Size4-Regular.woff") format("woff"), url("fonts/KaTeX_Size4-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Typewriter"; src: url("fonts/KaTeX_Typewriter-Regular.woff2") format("woff2"), url("fonts/KaTeX_Typewriter-Regular.woff") format("woff"), url("fonts/KaTeX_Typewriter-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@media screen {
  .katex .mtable .vertical-separator { min-width: 1px; }
  .katex .mfrac .frac-line, .katex .overline .overline-line, .katex .underline .underline-line, .katex .hline, .katex .hdashline, .katex .rule { min-height: 1px; }
}
.katex-display { display: block; margin: 1em 0px; text-align: center; }
.katex-display > .katex { display: block; text-align: center; white-space: nowrap; }
.katex-display > .katex > .katex-html { display: block; }
.katex-display > .katex > .katex-html > .tag { position: absolute; right: 0px; }
.katex { font: 1.21em / 1.2 KaTeX_Main, Times New Roman, serif; text-indent: 0px; text-rendering: auto; }
.katex * { }
.katex .katex-mathml { position: absolute; clip: rect(1px, 1px, 1px, 1px); padding: 0px; border: 0px none; height: 1px; width: 1px; overflow: hidden; }
.katex .katex-html { }
.katex .katex-html > .newline { display: block; }
.katex .base { position: relative; display: inline-block; white-space: nowrap; width: min-content; }
.katex .strut { display: inline-block; }
.katex .textbf { font-weight: bold; }
.katex .textit { font-style: italic; }
.katex .textrm { font-family: KaTeX_Main; }
.katex .textsf { font-family: KaTeX_SansSerif; }
.katex .texttt { font-family: KaTeX_Typewriter; }
.katex .mathit { font-family: KaTeX_Math; font-style: italic; }
.katex .mathrm { font-style: normal; }
.katex .mathbf { font-family: KaTeX_Main; font-weight: bold; }
.katex .boldsymbol { font-family: KaTeX_Math; font-weight: bold; font-style: italic; }
.katex .amsrm { font-family: KaTeX_AMS; }
.katex .mathbb, .katex .textbb { font-family: KaTeX_AMS; }
.katex .mathcal { font-family: KaTeX_Caligraphic; }
.katex .mathfrak, .katex .textfrak { font-family: KaTeX_Fraktur; }
.katex .mathtt { font-family: KaTeX_Typewriter; }
.katex .mathscr, .katex .textscr { font-family: KaTeX_Script; }
.katex .mathsf, .katex .textsf { font-family: KaTeX_SansSerif; }
.katex .mainit { font-family: KaTeX_Main; font-style: italic; }
.katex .mainrm { font-family: KaTeX_Main; font-style: normal; }
.katex .vlist-t { display: inline-table; table-layout: fixed; }
.katex .vlist-r { display: table-row; }
.katex .vlist { display: table-cell; vertical-align: bottom; position: relative; }
.katex .vlist > span { display: block; height: 0px; position: relative; }
.katex .vlist > span > span { display: inline-block; }
.katex .vlist > span > .pstrut { overflow: hidden; width: 0px; }
.katex .vlist-t2 { margin-right: -2px; }
.katex .vlist-s { display: table-cell; vertical-align: bottom; font-size: 1px; width: 2px; min-width: 2px; }
.katex .msupsub { text-align: left; }
.katex .mfrac > span > span { text-align: center; }
.katex .mfrac .frac-line { display: inline-block; width: 100%; border-bottom-style: solid; }
.katex .mspace { display: inline-block; }
.katex .llap, .katex .rlap, .katex .clap { width: 0px; position: relative; }
.katex .llap > .inner, .katex .rlap > .inner, .katex .clap > .inner { position: absolute; }
.katex .llap > .fix, .katex .rlap > .fix, .katex .clap > .fix { display: inline-block; }
.katex .llap > .inner { right: 0px; }
.katex .rlap > .inner, .katex .clap > .inner { left: 0px; }
.katex .clap > .inner > span { margin-left: -50%; margin-right: 50%; }
.katex .rule { display: inline-block; border: 0px solid; position: relative; }
.katex .overline .overline-line, .katex .underline .underline-line, .katex .hline { display: inline-block; width: 100%; border-bottom-style: solid; }
.katex .hdashline { display: inline-block; width: 100%; border-bottom-style: dashed; }
.katex .sqrt > .root { margin-left: 0.277778em; margin-right: -0.555556em; }
.katex .sizing, .katex .fontsize-ensurer { display: inline-block; }
.katex .sizing.reset-size1.size1, .katex .fontsize-ensurer.reset-size1.size1 { font-size: 1em; }
.katex .sizing.reset-size1.size2, .katex .fontsize-ensurer.reset-size1.size2 { font-size: 1.2em; }
.katex .sizing.reset-size1.size3, .katex .fontsize-ensurer.reset-size1.size3 { font-size: 1.4em; }
.katex .sizing.reset-size1.size4, .katex .fontsize-ensurer.reset-size1.size4 { font-size: 1.6em; }
.katex .sizing.reset-size1.size5, .katex .fontsize-ensurer.reset-size1.size5 { font-size: 1.8em; }
.katex .sizing.reset-size1.size6, .katex .fontsize-ensurer.reset-size1.size6 { font-size: 2em; }
.katex .sizing.reset-size1.size7, .katex .fontsize-ensurer.reset-size1.size7 { font-size: 2.4em; }
.katex .sizing.reset-size1.size8, .katex .fontsize-ensurer.reset-size1.size8 { font-size: 2.88em; }
.katex .sizing.reset-size1.size9, .katex .fontsize-ensurer.reset-size1.size9 { font-size: 3.456em; }
.katex .sizing.reset-size1.size10, .katex .fontsize-ensurer.reset-size1.size10 { font-size: 4.148em; }
.katex .sizing.reset-size1.size11, .katex .fontsize-ensurer.reset-size1.size11 { font-size: 4.976em; }
.katex .sizing.reset-size2.size1, .katex .fontsize-ensurer.reset-size2.size1 { font-size: 0.833333em; }
.katex .sizing.reset-size2.size2, .katex .fontsize-ensurer.reset-size2.size2 { font-size: 1em; }
.katex .sizing.reset-size2.size3, .katex .fontsize-ensurer.reset-size2.size3 { font-size: 1.16667em; }
.katex .sizing.reset-size2.size4, .katex .fontsize-ensurer.reset-size2.size4 { font-size: 1.33333em; }
.katex .sizing.reset-size2.size5, .katex .fontsize-ensurer.reset-size2.size5 { font-size: 1.5em; }
.katex .sizing.reset-size2.size6, .katex .fontsize-ensurer.reset-size2.size6 { font-size: 1.66667em; }
.katex .sizing.reset-size2.size7, .katex .fontsize-ensurer.reset-size2.size7 { font-size: 2em; }
.katex .sizing.reset-size2.size8, .katex .fontsize-ensurer.reset-size2.size8 { font-size: 2.4em; }
.katex .sizing.reset-size2.size9, .katex .fontsize-ensurer.reset-size2.size9 { font-size: 2.88em; }
.katex .sizing.reset-size2.size10, .katex .fontsize-ensurer.reset-size2.size10 { font-size: 3.45667em; }
.katex .sizing.reset-size2.size11, .katex .fontsize-ensurer.reset-size2.size11 { font-size: 4.14667em; }
.katex .sizing.reset-size3.size1, .katex .fontsize-ensurer.reset-size3.size1 { font-size: 0.714286em; }
.katex .sizing.reset-size3.size2, .katex .fontsize-ensurer.reset-size3.size2 { font-size: 0.857143em; }
.katex .sizing.reset-size3.size3, .katex .fontsize-ensurer.reset-size3.size3 { font-size: 1em; }
.katex .sizing.reset-size3.size4, .katex .fontsize-ensurer.reset-size3.size4 { font-size: 1.14286em; }
.katex .sizing.reset-size3.size5, .katex .fontsize-ensurer.reset-size3.size5 { font-size: 1.28571em; }
.katex .sizing.reset-size3.size6, .katex .fontsize-ensurer.reset-size3.size6 { font-size: 1.42857em; }
.katex .sizing.reset-size3.size7, .katex .fontsize-ensurer.reset-size3.size7 { font-size: 1.71429em; }
.katex .sizing.reset-size3.size8, .katex .fontsize-ensurer.reset-size3.size8 { font-size: 2.05714em; }
.katex .sizing.reset-size3.size9, .katex .fontsize-ensurer.reset-size3.size9 { font-size: 2.46857em; }
.katex .sizing.reset-size3.size10, .katex .fontsize-ensurer.reset-size3.size10 { font-size: 2.96286em; }
.katex .sizing.reset-size3.size11, .katex .fontsize-ensurer.reset-size3.size11 { font-size: 3.55429em; }
.katex .sizing.reset-size4.size1, .katex .fontsize-ensurer.reset-size4.size1 { font-size: 0.625em; }
.katex .sizing.reset-size4.size2, .katex .fontsize-ensurer.reset-size4.size2 { font-size: 0.75em; }
.katex .sizing.reset-size4.size3, .katex .fontsize-ensurer.reset-size4.size3 { font-size: 0.875em; }
.katex .sizing.reset-size4.size4, .katex .fontsize-ensurer.reset-size4.size4 { font-size: 1em; }
.katex .sizing.reset-size4.size5, .katex .fontsize-ensurer.reset-size4.size5 { font-size: 1.125em; }
.katex .sizing.reset-size4.size6, .katex .fontsize-ensurer.reset-size4.size6 { font-size: 1.25em; }
.katex .sizing.reset-size4.size7, .katex .fontsize-ensurer.reset-size4.size7 { font-size: 1.5em; }
.katex .sizing.reset-size4.size8, .katex .fontsize-ensurer.reset-size4.size8 { font-size: 1.8em; }
.katex .sizing.reset-size4.size9, .katex .fontsize-ensurer.reset-size4.size9 { font-size: 2.16em; }
.katex .sizing.reset-size4.size10, .katex .fontsize-ensurer.reset-size4.size10 { font-size: 2.5925em; }
.katex .sizing.reset-size4.size11, .katex .fontsize-ensurer.reset-size4.size11 { font-size: 3.11em; }
.katex .sizing.reset-size5.size1, .katex .fontsize-ensurer.reset-size5.size1 { font-size: 0.555556em; }
.katex .sizing.reset-size5.size2, .katex .fontsize-ensurer.reset-size5.size2 { font-size: 0.666667em; }
.katex .sizing.reset-size5.size3, .katex .fontsize-ensurer.reset-size5.size3 { font-size: 0.777778em; }
.katex .sizing.reset-size5.size4, .katex .fontsize-ensurer.reset-size5.size4 { font-size: 0.888889em; }
.katex .sizing.reset-size5.size5, .katex .fontsize-ensurer.reset-size5.size5 { font-size: 1em; }
.katex .sizing.reset-size5.size6, .katex .fontsize-ensurer.reset-size5.size6 { font-size: 1.11111em; }
.katex .sizing.reset-size5.size7, .katex .fontsize-ensurer.reset-size5.size7 { font-size: 1.33333em; }
.katex .sizing.reset-size5.size8, .katex .fontsize-ensurer.reset-size5.size8 { font-size: 1.6em; }
.katex .sizing.reset-size5.size9, .katex .fontsize-ensurer.reset-size5.size9 { font-size: 1.92em; }
.katex .sizing.reset-size5.size10, .katex .fontsize-ensurer.reset-size5.size10 { font-size: 2.30444em; }
.katex .sizing.reset-size5.size11, .katex .fontsize-ensurer.reset-size5.size11 { font-size: 2.76444em; }
.katex .sizing.reset-size6.size1, .katex .fontsize-ensurer.reset-size6.size1 { font-size: 0.5em; }
.katex .sizing.reset-size6.size2, .katex .fontsize-ensurer.reset-size6.size2 { font-size: 0.6em; }
.katex .sizing.reset-size6.size3, .katex .fontsize-ensurer.reset-size6.size3 { font-size: 0.7em; }
.katex .sizing.reset-size6.size4, .katex .fontsize-ensurer.reset-size6.size4 { font-size: 0.8em; }
.katex .sizing.reset-size6.size5, .katex .fontsize-ensurer.reset-size6.size5 { font-size: 0.9em; }
.katex .sizing.reset-size6.size6, .katex .fontsize-ensurer.reset-size6.size6 { font-size: 1em; }
.katex .sizing.reset-size6.size7, .katex .fontsize-ensurer.reset-size6.size7 { font-size: 1.2em; }
.katex .sizing.reset-size6.size8, .katex .fontsize-ensurer.reset-size6.size8 { font-size: 1.44em; }
.katex .sizing.reset-size6.size9, .katex .fontsize-ensurer.reset-size6.size9 { font-size: 1.728em; }
.katex .sizing.reset-size6.size10, .katex .fontsize-ensurer.reset-size6.size10 { font-size: 2.074em; }
.katex .sizing.reset-size6.size11, .katex .fontsize-ensurer.reset-size6.size11 { font-size: 2.488em; }
.katex .sizing.reset-size7.size1, .katex .fontsize-ensurer.reset-size7.size1 { font-size: 0.416667em; }
.katex .sizing.reset-size7.size2, .katex .fontsize-ensurer.reset-size7.size2 { font-size: 0.5em; }
.katex .sizing.reset-size7.size3, .katex .fontsize-ensurer.reset-size7.size3 { font-size: 0.583333em; }
.katex .sizing.reset-size7.size4, .katex .fontsize-ensurer.reset-size7.size4 { font-size: 0.666667em; }
.katex .sizing.reset-size7.size5, .katex .fontsize-ensurer.reset-size7.size5 { font-size: 0.75em; }
.katex .sizing.reset-size7.size6, .katex .fontsize-ensurer.reset-size7.size6 { font-size: 0.833333em; }
.katex .sizing.reset-size7.size7, .katex .fontsize-ensurer.reset-size7.size7 { font-size: 1em; }
.katex .sizing.reset-size7.size8, .katex .fontsize-ensurer.reset-size7.size8 { font-size: 1.2em; }
.katex .sizing.reset-size7.size9, .katex .fontsize-ensurer.reset-size7.size9 { font-size: 1.44em; }
.katex .sizing.reset-size7.size10, .katex .fontsize-ensurer.reset-size7.size10 { font-size: 1.72833em; }
.katex .sizing.reset-size7.size11, .katex .fontsize-ensurer.reset-size7.size11 { font-size: 2.07333em; }
.katex .sizing.reset-size8.size1, .katex .fontsize-ensurer.reset-size8.size1 { font-size: 0.347222em; }
.katex .sizing.reset-size8.size2, .katex .fontsize-ensurer.reset-size8.size2 { font-size: 0.416667em; }
.katex .sizing.reset-size8.size3, .katex .fontsize-ensurer.reset-size8.size3 { font-size: 0.486111em; }
.katex .sizing.reset-size8.size4, .katex .fontsize-ensurer.reset-size8.size4 { font-size: 0.555556em; }
.katex .sizing.reset-size8.size5, .katex .fontsize-ensurer.reset-size8.size5 { font-size: 0.625em; }
.katex .sizing.reset-size8.size6, .katex .fontsize-ensurer.reset-size8.size6 { font-size: 0.694444em; }
.katex .sizing.reset-size8.size7, .katex .fontsize-ensurer.reset-size8.size7 { font-size: 0.833333em; }
.katex .sizing.reset-size8.size8, .katex .fontsize-ensurer.reset-size8.size8 { font-size: 1em; }
.katex .sizing.reset-size8.size9, .katex .fontsize-ensurer.reset-size8.size9 { font-size: 1.2em; }
.katex .sizing.reset-size8.size10, .katex .fontsize-ensurer.reset-size8.size10 { font-size: 1.44028em; }
.katex .sizing.reset-size8.size11, .katex .fontsize-ensurer.reset-size8.size11 { font-size: 1.72778em; }
.katex .sizing.reset-size9.size1, .katex .fontsize-ensurer.reset-size9.size1 { font-size: 0.289352em; }
.katex .sizing.reset-size9.size2, .katex .fontsize-ensurer.reset-size9.size2 { font-size: 0.347222em; }
.katex .sizing.reset-size9.size3, .katex .fontsize-ensurer.reset-size9.size3 { font-size: 0.405093em; }
.katex .sizing.reset-size9.size4, .katex .fontsize-ensurer.reset-size9.size4 { font-size: 0.462963em; }
.katex .sizing.reset-size9.size5, .katex .fontsize-ensurer.reset-size9.size5 { font-size: 0.520833em; }
.katex .sizing.reset-size9.size6, .katex .fontsize-ensurer.reset-size9.size6 { font-size: 0.578704em; }
.katex .sizing.reset-size9.size7, .katex .fontsize-ensurer.reset-size9.size7 { font-size: 0.694444em; }
.katex .sizing.reset-size9.size8, .katex .fontsize-ensurer.reset-size9.size8 { font-size: 0.833333em; }
.katex .sizing.reset-size9.size9, .katex .fontsize-ensurer.reset-size9.size9 { font-size: 1em; }
.katex .sizing.reset-size9.size10, .katex .fontsize-ensurer.reset-size9.size10 { font-size: 1.20023em; }
.katex .sizing.reset-size9.size11, .katex .fontsize-ensurer.reset-size9.size11 { font-size: 1.43981em; }
.katex .sizing.reset-size10.size1, .katex .fontsize-ensurer.reset-size10.size1 { font-size: 0.24108em; }
.katex .sizing.reset-size10.size2, .katex .fontsize-ensurer.reset-size10.size2 { font-size: 0.289296em; }
.katex .sizing.reset-size10.size3, .katex .fontsize-ensurer.reset-size10.size3 { font-size: 0.337512em; }
.katex .sizing.reset-size10.size4, .katex .fontsize-ensurer.reset-size10.size4 { font-size: 0.385728em; }
.katex .sizing.reset-size10.size5, .katex .fontsize-ensurer.reset-size10.size5 { font-size: 0.433944em; }
.katex .sizing.reset-size10.size6, .katex .fontsize-ensurer.reset-size10.size6 { font-size: 0.48216em; }
.katex .sizing.reset-size10.size7, .katex .fontsize-ensurer.reset-size10.size7 { font-size: 0.578592em; }
.katex .sizing.reset-size10.size8, .katex .fontsize-ensurer.reset-size10.size8 { font-size: 0.694311em; }
.katex .sizing.reset-size10.size9, .katex .fontsize-ensurer.reset-size10.size9 { font-size: 0.833173em; }
.katex .sizing.reset-size10.size10, .katex .fontsize-ensurer.reset-size10.size10 { font-size: 1em; }
.katex .sizing.reset-size10.size11, .katex .fontsize-ensurer.reset-size10.size11 { font-size: 1.19961em; }
.katex .sizing.reset-size11.size1, .katex .fontsize-ensurer.reset-size11.size1 { font-size: 0.200965em; }
.katex .sizing.reset-size11.size2, .katex .fontsize-ensurer.reset-size11.size2 { font-size: 0.241158em; }
.katex .sizing.reset-size11.size3, .katex .fontsize-ensurer.reset-size11.size3 { font-size: 0.281351em; }
.katex .sizing.reset-size11.size4, .katex .fontsize-ensurer.reset-size11.size4 { font-size: 0.321543em; }
.katex .sizing.reset-size11.size5, .katex .fontsize-ensurer.reset-size11.size5 { font-size: 0.361736em; }
.katex .sizing.reset-size11.size6, .katex .fontsize-ensurer.reset-size11.size6 { font-size: 0.401929em; }
.katex .sizing.reset-size11.size7, .katex .fontsize-ensurer.reset-size11.size7 { font-size: 0.482315em; }
.katex .sizing.reset-size11.size8, .katex .fontsize-ensurer.reset-size11.size8 { font-size: 0.578778em; }
.katex .sizing.reset-size11.size9, .katex .fontsize-ensurer.reset-size11.size9 { font-size: 0.694534em; }
.katex .sizing.reset-size11.size10, .katex .fontsize-ensurer.reset-size11.size10 { font-size: 0.833601em; }
.katex .sizing.reset-size11.size11, .katex .fontsize-ensurer.reset-size11.size11 { font-size: 1em; }
.katex .delimsizing.size1 { font-family: KaTeX_Size1; }
.katex .delimsizing.size2 { font-family: KaTeX_Size2; }
.katex .delimsizing.size3 { font-family: KaTeX_Size3; }
.katex .delimsizing.size4 { font-family: KaTeX_Size4; }
.katex .delimsizing.mult .delim-size1 > span { font-family: KaTeX_Size1; }
.katex .delimsizing.mult .delim-size4 > span { font-family: KaTeX_Size4; }
.katex .nulldelimiter { display: inline-block; width: 0.12em; }
.katex .delimcenter { position: relative; }
.katex .op-symbol { position: relative; }
.katex .op-symbol.small-op { font-family: KaTeX_Size1; }
.katex .op-symbol.large-op { font-family: KaTeX_Size2; }
.katex .op-limits > .vlist-t { text-align: center; }
.katex .accent > .vlist-t { text-align: center; }
.katex .accent .accent-body:not(.accent-full) { width: 0px; }
.katex .accent .accent-body { position: relative; }
.katex .overlay { display: block; }
.katex .mtable .vertical-separator { display: inline-block; margin: 0px -0.025em; border-right: 0.05em solid; }
.katex .mtable .vs-dashed { border-right: 0.05em dashed; }
.katex .mtable .arraycolsep { display: inline-block; }
.katex .mtable .col-align-c > .vlist-t { text-align: center; }
.katex .mtable .col-align-l > .vlist-t { text-align: left; }
.katex .mtable .col-align-r > .vlist-t { text-align: right; }
.katex .svg-align { text-align: left; }
.katex svg, .screenShotTempCanvas { display: block; position: absolute; width: 100%; height: inherit; fill: currentcolor; stroke: currentcolor; fill-rule: nonzero; fill-opacity: 1; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 4; stroke-dasharray: none; stroke-dashoffset: 0px; stroke-opacity: 1; }
.katex svg path { stroke: none; }
.katex .stretchy { width: 100%; display: block; position: relative; overflow: hidden; }
.katex .stretchy::before, .katex .stretchy::after { content: ""; }
.katex .hide-tail { width: 100%; position: relative; overflow: hidden; }
.katex .halfarrow-left { position: absolute; left: 0px; width: 50.2%; overflow: hidden; }
.katex .halfarrow-right { position: absolute; right: 0px; width: 50.2%; overflow: hidden; }
.katex .brace-left { position: absolute; left: 0px; width: 25.1%; overflow: hidden; }
.katex .brace-center { position: absolute; left: 25%; width: 50%; overflow: hidden; }
.katex .brace-right { position: absolute; right: 0px; width: 25.1%; overflow: hidden; }
.katex .x-arrow-pad { padding: 0px 0.5em; }
.katex .x-arrow, .katex .mover, .katex .munder { text-align: center; }
.katex .boxpad { padding: 0px 0.3em; }
.katex .fbox { box-sizing: border-box; border: 0.04em solid black; }
.katex .fcolorbox { box-sizing: border-box; border: 0.04em solid; }
.katex .cancel-pad { padding: 0px 0.2em; }
.katex .cancel-lap { margin-left: -0.2em; margin-right: -0.2em; }
.katex .sout { border-bottom-style: solid; border-bottom-width: 0.08em; }
.output_wrapper pre code { display: -webkit-box !important; } 
.output_wrapper .hljs{color: rgb(169, 183, 198); background: rgb(40, 43, 46) none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;}

.output_wrapper .hljs-params{color: rgb(255, 152, 35);}

.output_wrapper .hljs-number,.output_wrapper  .hljs-literal,.output_wrapper  .hljs-symbol,.output_wrapper  .hljs-bullet{color: rgb(174, 135, 250);}

.output_wrapper .hljs-function,.output_wrapper  .hljs-built_in,.output_wrapper  .hljs-name,.output_wrapper  .hljs-keyword,.output_wrapper  .hljs-selector-tag,.output_wrapper  .hljs-deletion{color: rgb(248, 35, 117);}

.output_wrapper .hljs-variable,.output_wrapper  .hljs-template-variable,.output_wrapper  .hljs-link{color: rgb(98, 151, 85);}

.output_wrapper .hljs-comment,.output_wrapper  .hljs-quote{color: rgb(128, 128, 128);}

.output_wrapper .hljs-meta{color: rgb(91, 218, 237);}

.output_wrapper .hljs-string,.output_wrapper  .hljs-attribute,.output_wrapper  .hljs-addition{color: rgb(238, 220, 112);}

.output_wrapper .hljs-attr,.output_wrapper  .hljs-section,.output_wrapper  .hljs-title,.output_wrapper  .hljs-type{color: rgb(165, 218, 45);}

.output_wrapper .hljs-selector-class{color: rgb(165, 218, 45);}

.output_wrapper .hljs-emphasis{font-style: italic;}

.output_wrapper .hljs-strong{font-weight: bold;}
 
.output_wrapper pre code {line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px;} 
.output_wrapper{font-size: 16px; color: rgb(62, 62, 62); line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;}

.output_wrapper *{font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;}

.output_wrapper p{margin: 1.5em 0px;}

.output_wrapper h1,.output_wrapper  h2,.output_wrapper  h3,.output_wrapper  h4,.output_wrapper  h5,.output_wrapper  h6{margin: 1.5em 0px; font-weight: bold;}

.output_wrapper h1{font-size: 1.6em;}

.output_wrapper h2{font-size: 1.4em;}

.output_wrapper h3{font-size: 1.3em;}

.output_wrapper h4{font-size: 1.2em;}

.output_wrapper h5{font-size: 1em;}

.output_wrapper h6{font-size: 1em;}

.output_wrapper h3{margin-bottom: 2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius: 5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;}

.output_wrapper ul,.output_wrapper  ol{padding-left: 32px;}

.output_wrapper ul{list-style-type: disc;}

.output_wrapper ol{list-style-type: decimal;}

.output_wrapper li *{}

.output_wrapper li{margin-bottom: 0.5em;}

.output_wrapper .code_size_default{line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px;}

.output_wrapper .code_size_tight{line-height: 15px; font-size: 11px; font-weight: normal; word-spacing: -3px; letter-spacing: 0px;}

.output_wrapper pre code{font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px;}

.output_wrapper blockquote{display: block; padding: 15px 15px 15px 1rem; font-size: 0.9em; margin: 1em 0px; color: rgb(129, 145, 152); border-left: 6px solid rgb(220, 230, 240); background: rgb(242, 247, 251) none repeat scroll 0% 0%; overflow: auto; overflow-wrap: normal; word-break: normal;}

.output_wrapper blockquote p{margin: 0px;}

.output_wrapper a{text-decoration: none; color: rgb(30, 107, 184); overflow-wrap: break-word;}

.output_wrapper strong{font-weight: bold;}

.output_wrapper em{font-style: italic;}

.output_wrapper del{font-style: italic;}

.output_wrapper strong em{font-weight: bold;}

.output_wrapper hr{height: 1px; margin: 1.5rem 0px; border-color: rgb(165, 165, 165) currentcolor currentcolor; border-style: dashed none none; border-width: 1px medium medium; border-image: none 100% / 1 / 0 stretch;}

.output_wrapper code{overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(233, 105, 0); background: rgb(248, 248, 248) none repeat scroll 0% 0%;}

.output_wrapper img{display: block; margin: 0px auto; max-width: 100%;}

.output_wrapper figcaption{margin-top: 10px; text-align: center; color: rgb(153, 153, 153); font-size: 0.7em;}

.output_wrapper table{display: table; width: 100%; text-align: left;}

.output_wrapper tbody{border: 0px none;}

.output_wrapper table tr{border-color: rgb(204, 204, 204) currentcolor currentcolor; border-style: solid none none; border-width: 1px 0px 0px; border-image: none 100% / 1 / 0 stretch; background-color: white;}

.output_wrapper table tr th,.output_wrapper  table tr td{font-size: 1em; border: 1px solid rgb(204, 204, 204); padding: 0.5em 1em; text-align: left;}

.output_wrapper table tr th{font-weight: bold; background-color: rgb(240, 240, 240);}

.output_wrapper .katex-display{font-size: 1.22em;}

.output_wrapper .katex{padding: 8px 3px;}

.output_wrapper .katex-display > .katex{display: inline-block; text-align: center; padding: 3px;}

.output_wrapper .katex img{display: inline-block; vertical-align: middle;}

.output_wrapper a[href^="#"] sup{vertical-align: super; margin: 0px 2px; padding: 1px 3px; color: rgb(255, 255, 255); background: rgb(102, 102, 102) none repeat scroll 0% 0%; font-size: 0.7em;}

.output_wrapper .task-list-list{list-style-type: none;}

.output_wrapper .task-list-list.checked{color: rgb(62, 62, 62);}

.output_wrapper .task-list-list.uncheck{color: rgb(191, 193, 191);}

.output_wrapper .task-list-list .icon_uncheck,.output_wrapper  .task-list-list .icon_check{display: inline-block; vertical-align: middle; margin-right: 10px;}

.output_wrapper .task-list-list .icon_check::before{content: "√"; border: 2px solid rgb(62, 62, 62); color: red;}

.output_wrapper .task-list-list .icon_uncheck::before{content: "x"; border: 2px solid rgb(191, 193, 191); color: rgb(191, 193, 191);}

.output_wrapper .task-list-list .icon_check::before,.output_wrapper  .task-list-list .icon_uncheck::before{padding: 2px 8px 2px 5px; border-radius: 5px;}

.output_wrapper .toc{margin-left: 25px;}

.output_wrapper .toc_item{display: block;}

.output_wrapper .toc_left{margin-left: 25px;}
 
</style>  
  <style type="text/css" id="export_setting_css">body { width: 100%; margin: 0px; padding: 0px; background: rgb(81, 154, 178) none repeat scroll 0% 0%; }
#export_content { margin: 40px 20%; padding: 20px; border: 1px solid rgb(149, 155, 111); background: rgb(255, 255, 255) none repeat scroll 0% 0%; }</style>  

</head><body><div id="export_content"><div class="output_wrapper" id="output_wrapper_id"><h1 id="hpaligncenterfontsize69glibcmallocfontp"><span><p align="center"><strong><font size="6">计算机系统篇之虚拟内存（9）：理解 glibc malloc 的工作原理（中）</font></strong></p></span></h1>
<p align="right">Author: stormQ</p>
<p align="right">Created: Wednesday, 25. November 2020 10:52PM</p>
<p align="right">Last Modified: Sunday, 13. December 2020 04:38PM</p>
<hr>
<ul>
<li><h3 id="h"><span>目录</span></h3>
<ul>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump0">再探 malloc 中已分配块和空闲块的内部布局</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump1">如何在链接期拦截标准库的 malloc</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump1_2">chunk 的大小有哪些讲究</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump2">理解 malloc_state 结构体中各字段的意义</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump3">理解 tcache 机制</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump4">第一个 chunk 的来龙去脉</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump5">为什么在调用 free 函数后，被释放的 chunk 从内存数据来看仍是一个已分配块？</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jumpReferences">References</a></p></ul><p></p>
</li></ul>
<hr>
<h3 id="hspanidjump0mallocspan"><span><span id="jump0">再探 malloc 中已分配块和空闲块的内部布局</span></span></h3>
<p>本文我们结合 glibc-2.31 版本中的<code>malloc</code>的实现源码来分析上一篇中可执行目标文件<code>vm4_main</code>动态申请和释放堆内存的过程。</p>
<p><strong>step 0：</strong> 启动 vm4_main 并挂载 glibc-2.31 版本的源码</p>
<pre><code class="hljs sql">$&nbsp;gdb&nbsp;-q&nbsp;vm4_main<br>Reading&nbsp;symbols&nbsp;from&nbsp;vm4_main...<br>(gdb)&nbsp;<span class="hljs-keyword">start</span><br><span class="hljs-keyword">Temporary</span>&nbsp;breakpoint&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-keyword">at</span>&nbsp;<span class="hljs-number">0x11a9</span>:&nbsp;<span class="hljs-keyword">file</span>&nbsp;vm4_main.cpp,&nbsp;line&nbsp;<span class="hljs-number">37.</span><br><span class="hljs-keyword">Starting</span>&nbsp;program:&nbsp;/home/<span class="hljs-keyword">test</span>/vm/vm4_main&nbsp;<br><br><span class="hljs-keyword">Temporary</span>&nbsp;breakpoint&nbsp;<span class="hljs-number">1</span>,&nbsp;<span class="hljs-keyword">main</span>&nbsp;(argc=<span class="hljs-number">0</span>,&nbsp;argv=<span class="hljs-number">0x0</span>)&nbsp;<span class="hljs-keyword">at</span>&nbsp;vm4_main.cpp:<span class="hljs-number">37</span><br><span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br>(gdb)&nbsp;<span class="hljs-keyword">directory</span>&nbsp;/home/workspace/git-projects/glibc<span class="hljs-number">-2.31</span>/malloc<br><span class="hljs-keyword">Source</span>&nbsp;directories&nbsp;searched:&nbsp;/home/workspace/git-projects/glibc<span class="hljs-number">-2.31</span>/malloc:$cdir:$cwd<br></code></pre>
<p>注：<code>/home/workspace/git-projects/glibc-2.31/malloc</code>为<code>malloc.c</code>所在的目录。</p>
<p><strong>step 1：</strong> 研究 obj1 对象申请堆内存的过程</p>
<p><strong>需要注意的是</strong>，虽然<code>obj1</code>对象作为用户第一次发起的堆内存申请，但在真正为其分配<code>chunk</code>之前会创建另外一个<code>chunk</code>，作为事实上的第一个（位于堆底）<code>chunk</code>，具体分析过程见本文中的 <a href="#jump4">第一个 chunk 的来龙去脉</a>。</p>
<p><strong>1）</strong> 进入<code>malloc</code>函数</p>
<pre><code class="hljs shell">(gdb)&nbsp;b&nbsp;malloc<br>Breakpoint&nbsp;2&nbsp;at&nbsp;0x7ffff7e61260:&nbsp;malloc.&nbsp;(2&nbsp;locations)<br>(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;2,&nbsp;__GI___libc_malloc&nbsp;(bytes=8)&nbsp;at&nbsp;malloc.c:3023<br>3023&nbsp;&nbsp;&nbsp;&nbsp;{<br>(gdb)&nbsp;bt<br><span class="hljs-meta">#</span><span class="bash">0&nbsp;&nbsp;__GI___libc_malloc&nbsp;(bytes=8)&nbsp;at&nbsp;malloc.c:3023</span><br><span class="hljs-meta">#</span><span class="bash">1&nbsp;&nbsp;0x00005555555552f3&nbsp;<span class="hljs-keyword">in</span>&nbsp;HeapObject::HeapObject&nbsp;(this=0x7fffffffdc40,&nbsp;size=8)&nbsp;at&nbsp;vm4_main.cpp:11</span><br><span class="hljs-meta">#</span><span class="bash">2&nbsp;&nbsp;0x00005555555551dd&nbsp;<span class="hljs-keyword">in</span>&nbsp;main&nbsp;(argc=1,&nbsp;argv=0x7fffffffdda8)&nbsp;at&nbsp;vm4_main.cpp:38</span><br></code></pre>
<p>从上面的输出结果中可以看出，我们正在跟踪的是<code>obj1</code>对象申请堆内存的过程，并且<code>malloc</code>的底层实现函数的名称为<code>__GI___libc_malloc</code>。</p>
<p><strong>2）</strong> 分析<code>obj1</code>对象申请堆内存时，实际调用了<code>malloc</code>函数的哪些代码</p>
<p>a）查看<code>malloc</code>函数完整的实现源码</p>
<pre><code class="hljs cpp">(gdb)&nbsp;l&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3021</span>,&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3082</span><br><span class="hljs-number">3021</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*<br><span class="hljs-number">3022</span>&nbsp;&nbsp;&nbsp;&nbsp;__libc_malloc&nbsp;(<span class="hljs-keyword">size_t</span>&nbsp;bytes)<br><span class="hljs-number">3023</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3024</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mstate&nbsp;ar_ptr;<br><span class="hljs-number">3025</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*victim;<br><span class="hljs-number">3026</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3027</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_Static_assert&nbsp;(PTRDIFF_MAX&nbsp;&lt;=&nbsp;SIZE_MAX&nbsp;/&nbsp;<span class="hljs-number">2</span>,<br><span class="hljs-number">3028</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"PTRDIFF_MAX&nbsp;is&nbsp;not&nbsp;more&nbsp;than&nbsp;half&nbsp;of&nbsp;SIZE_MAX"</span>);<br><span class="hljs-number">3029</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*(*hook)&nbsp;(<span class="hljs-keyword">size_t</span>,&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;*)<br><span class="hljs-number">3031</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;atomic_forced_read&nbsp;(__malloc_hook);<br><span class="hljs-number">3032</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(__builtin_expect&nbsp;(hook&nbsp;!=&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-number">0</span>))<br><span class="hljs-number">3033</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*hook)(bytes,&nbsp;RETURN_ADDRESS&nbsp;(<span class="hljs-number">0</span>));<br><span class="hljs-number">3034</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span>&nbsp;USE_TCACHE</span><br><span class="hljs-number">3035</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;int_free&nbsp;also&nbsp;calls&nbsp;request2size,&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;pad&nbsp;twice.&nbsp;&nbsp;*/</span><br><span class="hljs-number">3036</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">size_t</span>&nbsp;tbytes;<br><span class="hljs-number">3037</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!checked_request2size&nbsp;(bytes,&nbsp;&amp;tbytes))<br><span class="hljs-number">3038</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3039</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__set_errno&nbsp;(ENOMEM);<br><span class="hljs-number">3040</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="hljs-number">3041</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">3042</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">size_t</span>&nbsp;tc_idx&nbsp;=&nbsp;csize2tidx&nbsp;(tbytes);<br><span class="hljs-number">3043</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3044</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAYBE_INIT_TCACHE&nbsp;();<br><span class="hljs-number">3045</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3046</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DIAG_PUSH_NEEDS_COMMENT;<br><span class="hljs-number">3047</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(tc_idx&nbsp;&lt;&nbsp;mp_.tcache_bins<br><span class="hljs-number">3048</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;tcache<br><span class="hljs-number">3049</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;tcache-&gt;counts[tc_idx]&nbsp;&gt;&nbsp;<span class="hljs-number">0</span>)<br><span class="hljs-number">3050</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3051</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;tcache_get&nbsp;(tc_idx);<br><span class="hljs-number">3052</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">3053</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DIAG_POP_NEEDS_COMMENT;<br><span class="hljs-number">3054</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><span class="hljs-number">3055</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3056</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(SINGLE_THREAD_P)<br><span class="hljs-number">3057</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3058</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim&nbsp;=&nbsp;_int_malloc&nbsp;(&amp;main_arena,&nbsp;bytes);<br><span class="hljs-number">3059</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;(!victim&nbsp;||&nbsp;chunk_is_mmapped&nbsp;(mem2chunk&nbsp;(victim))&nbsp;||<br><span class="hljs-number">3060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;main_arena&nbsp;==&nbsp;arena_for_chunk&nbsp;(mem2chunk&nbsp;(victim)));<br><span class="hljs-number">3061</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;victim;<br><span class="hljs-number">3062</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">3063</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3064</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arena_get&nbsp;(ar_ptr,&nbsp;bytes);<br><span class="hljs-number">3065</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3066</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim&nbsp;=&nbsp;_int_malloc&nbsp;(ar_ptr,&nbsp;bytes);<br><span class="hljs-number">3067</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Retry&nbsp;with&nbsp;another&nbsp;arena&nbsp;only&nbsp;if&nbsp;we&nbsp;were&nbsp;able&nbsp;to&nbsp;find&nbsp;a&nbsp;usable&nbsp;arena<br>3068&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;before.&nbsp;&nbsp;*/</span><br><span class="hljs-number">3069</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!victim&nbsp;&amp;&amp;&nbsp;ar_ptr&nbsp;!=&nbsp;<span class="hljs-literal">NULL</span>)<br><span class="hljs-number">3070</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3071</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIBC_PROBE&nbsp;(memory_malloc_retry,&nbsp;<span class="hljs-number">1</span>,&nbsp;bytes);<br><span class="hljs-number">3072</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ar_ptr&nbsp;=&nbsp;arena_get_retry&nbsp;(ar_ptr,&nbsp;bytes);<br><span class="hljs-number">3073</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim&nbsp;=&nbsp;_int_malloc&nbsp;(ar_ptr,&nbsp;bytes);<br><span class="hljs-number">3074</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">3075</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3076</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(ar_ptr&nbsp;!=&nbsp;<span class="hljs-literal">NULL</span>)<br><span class="hljs-number">3077</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__libc_lock_unlock&nbsp;(ar_ptr-&gt;mutex);<br><span class="hljs-number">3078</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3079</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;(!victim&nbsp;||&nbsp;chunk_is_mmapped&nbsp;(mem2chunk&nbsp;(victim))&nbsp;||<br><span class="hljs-number">3080</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ar_ptr&nbsp;==&nbsp;arena_for_chunk&nbsp;(mem2chunk&nbsp;(victim)));<br><span class="hljs-number">3081</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;victim;<br><span class="hljs-number">3082</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p>b）设置一些断点，并观察这些断点的执行情况</p>
<pre><code class="hljs css">(<span class="hljs-selector-tag">gdb</span>)&nbsp;<span class="hljs-selector-tag">b</span>&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3033</span><br><span class="hljs-selector-tag">Breakpoint</span>&nbsp;3&nbsp;<span class="hljs-selector-tag">at</span>&nbsp;0<span class="hljs-selector-tag">x7ffff7e60dfb</span>:&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3033.</span>&nbsp;(2&nbsp;<span class="hljs-selector-tag">locations</span>)<br>(<span class="hljs-selector-tag">gdb</span>)&nbsp;<span class="hljs-selector-tag">b</span>&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3037</span><br><span class="hljs-selector-tag">Breakpoint</span>&nbsp;4&nbsp;<span class="hljs-selector-tag">at</span>&nbsp;0<span class="hljs-selector-tag">x7ffff7e60cc8</span>:&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3037.</span>&nbsp;(2&nbsp;<span class="hljs-selector-tag">locations</span>)<br>(<span class="hljs-selector-tag">gdb</span>)&nbsp;<span class="hljs-selector-tag">b</span>&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3051</span><br><span class="hljs-selector-tag">Breakpoint</span>&nbsp;5&nbsp;<span class="hljs-selector-tag">at</span>&nbsp;0<span class="hljs-selector-tag">x7ffff7e60dc0</span>:&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3051.</span>&nbsp;(2&nbsp;<span class="hljs-selector-tag">locations</span>)<br>(<span class="hljs-selector-tag">gdb</span>)&nbsp;<span class="hljs-selector-tag">b</span>&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3056</span><br><span class="hljs-selector-tag">Breakpoint</span>&nbsp;6&nbsp;<span class="hljs-selector-tag">at</span>&nbsp;0<span class="hljs-selector-tag">x7ffff7e60d03</span>:&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3056.</span>&nbsp;(3&nbsp;<span class="hljs-selector-tag">locations</span>)<br>(<span class="hljs-selector-tag">gdb</span>)&nbsp;<span class="hljs-selector-tag">b</span>&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3058</span><br><span class="hljs-selector-tag">Breakpoint</span>&nbsp;7&nbsp;<span class="hljs-selector-tag">at</span>&nbsp;0<span class="hljs-selector-tag">x7ffff7e60d13</span>:&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3058.</span>&nbsp;(2&nbsp;<span class="hljs-selector-tag">locations</span>)<br>(<span class="hljs-selector-tag">gdb</span>)&nbsp;<span class="hljs-selector-tag">b</span>&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3066</span><br><span class="hljs-selector-tag">Breakpoint</span>&nbsp;8&nbsp;<span class="hljs-selector-tag">at</span>&nbsp;0<span class="hljs-selector-tag">x7ffff7e60e6e</span>:&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3066.</span>&nbsp;(2&nbsp;<span class="hljs-selector-tag">locations</span>)<br>(<span class="hljs-selector-tag">gdb</span>)&nbsp;<span class="hljs-selector-tag">b</span>&nbsp;<span class="hljs-selector-tag">vm4_main</span><span class="hljs-selector-class">.cpp</span><span class="hljs-selector-pseudo">:39</span><br><span class="hljs-selector-tag">Breakpoint</span>&nbsp;9&nbsp;<span class="hljs-selector-tag">at</span>&nbsp;0<span class="hljs-selector-tag">x5555555551dd</span>:&nbsp;<span class="hljs-selector-tag">file</span>&nbsp;<span class="hljs-selector-tag">vm4_main</span><span class="hljs-selector-class">.cpp</span>,&nbsp;<span class="hljs-selector-tag">line</span>&nbsp;39.<br></code></pre>
<p>需要注意的是，我们在<code>vm4_main.cpp:39</code>处也设置了断点，以便于区分接下来的<code>malloc</code>的调用过程确实是由<code>obj1</code>对象申请堆内存引起的。</p>
<p>c）继续执行，直到<code>vm4_main.cpp:39</code>处停止</p>
<pre><code class="hljs cpp">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">3</span>,&nbsp;__GI___libc_malloc&nbsp;(bytes=<span class="hljs-number">8</span>)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3033</span><br><span class="hljs-number">3033</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*hook)(bytes,&nbsp;RETURN_ADDRESS&nbsp;(<span class="hljs-number">0</span>));<br>(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">4</span>,&nbsp;checked_request2size&nbsp;(sz=&lt;synthetic&nbsp;pointer&gt;,&nbsp;req=<span class="hljs-number">8</span>)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3037</span><br><span class="hljs-number">3037</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!checked_request2size&nbsp;(bytes,&nbsp;&amp;tbytes))<br>(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">6</span>,&nbsp;__GI___libc_malloc&nbsp;(bytes=<span class="hljs-number">8</span>)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3056</span><br><span class="hljs-number">3056</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(SINGLE_THREAD_P)<br>(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">6</span>,&nbsp;__GI___libc_malloc&nbsp;(bytes=<span class="hljs-number">8</span>)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3056</span><br><span class="hljs-number">3056</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(SINGLE_THREAD_P)<br>(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">7</span>,&nbsp;__GI___libc_malloc&nbsp;(bytes=<span class="hljs-number">8</span>)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3058</span><br><span class="hljs-number">3058</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim&nbsp;=&nbsp;_int_malloc&nbsp;(&amp;main_arena,&nbsp;bytes);<br>(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">9</span>,&nbsp;main&nbsp;(argc=<span class="hljs-number">1</span>,&nbsp;argv=<span class="hljs-number">0x7fffffffdda8</span>)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">39</span><br><span class="hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function">HeapObject&nbsp;<span class="hljs-title">obj2</span><span class="hljs-params">(<span class="hljs-number">4</span>)</span></span>;<br></code></pre>
<p>从上面的输出结果中可以看出，在<code>obj1</code>对象申请一块堆内存的过程中，<code>malloc</code>函数中的以下代码部分依次被调用了，分别为：</p>
<pre><code class="hljs css"><span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3033</span>&nbsp;<span class="hljs-selector-tag">-</span>&gt;&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3037</span>&nbsp;<span class="hljs-selector-tag">-</span>&gt;&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3056</span>&nbsp;<span class="hljs-selector-tag">-</span>&gt;&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3056</span>&nbsp;<span class="hljs-selector-tag">-</span>&gt;&nbsp;<span class="hljs-selector-tag">malloc</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-pseudo">:3058</span><br></code></pre>
<p>因此，可以得出结论：<code>obj1</code>对象申请堆内存时，实际调用的<code>malloc</code>函数的代码部分如下：</p>
<pre><code class="hljs cpp"><span class="hljs-number">3021</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*<br><span class="hljs-number">3022</span>&nbsp;&nbsp;&nbsp;&nbsp;__libc_malloc&nbsp;(<span class="hljs-keyword">size_t</span>&nbsp;bytes)<br><span class="hljs-number">3023</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3025</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*victim;<br><span class="hljs-number">3026</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3027</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_Static_assert&nbsp;(PTRDIFF_MAX&nbsp;&lt;=&nbsp;SIZE_MAX&nbsp;/&nbsp;<span class="hljs-number">2</span>,<br><span class="hljs-number">3028</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"PTRDIFF_MAX&nbsp;is&nbsp;not&nbsp;more&nbsp;than&nbsp;half&nbsp;of&nbsp;SIZE_MAX"</span>);<br><span class="hljs-number">3029</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*(*hook)&nbsp;(<span class="hljs-keyword">size_t</span>,&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;*)<br><span class="hljs-number">3031</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;atomic_forced_read&nbsp;(__malloc_hook);<br><span class="hljs-number">3032</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(__builtin_expect&nbsp;(hook&nbsp;!=&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-number">0</span>))<br><span class="hljs-number">3033</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*hook)(bytes,&nbsp;RETURN_ADDRESS&nbsp;(<span class="hljs-number">0</span>));<br><span class="hljs-number">3034</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span>&nbsp;USE_TCACHE</span><br><span class="hljs-number">3035</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;int_free&nbsp;also&nbsp;calls&nbsp;request2size,&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;pad&nbsp;twice.&nbsp;&nbsp;*/</span><br><span class="hljs-number">3036</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">size_t</span>&nbsp;tbytes;<br><span class="hljs-number">3037</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!checked_request2size&nbsp;(bytes,&nbsp;&amp;tbytes))<br><span class="hljs-number">3038</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3039</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__set_errno&nbsp;(ENOMEM);<br><span class="hljs-number">3040</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="hljs-number">3041</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3054</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><span class="hljs-number">3055</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3056</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(SINGLE_THREAD_P)<br><span class="hljs-number">3057</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3058</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim&nbsp;=&nbsp;_int_malloc&nbsp;(&amp;main_arena,&nbsp;bytes);<br><span class="hljs-number">3059</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;(!victim&nbsp;||&nbsp;chunk_is_mmapped&nbsp;(mem2chunk&nbsp;(victim))&nbsp;||<br><span class="hljs-number">3060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;main_arena&nbsp;==&nbsp;arena_for_chunk&nbsp;(mem2chunk&nbsp;(victim)));<br><span class="hljs-number">3061</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;victim;<br><span class="hljs-number">3062</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3082</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p>上述代码通过将没什么影响的部分去掉，从而简化了我们的分析过程。这里，有以下几个疑问：</p>
<ul>
<li><p>局部变量<code>victim</code>（数据类型为：<code>void *</code>）的作用？</p></li>
<li><p>局部变量<code>hook</code>（函数指针）的作用？</p></li>
<li><p><code>checked_request2size (bytes, &amp;tbytes)</code>的作用？</p></li>
<li><p><code>main_arena</code>的作用？</p></li>
<li><p><code>_int_malloc (&amp;amp;main_arena, bytes);</code>的作用？</p></li>
</ul>
<p>接下来，逐一研究这些问题。</p>
<p><strong>3）</strong> <code>malloc</code>函数中，局部变量<code>victim</code>（数据类型为：<code>void *</code>）的作用？</p>
<p>通过源码可以很容易地看出，局部变量<code>victim</code>即为<code>__libc_malloc</code>函数的返回值，意味着该变量指向用户所申请堆内存的起始位置。</p>
<p>接下来，通过调试直观地观察下。</p>
<p>a）执行完 malloc.c:3058 行后，查看局部变量<code>victim</code>的值</p>
<pre><code class="hljs ruby">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">7</span>,&nbsp;__GI___libc_malloc&nbsp;(bytes=<span class="hljs-number">8</span>)&nbsp;at&nbsp;malloc.<span class="hljs-symbol">c:</span><span class="hljs-number">3058</span><br><span class="hljs-number">3058</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim&nbsp;=&nbsp;_int_malloc&nbsp;(&amp;main_arena,&nbsp;bytes);<br>(gdb)&nbsp;n<br><span class="hljs-number">3059</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;(!victim&nbsp;<span class="hljs-params">||</span>&nbsp;chunk_is_mmapped&nbsp;(mem2chunk&nbsp;(victim))&nbsp;<span class="hljs-params">||</span><br>(gdb)&nbsp;p&nbsp;victim<br>$2&nbsp;=&nbsp;(void&nbsp;*)&nbsp;<span class="hljs-number">0x5555555592a0</span><br></code></pre>
<p>b）继续单步执行，查看数据成员<code>data_</code>的值</p>
<pre><code class="hljs kotlin">(gdb)&nbsp;n<br>HeapObject::HeapObject&nbsp;(<span class="hljs-keyword">this</span>=<span class="hljs-number">0x7fffffffdc40</span>,&nbsp;size=<span class="hljs-number">8</span>)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">12</span><br><span class="hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(data_)<br>(gdb)&nbsp;p/x&nbsp;data_<br>$<span class="hljs-number">3</span>&nbsp;=&nbsp;<span class="hljs-number">0x5555555592a0</span><br>(gdb)&nbsp;bt<br>#<span class="hljs-number">0</span>&nbsp;&nbsp;HeapObject::HeapObject&nbsp;(<span class="hljs-keyword">this</span>=<span class="hljs-number">0x7fffffffdc40</span>,&nbsp;size=<span class="hljs-number">8</span>)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">12</span><br>#<span class="hljs-number">1</span>&nbsp;&nbsp;<span class="hljs-number">0x00005555555551dd</span>&nbsp;<span class="hljs-keyword">in</span>&nbsp;main&nbsp;(argc=<span class="hljs-number">1</span>,&nbsp;argv=<span class="hljs-number">0x7fffffffdda8</span>)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">38</span><br></code></pre>
<p>从上面的结果中可以看出，局部变量<code>victim</code>的值和数据成员<code>data_</code>的值相等，都是 0x5555555592a0。</p>
<p>因此，<strong><code>malloc</code>函数中局部变量<code>victim</code>的作用为：</strong>用于指向用户所申请堆内存的起始位置。</p>
<p><strong>4）</strong> malloc 函数中，局部变量 hook（函数指针）的作用？</p>
<p><strong><code>malloc</code>函数中局部变量<code>hook</code>（函数指针）的作用：</strong>用于保存一个钩子函数的地址。这个钩子函数用于真正地分配堆内存。另外，我们可以在链接期替换钩子函数的默认实现，即将标准库中的<code>malloc</code>函数实现替换成我们自己的。具体分析过程，见本文中的 <a href="#jump1">如何在链接期拦截标准库的 malloc</a>。</p>
<p><strong>5）</strong><code>malloc</code>函数中，<code>checked_request2size (bytes, &amp;tbytes)</code>的作用？</p>
<p><code>checked_request2size (bytes, &amp;tbytes)</code>的作用为：确定<code>chunk</code>的大小。具体分析过程，见本文中的 <a href="#jump1_2">chunk 的大小有哪些讲究</a>。</p>
<p><strong>6）</strong> <code>malloc</code>函数中，<code>main_arena</code>的作用？</p>
<p>a）查看<code>main_arena</code>的定义（在 malloc.c 中）</p>
<pre><code class="hljs vbscript">/*&nbsp;There&nbsp;are&nbsp;several&nbsp;instances&nbsp;of&nbsp;this&nbsp;struct&nbsp;(<span class="hljs-string">"arenas"</span>)&nbsp;<span class="hljs-keyword">in</span>&nbsp;this<br>&nbsp;&nbsp;&nbsp;malloc.&nbsp;&nbsp;<span class="hljs-keyword">If</span>&nbsp;you&nbsp;are&nbsp;adapting&nbsp;this&nbsp;malloc&nbsp;<span class="hljs-keyword">in</span>&nbsp;a&nbsp;way&nbsp;that&nbsp;does&nbsp;<span class="hljs-keyword">NOT</span>&nbsp;use<br>&nbsp;&nbsp;&nbsp;a&nbsp;static&nbsp;<span class="hljs-keyword">or</span>&nbsp;mmapped&nbsp;malloc_state,&nbsp;you&nbsp;MUST&nbsp;explicitly&nbsp;zero-fill&nbsp;it<br>&nbsp;&nbsp;&nbsp;before&nbsp;using.&nbsp;This&nbsp;malloc&nbsp;relies&nbsp;<span class="hljs-keyword">on</span>&nbsp;the&nbsp;<span class="hljs-keyword">property</span>&nbsp;that&nbsp;malloc_state<br>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">is</span>&nbsp;initialized&nbsp;<span class="hljs-keyword">to</span>&nbsp;all&nbsp;zeroes&nbsp;(as&nbsp;<span class="hljs-keyword">is</span>&nbsp;<span class="hljs-literal">true</span>&nbsp;of&nbsp;C&nbsp;statics).&nbsp;&nbsp;*/<br><br>static&nbsp;struct&nbsp;malloc_state&nbsp;main_arena&nbsp;=<br>{<br>&nbsp;&nbsp;.mutex&nbsp;=&nbsp;_LIBC_LOCK_INITIALIZER,<br>&nbsp;&nbsp;.<span class="hljs-keyword">next</span>&nbsp;=&nbsp;&amp;main_arena,<br>&nbsp;&nbsp;.attached_threads&nbsp;=&nbsp;<span class="hljs-number">1</span><br>};<br></code></pre>
<p>从上面的结果中可以看出，<code>main_arena</code>是一个数据类型为<code>struct malloc_state</code>的静态全局变量。</p>
<p>b）查看结构体<code>malloc_state</code>的定义（在 malloc.c 中）</p>
<pre><code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword">struct</span>&nbsp;<span class="hljs-title">malloc_state</span><br>{</span><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Serialize&nbsp;access.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;__libc_lock_define&nbsp;(,&nbsp;mutex);<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Flags&nbsp;(formerly&nbsp;in&nbsp;max_fast).&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;flags;<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Set&nbsp;if&nbsp;the&nbsp;fastbin&nbsp;chunks&nbsp;contain&nbsp;recently&nbsp;inserted&nbsp;free&nbsp;blocks.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Note&nbsp;this&nbsp;is&nbsp;a&nbsp;bool&nbsp;but&nbsp;not&nbsp;all&nbsp;targets&nbsp;support&nbsp;atomics&nbsp;on&nbsp;booleans.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;have_fastchunks;<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Fastbins&nbsp;*/</span><br>&nbsp;&nbsp;mfastbinptr&nbsp;fastbinsY[NFASTBINS];<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Base&nbsp;of&nbsp;the&nbsp;topmost&nbsp;chunk&nbsp;--&nbsp;not&nbsp;otherwise&nbsp;kept&nbsp;in&nbsp;a&nbsp;bin&nbsp;*/</span><br>&nbsp;&nbsp;mchunkptr&nbsp;top;<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;The&nbsp;remainder&nbsp;from&nbsp;the&nbsp;most&nbsp;recent&nbsp;split&nbsp;of&nbsp;a&nbsp;small&nbsp;request&nbsp;*/</span><br>&nbsp;&nbsp;mchunkptr&nbsp;last_remainder;<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Normal&nbsp;bins&nbsp;packed&nbsp;as&nbsp;described&nbsp;above&nbsp;*/</span><br>&nbsp;&nbsp;mchunkptr&nbsp;bins[NBINS&nbsp;*&nbsp;<span class="hljs-number">2</span>&nbsp;-&nbsp;<span class="hljs-number">2</span>];<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Bitmap&nbsp;of&nbsp;bins&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">int</span>&nbsp;binmap[BINMAPSIZE];<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Linked&nbsp;list&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-class"><span class="hljs-keyword">struct</span>&nbsp;<span class="hljs-title">malloc_state</span>&nbsp;*<span class="hljs-title">next</span>;</span><br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Linked&nbsp;list&nbsp;for&nbsp;free&nbsp;arenas.&nbsp;&nbsp;Access&nbsp;to&nbsp;this&nbsp;field&nbsp;is&nbsp;serialized<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;by&nbsp;free_list_lock&nbsp;in&nbsp;arena.c.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-class"><span class="hljs-keyword">struct</span>&nbsp;<span class="hljs-title">malloc_state</span>&nbsp;*<span class="hljs-title">next_free</span>;</span><br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Number&nbsp;of&nbsp;threads&nbsp;attached&nbsp;to&nbsp;this&nbsp;arena.&nbsp;&nbsp;0&nbsp;if&nbsp;the&nbsp;arena&nbsp;is&nbsp;on<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;free&nbsp;list.&nbsp;&nbsp;Access&nbsp;to&nbsp;this&nbsp;field&nbsp;is&nbsp;serialized&nbsp;by<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free_list_lock&nbsp;in&nbsp;arena.c.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;INTERNAL_SIZE_T&nbsp;attached_threads;<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Memory&nbsp;allocated&nbsp;from&nbsp;the&nbsp;system&nbsp;in&nbsp;this&nbsp;arena.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;INTERNAL_SIZE_T&nbsp;system_mem;<br>&nbsp;&nbsp;INTERNAL_SIZE_T&nbsp;max_system_mem;<br>};<br></code></pre>
<p>从上面的结果中可以看出，结构体<code>malloc_state</code>的数据成员很多，逐一研究的话很容易懵圈。那么我们可以优先研究那些在<code>obj1</code>对象申请堆内存前后值发生变化的字段。</p>
<p>c）在<code>obj1</code>对象申请堆内存前后，<code>main_arena</code>对象中的哪些字段的值发生了变化？</p>
<p>执行到 malloc.c:3023 行时，查看静态全局变量<code>main_arena</code>的值：</p>
<pre><code class="hljs bash">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;2,&nbsp;__GI___libc_malloc&nbsp;(bytes=8)&nbsp;at&nbsp;malloc.c:3023<br>3023&nbsp;&nbsp;&nbsp;&nbsp;{<br>(gdb)&nbsp;bt<br><span class="hljs-comment">#0&nbsp;&nbsp;__GI___libc_malloc&nbsp;(bytes=8)&nbsp;at&nbsp;malloc.c:3023</span><br><span class="hljs-comment">#1&nbsp;&nbsp;0x00005555555552f3&nbsp;in&nbsp;HeapObject::HeapObject&nbsp;(this=0x7fffffffdc40,&nbsp;size=8)&nbsp;at&nbsp;vm4_main.cpp:11</span><br><span class="hljs-comment">#2&nbsp;&nbsp;0x00005555555551dd&nbsp;in&nbsp;main&nbsp;(argc=1,&nbsp;argv=0x7fffffffdda8)&nbsp;at&nbsp;vm4_main.cpp:38</span><br>(gdb)&nbsp;p&nbsp;p&nbsp;main_arena<br>No&nbsp;symbol&nbsp;<span class="hljs-string">"p"</span>&nbsp;<span class="hljs-keyword">in</span>&nbsp;current&nbsp;context.<br>(gdb)&nbsp;p&nbsp;main_arena<br><span class="hljs-variable">$1</span>&nbsp;=&nbsp;{mutex&nbsp;=&nbsp;0,&nbsp;flags&nbsp;=&nbsp;0,&nbsp;have_fastchunks&nbsp;=&nbsp;0,&nbsp;fastbinsY&nbsp;=&nbsp;{0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0},&nbsp;top&nbsp;=&nbsp;0x0,&nbsp;last_remainder&nbsp;=&nbsp;0x0,&nbsp;bins&nbsp;=&nbsp;{0x0&nbsp;&lt;repeats&nbsp;254&nbsp;<span class="hljs-built_in">times</span>&gt;},&nbsp;<br>&nbsp;&nbsp;binmap&nbsp;=&nbsp;{0,&nbsp;0,&nbsp;0,&nbsp;0},&nbsp;next&nbsp;=&nbsp;0x7ffff7fafb80&nbsp;&lt;main_arena&gt;,&nbsp;next_free&nbsp;=&nbsp;0x0,&nbsp;attached_threads&nbsp;=&nbsp;1,&nbsp;system_mem&nbsp;=&nbsp;0,&nbsp;max_system_mem&nbsp;=&nbsp;0}<br>(gdb)&nbsp;p/x&nbsp;&amp;main_arena<br><span class="hljs-variable">$2</span>&nbsp;=&nbsp;0x7ffff7fafb80<br></code></pre>
<p>从上面的结果中可以看出，<code>main_arena</code>对象的地址为 0x7ffff7fafb80。在<code>obj1</code>对象申请堆内存前，<code>main_arena</code>对象的值为：</p>
<pre><code class="hljs xml">{mutex&nbsp;=&nbsp;0,&nbsp;flags&nbsp;=&nbsp;0,&nbsp;have_fastchunks&nbsp;=&nbsp;0,&nbsp;fastbinsY&nbsp;=&nbsp;{0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0,&nbsp;0x0},&nbsp;top&nbsp;=&nbsp;0x0,&nbsp;last_remainder&nbsp;=&nbsp;0x0,&nbsp;bins&nbsp;=&nbsp;{0x0&nbsp;<span class="hljs-tag">&lt;<span class="hljs-name">repeats</span>&nbsp;<span class="hljs-attr">254</span>&nbsp;<span class="hljs-attr">times</span>&gt;</span>},&nbsp;<br>&nbsp;&nbsp;binmap&nbsp;=&nbsp;{0,&nbsp;0,&nbsp;0,&nbsp;0},&nbsp;next&nbsp;=&nbsp;0x7ffff7fafb80&nbsp;<span class="hljs-tag">&lt;<span class="hljs-name">main_arena</span>&gt;</span>,&nbsp;next_free&nbsp;=&nbsp;0x0,&nbsp;attached_threads&nbsp;=&nbsp;1,&nbsp;system_mem&nbsp;=&nbsp;0,&nbsp;max_system_mem&nbsp;=&nbsp;0}<br></code></pre>
<p>执行到 vm4_main.cpp:39 行时，再次查看静态全局变量<code>main_arena</code>的值：</p>
<pre><code class="hljs go">(gdb)&nbsp;<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">9</span>,&nbsp;main&nbsp;(argc=<span class="hljs-number">1</span>,&nbsp;argv=<span class="hljs-number">0x7fffffffdd</span>a8)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">39</span><br><span class="hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HeapObject&nbsp;obj2(<span class="hljs-number">4</span>);<br>(gdb)&nbsp;p&nbsp;*((<span class="hljs-keyword">struct</span>&nbsp;malloc_state&nbsp;*)<span class="hljs-number">0x7ffff7faf</span>b80)<br>$<span class="hljs-number">4</span>&nbsp;=&nbsp;{mutex&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;flags&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;have_fastchunks&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;fastbinsY&nbsp;=&nbsp;{<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>},&nbsp;top&nbsp;=&nbsp;<span class="hljs-number">0x5555555592b0</span>,&nbsp;last_remainder&nbsp;=&nbsp;<span class="hljs-number">0x0</span>,&nbsp;bins&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x7ffff7faf</span>be0&nbsp;&lt;main_arena+<span class="hljs-number">96</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7faf</span>be0&nbsp;&lt;main_arena+<span class="hljs-number">96</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7fafbf</span>0&nbsp;&lt;main_arena+<span class="hljs-number">112</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7fafbf</span>0&nbsp;&lt;main_arena+<span class="hljs-number">112</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7faf</span>c00&nbsp;&lt;main_arena+<span class="hljs-number">128</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7faf</span>c00&nbsp;&lt;main_arena+<span class="hljs-number">128</span>&gt;...},&nbsp;<br>&nbsp;&nbsp;binmap&nbsp;=&nbsp;{<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>},&nbsp;next&nbsp;=&nbsp;<span class="hljs-number">0x7ffff7faf</span>b80&nbsp;&lt;main_arena&gt;,&nbsp;next_free&nbsp;=&nbsp;<span class="hljs-number">0x0</span>,&nbsp;attached_threads&nbsp;=&nbsp;<span class="hljs-number">1</span>,&nbsp;system_mem&nbsp;=&nbsp;<span class="hljs-number">135168</span>,&nbsp;max_system_mem&nbsp;=&nbsp;<span class="hljs-number">135168</span>}<br></code></pre>
<p>对比<code>obj1</code>对象申请堆内存前后，<code>main_arena</code>对象的值。我们可以发现，在<code>obj1</code>对象申请堆内存后，<code>main_arena</code>对象中值发生变化的数据成员有：<code>top</code>、<code>bins</code>、<code>system_mem</code>、<code>max_system_mem</code>。</p>
<p>相应地，这里有如下几个疑问：</p>
<ul>
<li><p>结构体<code>malloc_state</code>中的数据成员<code>top</code>的作用？</p></li>
<li><p>结构体<code>malloc_state</code>中的数据成员<code>bins</code>的作用？</p></li>
<li><p>结构体<code>malloc_state</code>中的数据成员<code>system_mem</code>的作用？</p></li>
<li><p>结构体<code>malloc_state</code>中的数据成员<code>max_system_mem</code>的作用？</p></li>
</ul>
<p>通过分析 <a href="#jump2">struct malloc_state 中各字段的意义</a>，我们可以推断，<code>malloc</code>函数中<code>main_arena</code>的作用为：用于管理堆。这里的堆特指狭义上的堆，即通过<code>sbrk</code>函数进行扩展或伸缩的。</p>
<p><strong>7）</strong> <code>malloc</code>函数中，<code>_int_malloc (&amp;main_arena, bytes);</code>的作用？</p>
<p>查看<code>_int_malloc (&amp;main_arena, bytes);</code>被调用的地方：</p>
<pre><code class="hljs cpp"><span class="hljs-number">3021</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*<br><span class="hljs-number">3022</span>&nbsp;&nbsp;&nbsp;&nbsp;__libc_malloc&nbsp;(<span class="hljs-keyword">size_t</span>&nbsp;bytes)<br><span class="hljs-number">3023</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3056</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(SINGLE_THREAD_P)<br><span class="hljs-number">3057</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3058</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim&nbsp;=&nbsp;_int_malloc&nbsp;(&amp;main_arena,&nbsp;bytes);<br><span class="hljs-number">3059</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;(!victim&nbsp;||&nbsp;chunk_is_mmapped&nbsp;(mem2chunk&nbsp;(victim))&nbsp;||<br><span class="hljs-number">3060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;main_arena&nbsp;==&nbsp;arena_for_chunk&nbsp;(mem2chunk&nbsp;(victim)));<br><span class="hljs-number">3061</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;victim;<br><span class="hljs-number">3062</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3082</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p>这里有两个事实：1）<code>main_arena</code>对象中的内容目前只被<code>_int_malloc</code>函数修改过；2）<code>_int_malloc</code>函数的返回值保存在局部变量<code>victim</code>中。</p>
<p>因此，我们可以先简单地这样理解，<strong><code>malloc</code>函数中，<code>_int_malloc (&amp;main_arena, bytes);</code>的作用为</strong>：</p>
<ul>
<li><p>堆内存不足时，扩展堆</p></li>
<li><p>从堆中分配内存给用户，并更新用于管理堆的对象（即<code>arena</code>）</p></li>
</ul>
<p><strong>step 2：</strong> 研究 obj2 对象申请堆内存的过程</p>
<p><code>obj2</code>对象申请堆内存的过程与<code>obj1</code>对象的基本相同，这里不再赘述。</p>
<p>我们重点观察下，在<code>obj2</code>对象申请堆内存后，<code>main_arena</code>对象的内容变化情况。</p>
<p>执行完 vm4_main.cpp:39 行后，查看<code>main_arena</code>对象的值：</p>
<pre><code class="hljs go">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">10</span>,&nbsp;main&nbsp;(argc=<span class="hljs-number">1</span>,&nbsp;argv=<span class="hljs-number">0x7fffffffdd</span>a8)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">40</span><br><span class="hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HeapObject&nbsp;obj3(<span class="hljs-number">64</span>);<br>(gdb)&nbsp;p&nbsp;*((<span class="hljs-keyword">struct</span>&nbsp;malloc_state&nbsp;*)<span class="hljs-number">0x7ffff7faf</span>b80)<br>$<span class="hljs-number">5</span>&nbsp;=&nbsp;{mutex&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;flags&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;have_fastchunks&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;fastbinsY&nbsp;=&nbsp;{<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>},&nbsp;top&nbsp;=&nbsp;<span class="hljs-number">0x5555555592d</span>0,&nbsp;last_remainder&nbsp;=&nbsp;<span class="hljs-number">0x0</span>,&nbsp;bins&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x7ffff7faf</span>be0&nbsp;&lt;main_arena+<span class="hljs-number">96</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7faf</span>be0&nbsp;&lt;main_arena+<span class="hljs-number">96</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7fafbf</span>0&nbsp;&lt;main_arena+<span class="hljs-number">112</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7fafbf</span>0&nbsp;&lt;main_arena+<span class="hljs-number">112</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7faf</span>c00&nbsp;&lt;main_arena+<span class="hljs-number">128</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7faf</span>c00&nbsp;&lt;main_arena+<span class="hljs-number">128</span>&gt;...},&nbsp;<br>&nbsp;&nbsp;binmap&nbsp;=&nbsp;{<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>},&nbsp;next&nbsp;=&nbsp;<span class="hljs-number">0x7ffff7faf</span>b80&nbsp;&lt;main_arena&gt;,&nbsp;next_free&nbsp;=&nbsp;<span class="hljs-number">0x0</span>,&nbsp;attached_threads&nbsp;=&nbsp;<span class="hljs-number">1</span>,&nbsp;system_mem&nbsp;=&nbsp;<span class="hljs-number">135168</span>,&nbsp;max_system_mem&nbsp;=&nbsp;<span class="hljs-number">135168</span>}<br></code></pre>
<p>从上面的结果中可以看出，在<code>obj2</code>对象申请堆内存后，<code>main_arena</code>对象中的数据成员<code>top</code>的值从 0x5555555592b0 变成了 0x5555555592d0，其余字段的值未发生变化。</p>
<p><strong>step 3：</strong> 研究 obj3 对象申请堆内存的过程</p>
<p>执行完 vm4_main.cpp:40 行后，查看<code>main_arena</code>对象的值：</p>
<pre><code class="hljs go">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">11</span>,&nbsp;main&nbsp;(argc=<span class="hljs-number">1</span>,&nbsp;argv=<span class="hljs-number">0x7fffffffdd</span>a8)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">41</span><br><span class="hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HeapObject&nbsp;obj4(<span class="hljs-number">4</span>);<br>(gdb)&nbsp;p&nbsp;*((<span class="hljs-keyword">struct</span>&nbsp;malloc_state&nbsp;*)<span class="hljs-number">0x7ffff7faf</span>b80)<br>$<span class="hljs-number">6</span>&nbsp;=&nbsp;{mutex&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;flags&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;have_fastchunks&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;fastbinsY&nbsp;=&nbsp;{<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>},&nbsp;top&nbsp;=&nbsp;<span class="hljs-number">0x555555559320</span>,&nbsp;last_remainder&nbsp;=&nbsp;<span class="hljs-number">0x0</span>,&nbsp;bins&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x7ffff7faf</span>be0&nbsp;&lt;main_arena+<span class="hljs-number">96</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7faf</span>be0&nbsp;&lt;main_arena+<span class="hljs-number">96</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7fafbf</span>0&nbsp;&lt;main_arena+<span class="hljs-number">112</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7fafbf</span>0&nbsp;&lt;main_arena+<span class="hljs-number">112</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7faf</span>c00&nbsp;&lt;main_arena+<span class="hljs-number">128</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7faf</span>c00&nbsp;&lt;main_arena+<span class="hljs-number">128</span>&gt;...},&nbsp;<br>&nbsp;&nbsp;binmap&nbsp;=&nbsp;{<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>},&nbsp;next&nbsp;=&nbsp;<span class="hljs-number">0x7ffff7faf</span>b80&nbsp;&lt;main_arena&gt;,&nbsp;next_free&nbsp;=&nbsp;<span class="hljs-number">0x0</span>,&nbsp;attached_threads&nbsp;=&nbsp;<span class="hljs-number">1</span>,&nbsp;system_mem&nbsp;=&nbsp;<span class="hljs-number">135168</span>,&nbsp;max_system_mem&nbsp;=&nbsp;<span class="hljs-number">135168</span>}<br></code></pre>
<p>从上面的结果中可以看出，在<code>obj3</code>对象申请堆内存后，<code>main_arena</code>对象中的数据成员<code>top</code>的值从 0x5555555592d0 变成了 0x555555559320，其余字段的值未发生变化。</p>
<p><strong>step 4：</strong> 研究 obj4 对象申请堆内存的过程</p>
<p>执行完 vm4_main.cpp:41 行后，查看<code>main_arena</code>对象的值：</p>
<pre><code class="hljs go">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">12</span>,&nbsp;main&nbsp;(argc=<span class="hljs-number">1</span>,&nbsp;argv=<span class="hljs-number">0x7fffffffdd</span>a8)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">43</span><br><span class="hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj2.Free();<br>(gdb)&nbsp;p&nbsp;*((<span class="hljs-keyword">struct</span>&nbsp;malloc_state&nbsp;*)<span class="hljs-number">0x7ffff7faf</span>b80)<br>$<span class="hljs-number">7</span>&nbsp;=&nbsp;{mutex&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;flags&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;have_fastchunks&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;fastbinsY&nbsp;=&nbsp;{<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x0</span>},&nbsp;top&nbsp;=&nbsp;<span class="hljs-number">0x555555559340</span>,&nbsp;last_remainder&nbsp;=&nbsp;<span class="hljs-number">0x0</span>,&nbsp;bins&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x7ffff7faf</span>be0&nbsp;&lt;main_arena+<span class="hljs-number">96</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7faf</span>be0&nbsp;&lt;main_arena+<span class="hljs-number">96</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7fafbf</span>0&nbsp;&lt;main_arena+<span class="hljs-number">112</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7fafbf</span>0&nbsp;&lt;main_arena+<span class="hljs-number">112</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7faf</span>c00&nbsp;&lt;main_arena+<span class="hljs-number">128</span>&gt;,&nbsp;<span class="hljs-number">0x7ffff7faf</span>c00&nbsp;&lt;main_arena+<span class="hljs-number">128</span>&gt;...},&nbsp;<br>&nbsp;&nbsp;binmap&nbsp;=&nbsp;{<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>},&nbsp;next&nbsp;=&nbsp;<span class="hljs-number">0x7ffff7faf</span>b80&nbsp;&lt;main_arena&gt;,&nbsp;next_free&nbsp;=&nbsp;<span class="hljs-number">0x0</span>,&nbsp;attached_threads&nbsp;=&nbsp;<span class="hljs-number">1</span>,&nbsp;system_mem&nbsp;=&nbsp;<span class="hljs-number">135168</span>,&nbsp;max_system_mem&nbsp;=&nbsp;<span class="hljs-number">135168</span>}<br></code></pre>
<p>从上面的结果中可以看出，在<code>obj4</code>对象申请堆内存后，<code>main_arena</code>对象中的数据成员<code>top</code>的值从 0x555555559320 变成了 0x555555559340，其余字段的值未发生变化。</p>
<p><strong>step 5：</strong> 研究 obj2 对象释放堆内存的过程</p>
<p><strong>1）</strong> 进入<code>free</code>函数</p>
<pre><code class="hljs cpp">(gdb)&nbsp;b&nbsp;<span class="hljs-built_in">free</span><br>Breakpoint&nbsp;<span class="hljs-number">6</span>&nbsp;at&nbsp;<span class="hljs-number">0x7ffff7e61850</span>:&nbsp;<span class="hljs-built_in">free</span>.&nbsp;(<span class="hljs-number">2</span>&nbsp;locations)<br>(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">6</span>,&nbsp;__GI___libc_free&nbsp;(mem=<span class="hljs-number">0x5555555592c0</span>)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3087</span><br><span class="hljs-number">3087</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br></code></pre>
<p><strong>2）</strong> 分析<code>obj2</code>对象释放堆内存时，实际调用了<code>free</code>函数的哪些代码</p>
<p>a）查看<code>free</code>函数完整的实现源码</p>
<pre><code class="hljs cpp">(gdb)&nbsp;l&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3085</span>,<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3126</span><br><span class="hljs-number">3085</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span><br><span class="hljs-number">3086</span>&nbsp;&nbsp;&nbsp;&nbsp;__libc_free&nbsp;(<span class="hljs-keyword">void</span>&nbsp;*mem)<br><span class="hljs-number">3087</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3088</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mstate&nbsp;ar_ptr;<br><span class="hljs-number">3089</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mchunkptr&nbsp;p;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;chunk&nbsp;corresponding&nbsp;to&nbsp;mem&nbsp;*/</span><br><span class="hljs-number">3090</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3091</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;(*hook)&nbsp;(<span class="hljs-keyword">void</span>&nbsp;*,&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;*)<br><span class="hljs-number">3092</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;atomic_forced_read&nbsp;(__free_hook);<br><span class="hljs-number">3093</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(__builtin_expect&nbsp;(hook&nbsp;!=&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-number">0</span>))<br><span class="hljs-number">3094</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3095</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(*hook)(mem,&nbsp;RETURN_ADDRESS&nbsp;(<span class="hljs-number">0</span>));<br><span class="hljs-number">3096</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>;<br><span class="hljs-number">3097</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">3098</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3099</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(mem&nbsp;==&nbsp;<span class="hljs-number">0</span>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;free(0)&nbsp;has&nbsp;no&nbsp;effect&nbsp;*/</span><br><span class="hljs-number">3100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>;<br><span class="hljs-number">3101</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3102</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p&nbsp;=&nbsp;mem2chunk&nbsp;(mem);<br><span class="hljs-number">3103</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3104</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(chunk_is_mmapped&nbsp;(p))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;release&nbsp;mmapped&nbsp;memory.&nbsp;*/</span><br><span class="hljs-number">3105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3106</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;See&nbsp;if&nbsp;the&nbsp;dynamic&nbsp;brk/mmap&nbsp;threshold&nbsp;needs&nbsp;adjusting.<br>3107&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dumped&nbsp;fake&nbsp;mmapped&nbsp;chunks&nbsp;do&nbsp;not&nbsp;affect&nbsp;the&nbsp;threshold.&nbsp;&nbsp;*/</span><br><span class="hljs-number">3108</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!mp_.no_dyn_threshold<br><span class="hljs-number">3109</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;chunksize_nomask&nbsp;(p)&nbsp;&gt;&nbsp;mp_.mmap_threshold<br><span class="hljs-number">3110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;chunksize_nomask&nbsp;(p)&nbsp;&lt;=&nbsp;DEFAULT_MMAP_THRESHOLD_MAX<br><span class="hljs-number">3111</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;!DUMPED_MAIN_ARENA_CHUNK&nbsp;(p))<br><span class="hljs-number">3112</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3113</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mp_.mmap_threshold&nbsp;=&nbsp;chunksize&nbsp;(p);<br><span class="hljs-number">3114</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mp_.trim_threshold&nbsp;=&nbsp;<span class="hljs-number">2</span>&nbsp;*&nbsp;mp_.mmap_threshold;<br><span class="hljs-number">3115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIBC_PROBE&nbsp;(memory_mallopt_free_dyn_thresholds,&nbsp;<span class="hljs-number">2</span>,<br><span class="hljs-number">3116</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mp_.mmap_threshold,&nbsp;mp_.trim_threshold);<br><span class="hljs-number">3117</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">3118</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;munmap_chunk&nbsp;(p);<br><span class="hljs-number">3119</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>;<br><span class="hljs-number">3120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">3121</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3122</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAYBE_INIT_TCACHE&nbsp;();<br><span class="hljs-number">3123</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3124</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ar_ptr&nbsp;=&nbsp;arena_for_chunk&nbsp;(p);<br><span class="hljs-number">3125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_int_free&nbsp;(ar_ptr,&nbsp;p,&nbsp;<span class="hljs-number">0</span>);<br><span class="hljs-number">3126</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p>b）为了简单，这里直接给出<code>obj2</code>对象释放堆内存时，实际调用的<code>free</code>函数的代码部分</p>
<pre><code class="hljs cpp"><span class="hljs-number">3085</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span><br><span class="hljs-number">3086</span>&nbsp;&nbsp;&nbsp;&nbsp;__libc_free&nbsp;(<span class="hljs-keyword">void</span>&nbsp;*mem)<br><span class="hljs-number">3087</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3088</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mstate&nbsp;ar_ptr;<br><span class="hljs-number">3089</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mchunkptr&nbsp;p;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;chunk&nbsp;corresponding&nbsp;to&nbsp;mem&nbsp;*/</span><br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3102</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p&nbsp;=&nbsp;mem2chunk&nbsp;(mem);<br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3124</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ar_ptr&nbsp;=&nbsp;arena_for_chunk&nbsp;(p);<br><span class="hljs-number">3125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_int_free&nbsp;(ar_ptr,&nbsp;p,&nbsp;<span class="hljs-number">0</span>);<br><span class="hljs-number">3126</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p>其中，<code>mem2chunk</code>的作用在上文已经提到过了。因此，局部变量<code>p</code>的值就是要释放<code>chunk</code>的起始地址。</p>
<p>这里，有以下几个疑问：</p>
<ul>
<li><p><code>arena_for_chunk</code>的作用？</p></li>
<li><p><code><em>int_free`是如何将`obj2.data</em></code>所在的已分配块释放的？</p></li>
</ul>
<p>c）<code>arena_for_chunk</code>的作用？</p>
<p>查看<code>arena_for_chunk</code>的定义（在 arena.c 中）：</p>
<pre><code class="hljs cs"><span class="hljs-comment">/*&nbsp;find&nbsp;the&nbsp;heap&nbsp;and&nbsp;corresponding&nbsp;arena&nbsp;for&nbsp;a&nbsp;given&nbsp;ptr&nbsp;*/</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;heap_for_ptr(ptr)&nbsp;\</span><br>&nbsp;&nbsp;((heap_info&nbsp;*)&nbsp;((unsigned&nbsp;<span class="hljs-keyword">long</span>)&nbsp;(ptr)&nbsp;&amp;&nbsp;~(HEAP_MAX_SIZE&nbsp;-&nbsp;<span class="hljs-number">1</span>)))<br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;arena_for_chunk(ptr)&nbsp;\</span><br>&nbsp;&nbsp;(chunk_main_arena&nbsp;(ptr)&nbsp;?&nbsp;&amp;main_arena&nbsp;:&nbsp;heap_for_ptr&nbsp;(ptr)-&gt;ar_ptr)<br></code></pre>
<p>其中，<code>chunk_main_arena</code>的定义（在 malloc.c 中）：</p>
<pre><code class="hljs vbnet">/*&nbsp;size&nbsp;field&nbsp;<span class="hljs-keyword">is</span>&nbsp;<span class="hljs-keyword">or</span><span class="hljs-comment">'ed&nbsp;with&nbsp;NON_MAIN_ARENA&nbsp;if&nbsp;the&nbsp;chunk&nbsp;was&nbsp;obtained</span><br>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">from</span>&nbsp;a&nbsp;non-main&nbsp;arena.&nbsp;&nbsp;This&nbsp;<span class="hljs-keyword">is</span>&nbsp;only&nbsp;<span class="hljs-keyword">set</span>&nbsp;immediately&nbsp;before&nbsp;handing<br>&nbsp;&nbsp;&nbsp;the&nbsp;chunk&nbsp;<span class="hljs-keyword">to</span>&nbsp;the&nbsp;user,&nbsp;<span class="hljs-keyword">if</span>&nbsp;necessary.&nbsp;&nbsp;*/<br><span class="hljs-meta">#define&nbsp;NON_MAIN_ARENA&nbsp;0x4</span><br><br>/*&nbsp;Check&nbsp;<span class="hljs-keyword">for</span>&nbsp;chunk&nbsp;<span class="hljs-keyword">from</span>&nbsp;main&nbsp;arena.&nbsp;&nbsp;*/<br><span class="hljs-meta">#define&nbsp;chunk_main_arena(p)&nbsp;(((p)-&gt;mchunk_size&nbsp;&amp;&nbsp;NON_MAIN_ARENA)&nbsp;==&nbsp;0)</span><br></code></pre>
<p>通过上面的宏定义，我们可以推断，<strong><code>arena_for_chunk</code>的作用：</strong>返回<code>chunk</code>所属于的<code>arena</code>（数据类型为<code>struct malloc_state</code>的对象）的地址。这个<code>arena</code>要么是<code>main_arena</code>，要么是<code>heap_for_ptr(ptr)</code>返回的。</p>
<p>同时，我们也可以看出，<strong>判断一个<code>chunk</code>是否属于<code>main_arena</code>的方法：</strong>如果<code>chunk</code>中的<code>mchunk_size</code>字段里面<code>A</code>标志位的值为 0，那么该<code>chunk</code>属于<code>main_arena</code>。（此处解释了上一篇中的遗留问题——<code>malloc_chunk</code>结构体中<code>mchunk_size</code>字段里面的<code>A</code>标志位是如何运用的？）</p>
<p>d）<code>_int_free</code>是如何将<code>obj2.data_</code>所在的已分配块释放的？</p>
<p><code>obj2.data_</code>所在的已分配块被释放后，会被维护在<code>tcache</code>中。具体分析过程，见本文中的 <a href="#jump5">为什么在调用 free 函数后，被释放的 chunk 从内存数据来看仍是一个已分配块？</a></p>
<p><strong>step 6：</strong> 研究 obj4 对象释放堆内存的过程</p>
<pre><code class="hljs delphi">(gdb)&nbsp;b&nbsp;malloc.c:<span class="hljs-number">4208</span><br>Breakpoint&nbsp;<span class="hljs-number">12</span>&nbsp;at&nbsp;<span class="hljs-number">0</span>x7ffff7e5bc78:&nbsp;<span class="hljs-keyword">file</span>&nbsp;malloc.c,&nbsp;line&nbsp;<span class="hljs-number">4208</span>.<br>(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">12</span>,&nbsp;tcache_put&nbsp;(tc_idx=<span class="hljs-number">0</span>,&nbsp;chunk=<span class="hljs-number">0</span>x555555559320)&nbsp;at&nbsp;malloc.c:<span class="hljs-number">4208</span><br><span class="hljs-number">4208</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcache_put&nbsp;(p,&nbsp;tc_idx);<br>(gdb)&nbsp;bt<br><span class="hljs-string">#0</span>&nbsp;&nbsp;tcache_put&nbsp;(tc_idx=<span class="hljs-number">0</span>,&nbsp;chunk=<span class="hljs-number">0</span>x555555559320)&nbsp;at&nbsp;malloc.c:<span class="hljs-number">4208</span><br><span class="hljs-string">#1</span>&nbsp;&nbsp;_int_free&nbsp;(av=<span class="hljs-number">0</span>x7ffff7fadb80&nbsp;&lt;main_arena&gt;,&nbsp;p=<span class="hljs-number">0</span>x555555559320,&nbsp;have_lock=<span class="hljs-number">0</span>)&nbsp;at&nbsp;malloc.c:<span class="hljs-number">4208</span><br><span class="hljs-string">#2</span>&nbsp;&nbsp;<span class="hljs-number">0</span>x000055555555536f&nbsp;<span class="hljs-keyword">in</span>&nbsp;HeapObject::Free&nbsp;(this=<span class="hljs-number">0</span>x7fffffffdc60)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">26</span><br><span class="hljs-string">#3</span>&nbsp;&nbsp;<span class="hljs-number">0</span>x0000555555555228&nbsp;<span class="hljs-keyword">in</span>&nbsp;main&nbsp;(argc=<span class="hljs-number">1</span>,&nbsp;argv=<span class="hljs-number">0</span>x7fffffffdd98)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">44</span><br>(gdb)&nbsp;l&nbsp;vm4_main.cpp:<span class="hljs-number">44</span><br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj4.Free();<br><span class="hljs-comment">//&nbsp;省略...</span><br></code></pre>
<p>从上面的结果中可以看出，<code>obj4.data_</code>所在的已分配块被释放后，也会被维护在<code>tcache</code>中。</p>
<p><strong>step 7：</strong> 研究 obj3 对象释放堆内存的过程</p>
<pre><code class="hljs go">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">12</span>,&nbsp;tcache_put&nbsp;(tc_idx=<span class="hljs-number">3</span>,&nbsp;chunk=<span class="hljs-number">0x5555555592d</span>0)&nbsp;at&nbsp;malloc.c:<span class="hljs-number">4208</span><br><span class="hljs-number">4208</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcache_put&nbsp;(p,&nbsp;tc_idx);<br>(gdb)&nbsp;bt<br>#<span class="hljs-number">0</span>&nbsp;&nbsp;tcache_put&nbsp;(tc_idx=<span class="hljs-number">3</span>,&nbsp;chunk=<span class="hljs-number">0x5555555592d</span>0)&nbsp;at&nbsp;malloc.c:<span class="hljs-number">4208</span><br>#<span class="hljs-number">1</span>&nbsp;&nbsp;_int_free&nbsp;(av=<span class="hljs-number">0x7ffff7fad</span>b80&nbsp;&lt;main_arena&gt;,&nbsp;p=<span class="hljs-number">0x5555555592d</span>0,&nbsp;have_lock=<span class="hljs-number">0</span>)&nbsp;at&nbsp;malloc.c:<span class="hljs-number">4208</span><br>#<span class="hljs-number">2</span>&nbsp;&nbsp;<span class="hljs-number">0x000055555555536f</span>&nbsp;in&nbsp;HeapObject::Free&nbsp;(this=<span class="hljs-number">0x7fffffffd</span>c50)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">26</span><br>#<span class="hljs-number">3</span>&nbsp;&nbsp;<span class="hljs-number">0x0000555555555234</span>&nbsp;in&nbsp;main&nbsp;(argc=<span class="hljs-number">1</span>,&nbsp;argv=<span class="hljs-number">0x7fffffffdd</span>98)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">45</span><br>(gdb)&nbsp;l&nbsp;vm4_main.cpp:<span class="hljs-number">45</span><br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj3.Free();<br><span class="hljs-comment">//&nbsp;省略...</span><br></code></pre>
<p>从上面的结果中可以看出，<code>obj3.data_</code>所在的已分配块被释放后，也会被维护在<code>tcache</code>中。</p>
<p><strong>step 8：</strong> 研究 obj1 对象释放堆内存的过程</p>
<pre><code class="hljs delphi">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">12</span>,&nbsp;tcache_put&nbsp;(tc_idx=<span class="hljs-number">0</span>,&nbsp;chunk=<span class="hljs-number">0</span>x555555559290)&nbsp;at&nbsp;malloc.c:<span class="hljs-number">4208</span><br><span class="hljs-number">4208</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcache_put&nbsp;(p,&nbsp;tc_idx);<br>(gdb)&nbsp;bt<br><span class="hljs-string">#0</span>&nbsp;&nbsp;tcache_put&nbsp;(tc_idx=<span class="hljs-number">0</span>,&nbsp;chunk=<span class="hljs-number">0</span>x555555559290)&nbsp;at&nbsp;malloc.c:<span class="hljs-number">4208</span><br><span class="hljs-string">#1</span>&nbsp;&nbsp;_int_free&nbsp;(av=<span class="hljs-number">0</span>x7ffff7fadb80&nbsp;&lt;main_arena&gt;,&nbsp;p=<span class="hljs-number">0</span>x555555559290,&nbsp;have_lock=<span class="hljs-number">0</span>)&nbsp;at&nbsp;malloc.c:<span class="hljs-number">4208</span><br><span class="hljs-string">#2</span>&nbsp;&nbsp;<span class="hljs-number">0</span>x000055555555536f&nbsp;<span class="hljs-keyword">in</span>&nbsp;HeapObject::Free&nbsp;(this=<span class="hljs-number">0</span>x7fffffffdc30)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">26</span><br><span class="hljs-string">#3</span>&nbsp;&nbsp;<span class="hljs-number">0</span>x0000555555555240&nbsp;<span class="hljs-keyword">in</span>&nbsp;main&nbsp;(argc=<span class="hljs-number">1</span>,&nbsp;argv=<span class="hljs-number">0</span>x7fffffffdd98)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">46</span><br>(gdb)&nbsp;l&nbsp;vm4_main.cpp:<span class="hljs-number">46</span><br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj1.Free();<br><span class="hljs-comment">//&nbsp;省略...</span><br></code></pre>
<p>从上面的结果中可以看出，<code>obj1.data_</code>所在的已分配块被释放后，也会被维护在<code>tcache</code>中。</p>
<p><strong>step 9：</strong> 研究 obj5 对象申请堆内存的过程</p>
<p>结合上述分析过程，我们可以推断，由于<code>obj5.data_</code>要申请的堆内存大小为 32 字节，所以<code>malloc</code>函数会为分其分配一个大小为 48 字节的<code>chunk</code>。目前<code>tcache</code>中没有大小为 48 字节的空闲<code>chunk</code>。所以，会从<code>top chunk</code>中进行分配。</p>
<p>现在，我们通过 gdb 将<code>obj5.data_</code>要申请的堆内存大小修改为 16 字节，观察其分配过程。</p>
<pre><code class="hljs cpp">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">2</span>,&nbsp;__GI___libc_malloc&nbsp;(bytes=<span class="hljs-number">32</span>)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3023</span><br><span class="hljs-number">3023</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br>(gdb)&nbsp;p/d&nbsp;bytes=<span class="hljs-number">16</span><br>$<span class="hljs-number">1</span>&nbsp;=&nbsp;<span class="hljs-number">16</span><br>(gdb)&nbsp;n<br><span class="hljs-number">3031</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;atomic_forced_read&nbsp;(__malloc_hook);<br><span class="hljs-comment">//&nbsp;省略...</span><br>(gdb)&nbsp;n<br><span class="hljs-number">3047</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(tc_idx&nbsp;&lt;&nbsp;mp_.tcache_bins<br>(gdb)&nbsp;<br><br>Breakpoint&nbsp;<span class="hljs-number">5</span>,&nbsp;tcache_get&nbsp;(tc_idx=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3051</span><br><span class="hljs-number">3051</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;tcache_get&nbsp;(tc_idx);<br>(gdb)&nbsp;n<br><span class="hljs-number">2937</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcache-&gt;entries[tc_idx]&nbsp;=&nbsp;e-&gt;next;<br>(gdb)&nbsp;<br><span class="hljs-number">2938</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--(tcache-&gt;counts[tc_idx]);<br>(gdb)&nbsp;<br><span class="hljs-number">2939</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e-&gt;key&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br>(gdb)&nbsp;<br>__GI___libc_malloc&nbsp;(bytes=<span class="hljs-number">16</span>)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">2940</span><br><span class="hljs-number">2940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(<span class="hljs-keyword">void</span>&nbsp;*)&nbsp;e;<br><span class="hljs-comment">//&nbsp;省略...</span><br>(gdb)&nbsp;n<br>main&nbsp;(argc=<span class="hljs-number">1</span>,&nbsp;argv=<span class="hljs-number">0x7fffffffdd98</span>)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">49</span><br><span class="hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj5.Free();<br>(gdb)&nbsp;p&nbsp;obj5.data_<br>$<span class="hljs-number">3</span>&nbsp;=&nbsp;(<span class="hljs-keyword">void</span>&nbsp;*)&nbsp;<span class="hljs-number">0x5555555592a0</span><br></code></pre>
<p>从上面的结果中可以看出，当申请一个大小为 16 字节的堆内存时，在 64-bit 系统中所对应的<code>chunk</code>的大小为 32 字节。如果<code>tcache</code>中有相同大小的空闲<code>chunk</code>，那么会从<code>tcache</code>中分配并返回给用户。</p>
<hr>
<h3 id="hspanidjump1mallocspan"><span><span id="jump1">如何在链接期拦截标准库的 malloc</span></span></h3>
<p><strong><font size="4">研究过程：</font></strong></p>
<p><strong>step 1：</strong> 在链接期拦截标准库的<code>malloc</code>函数的工作原理</p>
<p><strong>1）</strong> 启动可执行目标文件<code>vm4_main</code>，并设置一些断点等</p>
<pre><code class="hljs go">$&nbsp;gdb&nbsp;-q&nbsp;-x&nbsp;tvm4_1.gdb<br>Temporary&nbsp;breakpoint&nbsp;<span class="hljs-number">1</span>&nbsp;at&nbsp;<span class="hljs-number">0x11a9</span>:&nbsp;file&nbsp;vm4_main.cpp,&nbsp;line&nbsp;<span class="hljs-number">37.</span><br><br>Temporary&nbsp;breakpoint&nbsp;<span class="hljs-number">1</span>,&nbsp;main&nbsp;(argc=<span class="hljs-number">0</span>,&nbsp;argv=<span class="hljs-number">0x0</span>)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">37</span><br><span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br>Breakpoint&nbsp;<span class="hljs-number">2</span>&nbsp;at&nbsp;<span class="hljs-number">0x7ffff7e5f</span>260:&nbsp;malloc.&nbsp;(<span class="hljs-number">2</span>&nbsp;locations)<br>Breakpoint&nbsp;<span class="hljs-number">3</span>&nbsp;at&nbsp;<span class="hljs-number">0x7ffff7e5edf</span>b:&nbsp;malloc.c:<span class="hljs-number">3033.</span>&nbsp;(<span class="hljs-number">2</span>&nbsp;locations)<br>Breakpoint&nbsp;<span class="hljs-number">4</span>&nbsp;at&nbsp;<span class="hljs-number">0x5555555551dd</span>:&nbsp;file&nbsp;vm4_main.cpp,&nbsp;line&nbsp;<span class="hljs-number">39.</span><br></code></pre>
<p>tvm4_1.gdb 文件的内容为：</p>
<pre><code class="hljs cpp">file&nbsp;./vm4_main<br>start<br>directory&nbsp;/home/workspace/git-projects/glibc<span class="hljs-number">-2.31</span>/<span class="hljs-built_in">malloc</span><br><span class="hljs-built_in">set</span>&nbsp;listsize&nbsp;<span class="hljs-number">20</span><br><br>b&nbsp;<span class="hljs-built_in">malloc</span><br>b&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3033</span><br>b&nbsp;vm4_main.cpp:<span class="hljs-number">39</span><br></code></pre>
<p><strong>2）</strong> 继续执行直到 malloc.c:3033 行时停止，并查看局部变量<code>hook</code>的值</p>
<pre><code class="hljs cpp">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">2</span>,&nbsp;__GI___libc_malloc&nbsp;(bytes=<span class="hljs-number">8</span>)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3023</span><br><span class="hljs-number">3023</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br>(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">3</span>,&nbsp;__GI___libc_malloc&nbsp;(bytes=<span class="hljs-number">8</span>)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3033</span><br><span class="hljs-number">3033</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*hook)(bytes,&nbsp;RETURN_ADDRESS&nbsp;(<span class="hljs-number">0</span>));<br>(gdb)&nbsp;p&nbsp;hook<br>$<span class="hljs-number">1</span>&nbsp;=&nbsp;(<span class="hljs-keyword">void</span>&nbsp;*(*)(<span class="hljs-keyword">size_t</span>,&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;*))&nbsp;<span class="hljs-number">0x7ffff7e5ec90</span>&nbsp;&lt;malloc_hook_ini&gt;<br></code></pre>
<p>从上面的结果中可以看出，局部变量<code>hook</code>的值正是函数<code>malloc_hook_ini</code>的地址。</p>
<p>也就是说，此处的<code>return (*hook)(bytes, RETURN_ADDRESS (0));</code>语句等价于<code>return malloc_hook_ini(bytes, RETURN_ADDRESS (0));</code>。</p>
<p><strong>3）</strong> 查看函数<code>malloc_hook_ini</code>的源码（在 hooks.c 中）</p>
<pre><code class="hljs vbscript">(gdb)&nbsp;l&nbsp;malloc_hook_ini<br><span class="hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;What&nbsp;<span class="hljs-keyword">to</span>&nbsp;<span class="hljs-keyword">do</span>&nbsp;<span class="hljs-keyword">if</span>&nbsp;the&nbsp;standard&nbsp;debugging&nbsp;hooks&nbsp;are&nbsp;<span class="hljs-keyword">in</span>&nbsp;place&nbsp;<span class="hljs-keyword">and</span>&nbsp;a<br><span class="hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;corrupt&nbsp;pointer&nbsp;<span class="hljs-keyword">is</span>&nbsp;detected:&nbsp;<span class="hljs-keyword">do</span>&nbsp;<span class="hljs-literal">nothing</span>&nbsp;(<span class="hljs-number">0</span>),&nbsp;print&nbsp;an&nbsp;<span class="hljs-keyword">error</span>&nbsp;message<br><span class="hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-number">1</span>),&nbsp;<span class="hljs-keyword">or</span>&nbsp;<span class="hljs-keyword">call</span>&nbsp;abort()&nbsp;(<span class="hljs-number">2</span>).&nbsp;*/<br><span class="hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Hooks&nbsp;<span class="hljs-keyword">for</span>&nbsp;debugging&nbsp;versions.&nbsp;&nbsp;The&nbsp;initial&nbsp;hooks&nbsp;just&nbsp;<span class="hljs-keyword">call</span>&nbsp;the<br><span class="hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;initialization&nbsp;routine,&nbsp;<span class="hljs-keyword">then</span>&nbsp;<span class="hljs-keyword">do</span>&nbsp;the&nbsp;normal&nbsp;work.&nbsp;*/<br><span class="hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;void&nbsp;*<br><span class="hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;malloc_hook_ini&nbsp;(size_t&nbsp;sz,&nbsp;<span class="hljs-keyword">const</span>&nbsp;void&nbsp;*caller)<br><span class="hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__malloc_hook&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptmalloc_init&nbsp;();<br><span class="hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;__libc_malloc&nbsp;(sz);<br><span class="hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p>从上面的结果中可以看出，函数<code>malloc_hook_ini</code>里面依次调用的函数为<code>ptmalloc_init ();</code>、<code>__libc_malloc (sz);</code>。</p>
<p><code>ptmalloc_init ()</code>函数的作用，先作为<strong>遗留问题</strong>。</p>
<p><strong>需要注意的是</strong>，函数<code>malloc_hook_ini</code>在调用<code>__libc_malloc (sz);</code>前先将<code>__malloc_hook</code>变量置为<code>NULL</code>。这样做是为了避免下一次进入<code>__libc_malloc</code>函数后又进入<code>malloc_hook_ini</code>函数，从而导致死循环。</p>
<p><strong>4）</strong> 局部变量<code>hook</code>是如何指向<code>malloc_hook_ini</code>函数的？</p>
<p>查看局部变量<code>hook</code>被赋值的地方（在 malloc.c 中）：</p>
<pre><code class="hljs cpp"><span class="hljs-number">3021</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*<br><span class="hljs-number">3022</span>&nbsp;&nbsp;&nbsp;&nbsp;__libc_malloc&nbsp;(<span class="hljs-keyword">size_t</span>&nbsp;bytes)<br><span class="hljs-number">3023</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*(*hook)&nbsp;(<span class="hljs-keyword">size_t</span>,&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;*)<br><span class="hljs-number">3031</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;atomic_forced_read&nbsp;(__malloc_hook);<br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3082</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p>从上面的结果中可以看出，局部变量<code>hook</code>被设置为变量<code>__malloc_hook</code>的值。</p>
<p><strong>5）</strong> 变量<code>__malloc_hook</code>是从哪来的？</p>
<p>变量<code>__malloc_hook</code>定义在<code>malloc.c</code>源文件中，如下：</p>
<pre><code class="hljs delphi">void&nbsp;*weak_variable&nbsp;<span class="hljs-comment">(*__malloc_hook)<br>&nbsp;&nbsp;(size_t&nbsp;__size,&nbsp;const&nbsp;void&nbsp;*)</span>&nbsp;=&nbsp;malloc_hook_ini;<br></code></pre>
<p>从上面的结果中可以看出，变量<code>__malloc_hook</code>的值即为<code>malloc_hook_ini</code>函数的地址。从而，局部变量<code>hook</code>的值就是<code>malloc_hook_ini</code>函数的地址。</p>
<p><strong>需要注意的是，变量<code>__malloc_hook</code>是一个全局变量，并且是一个弱符号。</strong></p>
<p>看到这的第一反应是，既然全局变量<code>__malloc_hook</code>是一个弱符号，那么如果我们定义一个同名的全局变量（当然也是一个函数指针）且为强符号，局部变量<code>hook</code>是不是就代表我们所指定的函数。如果猜想正确的话，这意味着我们“拦截了”标准库中的<code>malloc</code>函数。</p>
<p><strong>step 2：</strong> 如何在链接期拦截标准库的<code>malloc</code>函数</p>
<p><strong>1）</strong> 添加拦截代码</p>
<p>先将<code>vm4_main.cpp</code>拷贝一份，并将拷贝文件重命名为<code>vm4_main_2.cpp</code>。</p>
<p>在<code>vm4_main_2.cpp</code>源文件的末尾添加如下代码：</p>
<pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;*<br><span class="hljs-title">my_malloc_hook</span>&nbsp;<span class="hljs-params">(<span class="hljs-keyword">size_t</span>&nbsp;sz,&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;*caller)</span></span>;<br><br><span class="hljs-keyword">void</span>&nbsp;*(*__malloc_hook)&nbsp;(<span class="hljs-keyword">size_t</span>,&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;*)&nbsp;=&nbsp;my_malloc_hook;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;*<br><span class="hljs-title">my_malloc_hook</span>&nbsp;<span class="hljs-params">(<span class="hljs-keyword">size_t</span>&nbsp;sz,&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;*caller)</span><br></span>{<br>&nbsp;&nbsp;__malloc_hook&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br>&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-literal">NULL</span>;<br>}<br></code></pre>
<p><strong>需要注意的是，<code>my_malloc_hook</code>函数在返回前将全局变量<code>__malloc_hook</code>设置为<code>NULL</code>。从而，只会拦截对<code>malloc</code>函数的第一次调用，接下来的调用依然使用标准库中的<code>malloc</code>函数实现。</strong></p>
<p><strong>2）</strong> 编译，并运行可执行目标文件 vm4_main_2</p>
<pre><code class="hljs go">$&nbsp;g++&nbsp;-o&nbsp;vm4_main_2&nbsp;vm4_main_2.cpp&nbsp;-g<br>$&nbsp;gdb&nbsp;-q&nbsp;-x&nbsp;tvm4_1_2.gdb<br>Temporary&nbsp;breakpoint&nbsp;<span class="hljs-number">1</span>&nbsp;at&nbsp;<span class="hljs-number">0x11a9</span>:&nbsp;file&nbsp;vm4_main_2.cpp,&nbsp;line&nbsp;<span class="hljs-number">37.</span><br><br>Temporary&nbsp;breakpoint&nbsp;<span class="hljs-number">1</span>,&nbsp;main&nbsp;(argc=<span class="hljs-number">0</span>,&nbsp;argv=<span class="hljs-number">0x0</span>)&nbsp;at&nbsp;vm4_main_2.cpp:<span class="hljs-number">37</span><br><span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br>Breakpoint&nbsp;<span class="hljs-number">2</span>&nbsp;at&nbsp;<span class="hljs-number">0x7ffff7e5f</span>260:&nbsp;malloc.&nbsp;(<span class="hljs-number">2</span>&nbsp;locations)<br>Breakpoint&nbsp;<span class="hljs-number">3</span>&nbsp;at&nbsp;<span class="hljs-number">0x7ffff7e5edf</span>b:&nbsp;malloc.c:<span class="hljs-number">3033.</span>&nbsp;(<span class="hljs-number">2</span>&nbsp;locations)<br>Breakpoint&nbsp;<span class="hljs-number">4</span>&nbsp;at&nbsp;<span class="hljs-number">0x5555555551dd</span>:&nbsp;file&nbsp;vm4_main_2.cpp,&nbsp;line&nbsp;<span class="hljs-number">39.</span><br></code></pre>
<p>tvm4_1_2.gdb 文件的内容为：</p>
<pre><code class="hljs cpp">file&nbsp;./vm4_main_2<br>start<br>directory&nbsp;/home/workspace/git-projects/glibc<span class="hljs-number">-2.31</span>/<span class="hljs-built_in">malloc</span><br><span class="hljs-built_in">set</span>&nbsp;listsize&nbsp;<span class="hljs-number">20</span><br><br>b&nbsp;<span class="hljs-built_in">malloc</span><br>b&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3033</span><br>b&nbsp;vm4_main_2.cpp:<span class="hljs-number">39</span><br></code></pre>
<p><strong>3）</strong> 继续执行直到 malloc.c:3033 行时停止，并查看局部变量<code>hook</code>的值</p>
<pre><code class="hljs cpp">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">2</span>,&nbsp;__GI___libc_malloc&nbsp;(bytes=<span class="hljs-number">8</span>)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3023</span><br><span class="hljs-number">3023</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br>(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">3</span>,&nbsp;__GI___libc_malloc&nbsp;(bytes=<span class="hljs-number">8</span>)&nbsp;at&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3033</span><br><span class="hljs-number">3033</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*hook)(bytes,&nbsp;RETURN_ADDRESS&nbsp;(<span class="hljs-number">0</span>));<br>(gdb)&nbsp;p&nbsp;hook<br>$<span class="hljs-number">1</span>&nbsp;=&nbsp;(<span class="hljs-keyword">void</span>&nbsp;*(*)(<span class="hljs-keyword">size_t</span>,&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;*))&nbsp;<span class="hljs-number">0x5555555552bb</span>&nbsp;&lt;my_malloc_hook(<span class="hljs-keyword">size_t</span>,&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-keyword">const</span>*)&gt;<br></code></pre>
<p>从上面的结果中可以看出，现在局部变量<code>hook</code>的值变成了我们自定义函数<code>my_malloc_hook</code>的地址。也就是说，我们成功地在链接期拦截了标准库中的<code>malloc</code>函数。</p>
<p><strong><font size="4">研究结论：</font></strong></p>
<ul>
<li><p>在链接期拦截标准库<code>malloc</code>函数的工作原理？</p>
<p>glibc 中的<code>malloc</code>函数在第一次真正地为用户分配堆内存之前，会调用一个钩子函数。这个钩子函数的地址保存在全局变量<code>__malloc_hook</code>中，并且 glibc 中所定义的<code>__malloc_hook</code>默认是一个弱符号。因此，我们可以利用 Linux 系统中链接器的符号解析规则，即通过定义一个同名的全局变量<code>__malloc_hook</code>（当然也是一个函数指针）且为强符号，从而达到拦截标准库的<code>malloc</code>函数的效果。</p>
<p>同样地，我们可以通过<code>__free_hook</code>在链接期拦截标准库的<code>free</code>函数。</p></li>
</ul>
<hr>
<h3 id="hspanidjump1_2chunkspan"><span><span id="jump1_2">chunk 的大小有哪些讲究</span></span></h3>
<p><strong><font size="4">研究过程：</font></strong></p>
<p><strong>step 1：</strong> 问题引入</p>
<p>无论是否开启<code>tcache</code>机制，glibc 中的<code>malloc</code>函数所分配的<code>chunk</code>的大小都可能经过内部调整。也就是说，用户数据所在的<code>chunk</code>的大小不是简单地将用户数据大小与<code>chunk</code>头部大小相加之和。用于确定<code>chunk</code>大小的函数是<code>checked_request2size</code>。</p>
<p><code>_int_malloc</code>函数中调用<code>checked_request2size</code>的附近代码：</p>
<pre><code class="hljs cpp"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;*<br>_int_malloc&nbsp;(mstate&nbsp;av,&nbsp;<span class="hljs-keyword">size_t</span>&nbsp;bytes)<br>{<br>&nbsp;&nbsp;INTERNAL_SIZE_T&nbsp;nb;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;normalized&nbsp;request&nbsp;size&nbsp;*/</span><br><span class="hljs-comment">//&nbsp;省略...</span><br><br>&nbsp;&nbsp;<span class="hljs-comment">/*<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Convert&nbsp;request&nbsp;size&nbsp;to&nbsp;internal&nbsp;form&nbsp;by&nbsp;adding&nbsp;SIZE_SZ&nbsp;bytes<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;overhead&nbsp;plus&nbsp;possibly&nbsp;more&nbsp;to&nbsp;obtain&nbsp;necessary&nbsp;alignment&nbsp;and/or<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;obtain&nbsp;a&nbsp;size&nbsp;of&nbsp;at&nbsp;least&nbsp;MINSIZE,&nbsp;the&nbsp;smallest&nbsp;allocatable<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size.&nbsp;Also,&nbsp;checked_request2size&nbsp;returns&nbsp;false&nbsp;for&nbsp;request&nbsp;sizes<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;are&nbsp;so&nbsp;large&nbsp;that&nbsp;they&nbsp;wrap&nbsp;around&nbsp;zero&nbsp;when&nbsp;padded&nbsp;and<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aligned.<br>&nbsp;&nbsp;&nbsp;*/</span><br><br>&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!checked_request2size&nbsp;(bytes,&nbsp;&amp;nb))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__set_errno&nbsp;(ENOMEM);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-literal">NULL</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-comment">//&nbsp;省略...</span><br>}<br></code></pre>
<p><strong>step 2：</strong> 函数<code>checked_request2size</code>的作用？</p>
<p><strong>1）</strong> 查看函数<code>checked_request2size</code>的定义（在 malloc.c 中）</p>
<pre><code class="hljs vbscript">/*&nbsp;Check&nbsp;<span class="hljs-keyword">if</span>&nbsp;REQ&nbsp;overflows&nbsp;when&nbsp;padded&nbsp;<span class="hljs-keyword">and</span>&nbsp;aligned&nbsp;<span class="hljs-keyword">and</span>&nbsp;<span class="hljs-keyword">if</span>&nbsp;the&nbsp;resulting&nbsp;value<br>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">is</span>&nbsp;less&nbsp;than&nbsp;PTRDIFF_T.&nbsp;&nbsp;Returns&nbsp;<span class="hljs-literal">TRUE</span>&nbsp;<span class="hljs-keyword">and</span>&nbsp;the&nbsp;requested&nbsp;size&nbsp;<span class="hljs-keyword">or</span>&nbsp;MINSIZE&nbsp;<span class="hljs-keyword">in</span><br>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">case</span>&nbsp;the&nbsp;value&nbsp;<span class="hljs-keyword">is</span>&nbsp;less&nbsp;than&nbsp;MINSIZE&nbsp;<span class="hljs-keyword">on</span>&nbsp;SZ&nbsp;<span class="hljs-keyword">or</span>&nbsp;<span class="hljs-literal">false</span>&nbsp;<span class="hljs-keyword">if</span>&nbsp;any&nbsp;of&nbsp;the&nbsp;previous<br>&nbsp;&nbsp;&nbsp;check&nbsp;fail.&nbsp;&nbsp;*/<br>static&nbsp;inline&nbsp;bool<br>checked_request2size&nbsp;(size_t&nbsp;req,&nbsp;size_t&nbsp;*sz)&nbsp;__nonnull&nbsp;(<span class="hljs-number">1</span>)<br>{<br>&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(__glibc_unlikely&nbsp;(req&nbsp;&gt;&nbsp;PTRDIFF_MAX))<br>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;<span class="hljs-literal">false</span>;<br>&nbsp;&nbsp;*sz&nbsp;=&nbsp;request2size&nbsp;(req);<br>&nbsp;&nbsp;return&nbsp;<span class="hljs-literal">true</span>;<br>}<br></code></pre>
<p><strong>2）</strong> 查看<code>PTRDIFF_MAX</code>的定义（在 stdint.h 中）</p>
<pre><code class="hljs cpp"><span class="hljs-comment">/*&nbsp;Limits&nbsp;of&nbsp;`ptrdiff_t'&nbsp;type.&nbsp;&nbsp;*/</span><br><span class="hljs-meta">#&nbsp;<span class="hljs-meta-keyword">if</span>&nbsp;__WORDSIZE&nbsp;==&nbsp;64</span><br><span class="hljs-meta">#&nbsp;&nbsp;<span class="hljs-meta-keyword">define</span>&nbsp;PTRDIFF_MIN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(-9223372036854775807L-1)</span><br><span class="hljs-meta">#&nbsp;&nbsp;<span class="hljs-meta-keyword">define</span>&nbsp;PTRDIFF_MAX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(9223372036854775807L)</span><br><span class="hljs-meta">#&nbsp;<span class="hljs-meta-keyword">else</span></span><br><span class="hljs-comment">//&nbsp;省略...</span><br></code></pre>
<p>从上面的结果中可以看出，<code>PTRDIFF_MAX</code>的值为 9223372036854775807L（在 64-bit 系统上），表示一个占用八字节（在 64-bit 系统上）的有符号整型的最大值（<code>9223372036854775807 = 1024*1024*1024*1024*1024*1024*8-1</code>）。</p>
<p><strong>3）</strong> 查看函数<code>request2size</code>的定义（在 malloc.c 中）</p>
<pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;request2size(req)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>&nbsp;&nbsp;(((req)&nbsp;+&nbsp;SIZE_SZ&nbsp;+&nbsp;MALLOC_ALIGN_MASK&nbsp;&lt;&nbsp;MINSIZE)&nbsp;&nbsp;?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>&nbsp;&nbsp;&nbsp;MINSIZE&nbsp;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>&nbsp;&nbsp;&nbsp;((req)&nbsp;+&nbsp;SIZE_SZ&nbsp;+&nbsp;MALLOC_ALIGN_MASK)&nbsp;&amp;&nbsp;~MALLOC_ALIGN_MASK)</span><br></code></pre>
<p><strong>4）</strong> 查看<code>SIZE_SZ</code>和<code>MALLOC_ALIGN_MASK</code>的定义（在 malloc-internal.h 中）</p>
<pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span>&nbsp;INTERNAL_SIZE_T</span><br><span class="hljs-meta">#&nbsp;<span class="hljs-meta-keyword">define</span>&nbsp;INTERNAL_SIZE_T&nbsp;size_t</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br><span class="hljs-comment">/*&nbsp;The&nbsp;corresponding&nbsp;word&nbsp;size.&nbsp;&nbsp;*/</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;SIZE_SZ&nbsp;(sizeof&nbsp;(INTERNAL_SIZE_T))</span><br><br><span class="hljs-comment">/*&nbsp;The&nbsp;corresponding&nbsp;bit&nbsp;mask&nbsp;value.&nbsp;&nbsp;*/</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;MALLOC_ALIGN_MASK&nbsp;(MALLOC_ALIGNMENT&nbsp;-&nbsp;1)</span><br></code></pre>
<p>注：在 64-bit 系统上，<code>SIZE_SZ</code>的值为 8（字节）。</p>
<p>其中，<code>MALLOC_ALIGNMENT</code>的定义（在 malloc-alignment.h 中）为：</p>
<pre><code class="hljs vbnet">/*&nbsp;MALLOC_ALIGNMENT&nbsp;<span class="hljs-keyword">is</span>&nbsp;the&nbsp;minimum&nbsp;alignment&nbsp;<span class="hljs-keyword">for</span>&nbsp;malloc<span class="hljs-comment">'ed&nbsp;chunks.&nbsp;&nbsp;It</span><br>&nbsp;&nbsp;&nbsp;must&nbsp;be&nbsp;a&nbsp;power&nbsp;<span class="hljs-keyword">of</span>&nbsp;two&nbsp;at&nbsp;least&nbsp;<span class="hljs-number">2</span>&nbsp;*&nbsp;SIZE_SZ,&nbsp;even&nbsp;<span class="hljs-keyword">on</span>&nbsp;machines&nbsp;<span class="hljs-keyword">for</span><br>&nbsp;&nbsp;&nbsp;which&nbsp;smaller&nbsp;alignments&nbsp;would&nbsp;suffice.&nbsp;It&nbsp;may&nbsp;be&nbsp;defined&nbsp;<span class="hljs-keyword">as</span>&nbsp;larger<br>&nbsp;&nbsp;&nbsp;than&nbsp;this&nbsp;though.&nbsp;Note&nbsp;however&nbsp;that&nbsp;code&nbsp;<span class="hljs-keyword">and</span>&nbsp;data&nbsp;structures&nbsp;are<br>&nbsp;&nbsp;&nbsp;optimized&nbsp;<span class="hljs-keyword">for</span>&nbsp;the&nbsp;<span class="hljs-keyword">case</span>&nbsp;<span class="hljs-keyword">of</span>&nbsp;<span class="hljs-number">8</span>-<span class="hljs-built_in">byte</span>&nbsp;alignment.&nbsp;&nbsp;*/<br><span class="hljs-meta">#define&nbsp;MALLOC_ALIGNMENT&nbsp;(2&nbsp;*&nbsp;SIZE_SZ&nbsp;&lt;&nbsp;__alignof__&nbsp;(long&nbsp;double)&nbsp;\</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?&nbsp;__alignof__&nbsp;(<span class="hljs-built_in">long</span>&nbsp;<span class="hljs-built_in">double</span>)&nbsp;:&nbsp;<span class="hljs-number">2</span>&nbsp;*&nbsp;SIZE_SZ)<br></code></pre>
<p>注：在 64-bit 系统上，<code>long double</code>类型的对象占用 16 字节。</p>
<p>因此，在 64-bit 系统上，<code>MALLOC_ALIGNMENT</code>的值为 16（字节）。相应地，<code>MALLOC_ALIGN_MASK</code>的值为 0xf。</p>
<p><strong>5）</strong> 查看<code>MINSIZE</code>的定义（在 malloc.c 中）</p>
<pre><code class="hljs cs"><span class="hljs-comment">/*&nbsp;The&nbsp;smallest&nbsp;possible&nbsp;chunk&nbsp;*/</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;MIN_CHUNK_SIZE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(offsetof(struct&nbsp;malloc_chunk,&nbsp;fd_nextsize))</span><br><br><span class="hljs-comment">/*&nbsp;The&nbsp;smallest&nbsp;size&nbsp;we&nbsp;can&nbsp;malloc&nbsp;is&nbsp;an&nbsp;aligned&nbsp;minimal&nbsp;chunk&nbsp;*/</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;MINSIZE&nbsp;&nbsp;\</span><br>&nbsp;&nbsp;(unsigned&nbsp;<span class="hljs-keyword">long</span>)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK)&nbsp;&amp;&nbsp;~MALLOC_ALIGN_MASK))<br></code></pre>
<p>在 64-bit 系统上，字段<code>fd_nextsize</code>相对于结构体<code>struct malloc_chunk</code>起始位置的偏移量为 32（字节）。因此，在 64-bit 系统上，<code>MIN_CHUNK_SIZE</code>的值为 32。</p>
<p>所以，在 64-bit 系统上，<code>MINSIZE</code>的值为 ((32 + 0xf) &amp; ~0xf)，等于 0x20。</p>
<p>因此，我们可以推断，<strong><code>request2size(req)</code>的作用为（仅限于在 64-bit 系统上）：</strong></p>
<ul>
<li><p>如果用户所申请的堆内存大小 &lt;= 8 字节，那么<code>malloc</code>函数实际分配的<code>chunk</code>（包含了用户数据）的大小为 32 字节。这意味用户实际可以使用的内存大小是 16 字节，并且是完全合法的（不会破坏下一个<code>chunk</code>的内存数据）。</p></li>
<li><p>如果用户所申请的堆内存大小 &gt; 8 字节，那么<code>malloc</code>函数实际分配的<code>chunk</code>（包含了用户数据）的大小为 16 字节的整数倍，但不小于 32 字节。</p></li>
</ul>
<p>所以，<strong><code>malloc</code>函数中，<code>checked_request2size (bytes, &amp;tbytes)</code>的作用为：</strong></p>
<ul>
<li><p>检查用户所申请的堆内存大小是否大于上限值。如果是，那么该函数返回<code>false</code>。从而，导致<code>errno</code>的值被设置为错误码<code>ENOMEM</code>。</p></li>
<li><p>将用户所申请的堆内存大小（即参数<code>bytes</code>的值）进行内存对齐处理，最终的<code>chunk</code>大小保存在变量<code>tbytes</code>中。在 64-bit 系统上，实际分配<code>chunk</code>的大小同时满足：1）大小为 16 字节的整数倍；2）大小 &gt;= 32 字节。</p></li>
</ul>
<p>这就解释了上一篇中的遗留问题：<code>obj1.data_</code>所在<code>chunk</code>的内存布局中尾部八字节的作用，即用来凑够 64-bit 系统中最小<code>chunk</code>的大小。</p>
<p><strong><font size="4">研究结论：</font></strong></p>
<p>在 64-bit 系统上，glibc 中的<code>malloc</code>函数所分配的<code>chunk</code>的大小必须同时满足：1）<code>chunk</code>的大小 &gt;= 32 字节；2）<code>chunk</code>的大小为 16 字节的整数倍。</p>
<hr>
<h3 id="hspanidjump2malloc_statespan"><span><span id="jump2">理解 malloc_state 结构体中各字段的意义</span></span></h3>
<p><strong><font size="4">研究过程：</font></strong></p>
<p><strong>step 0：</strong> 查看结构体<code>malloc_state</code>的定义（在 malloc.c 中）</p>
<pre><code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword">struct</span>&nbsp;<span class="hljs-title">malloc_state</span><br>{</span><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Serialize&nbsp;access.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;__libc_lock_define&nbsp;(,&nbsp;mutex);<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Flags&nbsp;(formerly&nbsp;in&nbsp;max_fast).&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;flags;<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Set&nbsp;if&nbsp;the&nbsp;fastbin&nbsp;chunks&nbsp;contain&nbsp;recently&nbsp;inserted&nbsp;free&nbsp;blocks.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Note&nbsp;this&nbsp;is&nbsp;a&nbsp;bool&nbsp;but&nbsp;not&nbsp;all&nbsp;targets&nbsp;support&nbsp;atomics&nbsp;on&nbsp;booleans.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;have_fastchunks;<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Fastbins&nbsp;*/</span><br>&nbsp;&nbsp;mfastbinptr&nbsp;fastbinsY[NFASTBINS];<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Base&nbsp;of&nbsp;the&nbsp;topmost&nbsp;chunk&nbsp;--&nbsp;not&nbsp;otherwise&nbsp;kept&nbsp;in&nbsp;a&nbsp;bin&nbsp;*/</span><br>&nbsp;&nbsp;mchunkptr&nbsp;top;<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;The&nbsp;remainder&nbsp;from&nbsp;the&nbsp;most&nbsp;recent&nbsp;split&nbsp;of&nbsp;a&nbsp;small&nbsp;request&nbsp;*/</span><br>&nbsp;&nbsp;mchunkptr&nbsp;last_remainder;<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Normal&nbsp;bins&nbsp;packed&nbsp;as&nbsp;described&nbsp;above&nbsp;*/</span><br>&nbsp;&nbsp;mchunkptr&nbsp;bins[NBINS&nbsp;*&nbsp;<span class="hljs-number">2</span>&nbsp;-&nbsp;<span class="hljs-number">2</span>];<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Bitmap&nbsp;of&nbsp;bins&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">int</span>&nbsp;binmap[BINMAPSIZE];<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Linked&nbsp;list&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-class"><span class="hljs-keyword">struct</span>&nbsp;<span class="hljs-title">malloc_state</span>&nbsp;*<span class="hljs-title">next</span>;</span><br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Linked&nbsp;list&nbsp;for&nbsp;free&nbsp;arenas.&nbsp;&nbsp;Access&nbsp;to&nbsp;this&nbsp;field&nbsp;is&nbsp;serialized<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;by&nbsp;free_list_lock&nbsp;in&nbsp;arena.c.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-class"><span class="hljs-keyword">struct</span>&nbsp;<span class="hljs-title">malloc_state</span>&nbsp;*<span class="hljs-title">next_free</span>;</span><br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Number&nbsp;of&nbsp;threads&nbsp;attached&nbsp;to&nbsp;this&nbsp;arena.&nbsp;&nbsp;0&nbsp;if&nbsp;the&nbsp;arena&nbsp;is&nbsp;on<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;free&nbsp;list.&nbsp;&nbsp;Access&nbsp;to&nbsp;this&nbsp;field&nbsp;is&nbsp;serialized&nbsp;by<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free_list_lock&nbsp;in&nbsp;arena.c.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;INTERNAL_SIZE_T&nbsp;attached_threads;<br><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Memory&nbsp;allocated&nbsp;from&nbsp;the&nbsp;system&nbsp;in&nbsp;this&nbsp;arena.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;INTERNAL_SIZE_T&nbsp;system_mem;<br>&nbsp;&nbsp;INTERNAL_SIZE_T&nbsp;max_system_mem;<br>};<br></code></pre>
<p><strong>step 1：</strong> 结构体<code>malloc_state</code>中，数据成员<code>top</code>的作用？</p>
<p><strong>1）</strong> 查看数据成员<code>top</code>的注释</p>
<pre><code class="hljs cpp"><span class="hljs-comment">/*&nbsp;Base&nbsp;of&nbsp;the&nbsp;topmost&nbsp;chunk&nbsp;--&nbsp;not&nbsp;otherwise&nbsp;kept&nbsp;in&nbsp;a&nbsp;bin&nbsp;*/</span><br>mchunkptr&nbsp;top;<br></code></pre>
<p>从上面的注释中可以得出如下两个信息：</p>
<ul>
<li><p>数据成员<code>top</code>的值为最顶部<code>chunk</code>的起始位置。</p></li>
<li><p>最顶部<code>chunk</code>不属于任何一个<code>bin</code>。</p></li>
</ul>
<p>在<code>obj1</code>对象申请堆内存后，数据成员<code>top</code>的值从 0x0 变成了 0x5555555592b0。</p>
<p><strong>2）</strong> 查看内存地址为 0x5555555592b0 附近的数据</p>
<pre><code class="hljs makefile">(gdb)&nbsp;x/8gx&nbsp;0x5555555592b0-8*4<br><span class="hljs-section">0x555555559290:&nbsp;&nbsp;&nbsp;&nbsp;0x0000000000000000&nbsp;&nbsp;0x0000000000000021</span><br><span class="hljs-section">0x5555555592a0:&nbsp;&nbsp;&nbsp;&nbsp;0x0101010101010101&nbsp;&nbsp;0x0000000000000000</span><br><span class="hljs-section">0x5555555592b0:&nbsp;&nbsp;&nbsp;&nbsp;0x0000000000000000&nbsp;&nbsp;0x0000000000020d51</span><br><span class="hljs-section">0x5555555592c0:&nbsp;&nbsp;&nbsp;&nbsp;0x0000000000000000&nbsp;&nbsp;0x0000000000000000</span><br></code></pre>
<p>结合我们在上一篇中所分析的<code>obj1.data_</code>所在<code>chunk</code>的内存布局，我们可以推断，<strong>结构体<code>malloc_state</code>中的数据成员<code>top</code>的作用为：</strong>指向堆顶<code>chunk</code>的起始位置。</p>
<p><strong>step 2：</strong> 结构体<code>malloc_state</code>中，数据成员<code>system_mem</code>的作用？</p>
<p><strong>1）</strong> 查看数据成员<code>system_mem</code>的注释</p>
<pre><code class="hljs cpp"><span class="hljs-comment">/*&nbsp;Memory&nbsp;allocated&nbsp;from&nbsp;the&nbsp;system&nbsp;in&nbsp;this&nbsp;arena.&nbsp;&nbsp;*/</span><br>INTERNAL_SIZE_T&nbsp;system_mem;<br></code></pre>
<p>从上面的注释中可以得出，数据成员<code>system_mem</code>的值表示系统为这个<code>arena</code>分配的内存大小。</p>
<p><strong>2）</strong> 查看数据成员<code>system_mem</code>的值</p>
<p>在<code>obj1</code>对象申请堆内存后，数据成员<code>system_mem</code>的值从 0 变成了 135168。</p>
<p>十进制 135168 对应的十六进制为：</p>
<pre><code class="hljs bash">(gdb)&nbsp;p/x&nbsp;135168<br><span class="hljs-variable">$6</span>&nbsp;=&nbsp;0x21000<br></code></pre>
<p>在上一篇中分析<code>obj1.data_</code>所在<code>chunk</code>的内存布局时，堆的初始大小也是 0x21000 字节。</p>
<p><strong>3）</strong> 这里，再次查看堆的大小</p>
<pre><code class="hljs sql">(gdb)&nbsp;i&nbsp;proc&nbsp;mappings&nbsp;<br>process&nbsp;354872<br>Mapped&nbsp;address&nbsp;spaces:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">Start</span>&nbsp;Addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">End</span>&nbsp;Addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">Offset</span>&nbsp;objfile<br>//&nbsp;省略...<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x555555559000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x55555557a000</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x21000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x0</span>&nbsp;[<span class="hljs-keyword">heap</span>]<br>//&nbsp;省略...<br></code></pre>
<p>从上面的结果中可以看出，这次堆的大小仍是 0x21000 字节。</p>
<p>因此，我们可以推断，<strong>结构体<code>malloc_state</code>中的数据成员<code>system_mem</code>的作用为：</strong>保存堆的大小（包括已分配的和空闲的）。</p>
<p><strong><font size="4">研究结论：</font></strong></p>
<p>结构体<code>malloc_state</code>中各字段的意义如下表：</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>类型</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>top</td>
<td>struct malloc_chunk*</td>
<td>指向堆顶<code>chunk</code>的起始位置</td>
</tr>
<tr>
<td>system_mem</td>
<td>INTERNAL_SIZE_T</td>
<td>保存堆的大小（包括已分配的和空闲的）</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="hspanidjump3tcachespan"><span><span id="jump3">理解 tcache 机制</span></span></h3>
<ul>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump3_1">引入 tcache 机制的动机</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump3_2">如何打开和关闭 tcache 机制</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump3_2_1">理解 tcache_perthread_struct 结构体中各字段的意义</a></p>
</ul>
<hr>
<h4 id="hspanidjump3_1fontsize4tcachefontspan"><span><span id="jump3_1"><font size="4">引入 tcache 机制的动机</font></span></span></h4>
<p>glibc 中关于<code>tcache</code>（全称为<code>per-thread cache</code>）特性的说明如下（在 NEWS 文件中）：</p>
<pre><code class="hljs vbnet">Version&nbsp;<span class="hljs-number">2.26</span><br><br>Major&nbsp;<span class="hljs-keyword">new</span>&nbsp;features:<br><br>*&nbsp;A&nbsp;per-thread&nbsp;cache&nbsp;has&nbsp;been&nbsp;added&nbsp;<span class="hljs-keyword">to</span>&nbsp;malloc.&nbsp;Access&nbsp;<span class="hljs-keyword">to</span>&nbsp;the&nbsp;cache&nbsp;requires<br>&nbsp;&nbsp;no&nbsp;locks&nbsp;<span class="hljs-keyword">and</span>&nbsp;therefore&nbsp;significantly&nbsp;accelerates&nbsp;the&nbsp;fast&nbsp;path&nbsp;<span class="hljs-keyword">to</span>&nbsp;allocate<br>&nbsp;&nbsp;<span class="hljs-keyword">and</span>&nbsp;free&nbsp;small&nbsp;amounts&nbsp;<span class="hljs-keyword">of</span>&nbsp;memory.&nbsp;Refilling&nbsp;an&nbsp;empty&nbsp;cache&nbsp;requires&nbsp;locking<br>&nbsp;&nbsp;the&nbsp;underlying&nbsp;arena.&nbsp;Performance&nbsp;measurements&nbsp;show&nbsp;significant&nbsp;gains&nbsp;<span class="hljs-keyword">in</span>&nbsp;a<br>&nbsp;&nbsp;wide&nbsp;variety&nbsp;<span class="hljs-keyword">of</span>&nbsp;user&nbsp;workloads.&nbsp;Workloads&nbsp;were&nbsp;captured&nbsp;<span class="hljs-keyword">using</span>&nbsp;a&nbsp;special<br>&nbsp;&nbsp;instrumented&nbsp;malloc&nbsp;<span class="hljs-keyword">and</span>&nbsp;analyzed&nbsp;<span class="hljs-keyword">with</span>&nbsp;a&nbsp;malloc&nbsp;simulator.&nbsp;Contributed&nbsp;<span class="hljs-keyword">by</span><br>&nbsp;&nbsp;DJ&nbsp;Delorie&nbsp;<span class="hljs-keyword">with</span>&nbsp;the&nbsp;help&nbsp;<span class="hljs-keyword">of</span>&nbsp;Florian&nbsp;Weimer,&nbsp;<span class="hljs-keyword">and</span>&nbsp;Carlos&nbsp;O<span class="hljs-comment">'Donell.</span><br></code></pre>
<p>从上面的说明中，我们可以推断，引入<code>tcache</code>是为了改善分配和释放较小内存块的性能。</p>
<p><a href="#jump3">返回上一级</a></p>
<hr>
<h4 id="hspanidjump3_2fontsize4tcachefontspan"><span><span id="jump3_2"><font size="4">如何打开和关闭 tcache 机制</font></span></span></h4>
<p>编译期打开<code>tcache</code>机制的方法：编译 glibc 时，添加编译选项<code>-DUSE_TCACHE</code>。这样做是因为，<code>tcache</code>相关的代码都定义在自定义的<code>USE_TCACHE</code>预处理命令中。</p>
<p><a href="#jump3">返回上一级</a></p>
<hr>
<h4 id="hspanidjump3_2_1fontsize4tcache_perthread_structfontspan"><span><span id="jump3_2_1"><font size="4">理解 tcache_perthread_struct 结构体中各字段的意义</font></span></span></h4>
<p><strong><font size="4">研究过程：</font></strong></p>
<p><strong>step 0：</strong> 查看结构体<code>tcache_perthread_struct</code>的定义</p>
<pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span>&nbsp;USE_TCACHE</span><br><br><span class="hljs-comment">//&nbsp;省略...</span><br><br><span class="hljs-comment">/*&nbsp;There&nbsp;is&nbsp;one&nbsp;of&nbsp;these&nbsp;for&nbsp;each&nbsp;thread,&nbsp;which&nbsp;contains&nbsp;the<br>&nbsp;&nbsp;&nbsp;per-thread&nbsp;cache&nbsp;(hence&nbsp;"tcache_perthread_struct").&nbsp;&nbsp;Keeping<br>&nbsp;&nbsp;&nbsp;overall&nbsp;size&nbsp;low&nbsp;is&nbsp;mildly&nbsp;important.&nbsp;&nbsp;Note&nbsp;that&nbsp;COUNTS&nbsp;and&nbsp;ENTRIES<br>&nbsp;&nbsp;&nbsp;are&nbsp;redundant&nbsp;(we&nbsp;could&nbsp;have&nbsp;just&nbsp;counted&nbsp;the&nbsp;linked&nbsp;list&nbsp;each<br>&nbsp;&nbsp;&nbsp;time),&nbsp;this&nbsp;is&nbsp;for&nbsp;performance&nbsp;reasons.&nbsp;&nbsp;*/</span><br><span class="hljs-keyword">typedef</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">struct</span>&nbsp;<span class="hljs-title">tcache_perthread_struct</span><br>{</span><br>&nbsp;&nbsp;<span class="hljs-keyword">uint16_t</span>&nbsp;counts[TCACHE_MAX_BINS];<br>&nbsp;&nbsp;tcache_entry&nbsp;*entries[TCACHE_MAX_BINS];<br>}&nbsp;tcache_perthread_struct;<br><br><span class="hljs-comment">//&nbsp;省略...</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;<span class="hljs-comment">/*&nbsp;!USE_TCACHE&nbsp;&nbsp;*/</span></span><br></code></pre>
<p><strong>step 1：</strong> 结构体<code>tcache_perthread_struct</code>中，数据成员<code>counts</code>和<code>entries</code>的作用？</p>
<p><strong>1）</strong> 查看结构体<code>tcache_entry</code>的定义</p>
<pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span>&nbsp;USE_TCACHE</span><br><br><span class="hljs-comment">/*&nbsp;We&nbsp;overlay&nbsp;this&nbsp;structure&nbsp;on&nbsp;the&nbsp;user-data&nbsp;portion&nbsp;of&nbsp;a&nbsp;chunk&nbsp;when<br>&nbsp;&nbsp;&nbsp;the&nbsp;chunk&nbsp;is&nbsp;stored&nbsp;in&nbsp;the&nbsp;per-thread&nbsp;cache.&nbsp;&nbsp;*/</span><br><span class="hljs-keyword">typedef</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">struct</span>&nbsp;<span class="hljs-title">tcache_entry</span><br>{</span><br>&nbsp;&nbsp;<span class="hljs-class"><span class="hljs-keyword">struct</span>&nbsp;<span class="hljs-title">tcache_entry</span>&nbsp;*<span class="hljs-title">next</span>;</span><br>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;This&nbsp;field&nbsp;exists&nbsp;to&nbsp;detect&nbsp;double&nbsp;frees.&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;<span class="hljs-class"><span class="hljs-keyword">struct</span>&nbsp;<span class="hljs-title">tcache_perthread_struct</span>&nbsp;*<span class="hljs-title">key</span>;</span><br>}&nbsp;tcache_entry;<br><br><span class="hljs-comment">//&nbsp;省略...</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;<span class="hljs-comment">/*&nbsp;!USE_TCACHE&nbsp;&nbsp;*/</span></span><br></code></pre>
<p>从上面的源码和注释，我们可以先这样理解（不一定正确）：</p>
<ul>
<li><p>结构体<code>tcache_entry</code>中的<code>next</code>字段的意义：指向链表的下一个元素。</p></li>
<li><p>结构体<code>tcache_entry</code>中的<code>key</code>字段的意义：用于检查是否重复释放。</p></li>
</ul>
<p><strong>2）</strong> 分析结构体<code>tcache_entry</code>中<code>next</code>和<code>key</code>字段的意义</p>
<p>结构体<code>tcache_entry</code>中的<code>key</code>字段在 malloc.c 源文件中，由以下三个函数调用了，分别是：<code>_int_free</code>、<code>tcache_put</code>、<code>tcache_get</code>。</p>
<p>a）结构体<code>tcache_entry</code>中的<code>key</code>字段在<code>tcache_put</code>函数中被调用的代码部分</p>
<pre><code class="hljs php"><span class="hljs-number">2915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Caller&nbsp;must&nbsp;ensure&nbsp;that&nbsp;we&nbsp;know&nbsp;tc_idx&nbsp;is&nbsp;valid&nbsp;and&nbsp;there's&nbsp;room<br>2916&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;more&nbsp;chunks.&nbsp;&nbsp;*/</span><br><span class="hljs-number">2917</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">static</span>&nbsp;__always_inline&nbsp;void<br><span class="hljs-number">2918</span>&nbsp;&nbsp;&nbsp;&nbsp;tcache_put&nbsp;(mchunkptr&nbsp;chunk,&nbsp;size_t&nbsp;tc_idx)<br><span class="hljs-number">2919</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">2920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcache_entry&nbsp;*e&nbsp;=&nbsp;(tcache_entry&nbsp;*)&nbsp;chunk2mem&nbsp;(chunk);<br><span class="hljs-number">2921</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">2922</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Mark&nbsp;this&nbsp;chunk&nbsp;as&nbsp;"in&nbsp;the&nbsp;tcache"&nbsp;so&nbsp;the&nbsp;test&nbsp;in&nbsp;_int_free&nbsp;will<br>2923&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;detect&nbsp;a&nbsp;double&nbsp;free.&nbsp;&nbsp;*/</span><br><span class="hljs-number">2924</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e-&gt;key&nbsp;=&nbsp;tcache;<br><span class="hljs-number">2925</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">2926</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e-&gt;next&nbsp;=&nbsp;tcache-&gt;entries[tc_idx];<br><span class="hljs-number">2927</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcache-&gt;entries[tc_idx]&nbsp;=&nbsp;e;<br><span class="hljs-number">2928</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++(tcache-&gt;counts[tc_idx]);<br><span class="hljs-number">2929</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p>从上面的源码和注释，我们可以得出如下几个结论：</p>
<ul>
<li><p>从第 2920 和 2927 行可以看出，结构体<code>tcache_perthread_struct</code>中数据成员<code>entries</code>的作用为：维护已释放的<code>chunk</code>，并且其中元素的值为“用户数据”（已过时）的起始地址。</p></li>
<li><p>从第 2922~2924 行可以看出，结构体<code>tcache_entry</code>中的<code>key</code>字段的意义为：将该值设置为<code>tcache</code>变量的值，表示该<code>chunk</code>已经在<code>tcache</code>中被维护了，用于检查一个<code>chunk</code>是否重复释放。</p></li>
<li><p>从第 2926~2927 行可以看出，结构体<code>tcache_perthread_struct</code>中数据成员<code>entries</code>的每个元素的值指向各自单向链表的头节点，并且这些链表采用头插法添加新节点。</p></li>
<li><p>从第 2928 行可以看出，结构体<code>tcache_perthread_struct</code>中数据成员<code>counts</code>的作用为：<code>tcache</code>中每个链表中的节点数量。</p></li>
</ul>
<p>b）结构体<code>tcache_entry</code>中的<code>key</code>字段在<code>tcache_get</code>函数中被调用的代码部分</p>
<pre><code class="hljs php"><span class="hljs-number">2931</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Caller&nbsp;must&nbsp;ensure&nbsp;that&nbsp;we&nbsp;know&nbsp;tc_idx&nbsp;is&nbsp;valid&nbsp;and&nbsp;there's<br>2932&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;available&nbsp;chunks&nbsp;to&nbsp;remove.&nbsp;&nbsp;*/</span><br><span class="hljs-number">2933</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">static</span>&nbsp;__always_inline&nbsp;void&nbsp;*<br><span class="hljs-number">2934</span>&nbsp;&nbsp;&nbsp;&nbsp;tcache_get&nbsp;(size_t&nbsp;tc_idx)<br><span class="hljs-number">2935</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">2936</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcache_entry&nbsp;*e&nbsp;=&nbsp;tcache-&gt;entries[tc_idx];<br><span class="hljs-number">2937</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcache-&gt;entries[tc_idx]&nbsp;=&nbsp;e-&gt;next;<br><span class="hljs-number">2938</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--(tcache-&gt;counts[tc_idx]);<br><span class="hljs-number">2939</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e-&gt;key&nbsp;=&nbsp;<span class="hljs-keyword">NULL</span>;<br><span class="hljs-number">2940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(void&nbsp;*)&nbsp;e;<br><span class="hljs-number">2941</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p><code>tcache_get</code>函数的解释：从<code>tcache</code>中的某个链表中取出头节点，并作为已分配块返回给用户。在返回之前做了三件事：更新链表的头节点；更新链表中的节点数量；将<code>key</code>字段的值设置为<code>NULL</code>，表示该<code>chunk</code>不被<code>tcache</code>维护了。</p>
<p>c）结构体<code>tcache_entry</code>中的<code>key</code>字段在<code>_int_free</code>函数中被调用的代码部分</p>
<pre><code class="hljs cpp"><span class="hljs-number">4153</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span><br><span class="hljs-number">4154</span>&nbsp;&nbsp;&nbsp;&nbsp;_int_free&nbsp;(mstate&nbsp;av,&nbsp;mchunkptr&nbsp;p,&nbsp;<span class="hljs-keyword">int</span>&nbsp;have_lock)<br><span class="hljs-number">4155</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">4156</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTERNAL_SIZE_T&nbsp;size;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;its&nbsp;size&nbsp;*/</span><br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">4165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size&nbsp;=&nbsp;chunksize&nbsp;(p);<br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">4181</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span>&nbsp;USE_TCACHE</span><br><span class="hljs-number">4182</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">4183</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">size_t</span>&nbsp;tc_idx&nbsp;=&nbsp;csize2tidx&nbsp;(size);<br><span class="hljs-number">4184</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(tcache&nbsp;!=&nbsp;<span class="hljs-literal">NULL</span>&nbsp;&amp;&amp;&nbsp;tc_idx&nbsp;&lt;&nbsp;mp_.tcache_bins)<br><span class="hljs-number">4185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">4186</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;Check&nbsp;to&nbsp;see&nbsp;if&nbsp;it's&nbsp;already&nbsp;in&nbsp;the&nbsp;tcache.&nbsp;&nbsp;*/</span><br><span class="hljs-number">4187</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcache_entry&nbsp;*e&nbsp;=&nbsp;(tcache_entry&nbsp;*)&nbsp;chunk2mem&nbsp;(p);<br><span class="hljs-number">4188</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">4189</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;This&nbsp;test&nbsp;succeeds&nbsp;on&nbsp;double&nbsp;free.&nbsp;&nbsp;However,&nbsp;we&nbsp;don't&nbsp;100%<br>4190&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trust&nbsp;it&nbsp;(it&nbsp;also&nbsp;matches&nbsp;random&nbsp;payload&nbsp;data&nbsp;at&nbsp;a&nbsp;1&nbsp;in<br>4191&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2^&lt;size_t&gt;&nbsp;chance),&nbsp;so&nbsp;verify&nbsp;it's&nbsp;not&nbsp;an&nbsp;unlikely<br>4192&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coincidence&nbsp;before&nbsp;aborting.&nbsp;&nbsp;*/</span><br><span class="hljs-number">4193</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(__glibc_unlikely&nbsp;(e-&gt;key&nbsp;==&nbsp;tcache))<br><span class="hljs-number">4194</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">4195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcache_entry&nbsp;*tmp;<br><span class="hljs-number">4196</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIBC_PROBE&nbsp;(memory_tcache_double_free,&nbsp;<span class="hljs-number">2</span>,&nbsp;e,&nbsp;tc_idx);<br><span class="hljs-number">4197</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for</span>&nbsp;(tmp&nbsp;=&nbsp;tcache-&gt;entries[tc_idx];<br><span class="hljs-number">4198</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp;<br><span class="hljs-number">4199</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp&nbsp;=&nbsp;tmp-&gt;next)<br><span class="hljs-number">4200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(tmp&nbsp;==&nbsp;e)<br><span class="hljs-number">4201</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;malloc_printerr&nbsp;(<span class="hljs-string">"free():&nbsp;double&nbsp;free&nbsp;detected&nbsp;in&nbsp;tcache&nbsp;2"</span>);<br><span class="hljs-number">4202</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&nbsp;was&nbsp;a&nbsp;coincidence.&nbsp;&nbsp;We've&nbsp;wasted&nbsp;a<br>4203&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;few&nbsp;cycles,&nbsp;but&nbsp;don't&nbsp;abort.&nbsp;&nbsp;*/</span><br><span class="hljs-number">4204</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-comment">//&nbsp;省略...&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="hljs-number">4211</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">4212</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">4213</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">4428</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p>从第 4189~4192 行可以看出，第 4193~4204 行的作用为：检查该<code>chunk</code>是否重复释放。</p>
<p>第 4193 行，当该要被释放的<code>chunk</code>中的<code>key</code>字段的值等于<code>tcache</code>变量的值时，条件表达式的求值结果为<code>true</code>。此时，该<code>chunk</code>可能已经被释放了。由于存在“用户数据正好是 tcache 变量的值”的可能性。于是，检查该<code>chunk</code>在<code>tcache</code>中对应的链表（从头节点开始遍历）中的元素是否已经有该<code>chunk</code>了。如果有，表示该<code>chunk</code>已经被<code>tcache</code>维护了，即本次释放操作是重复释放，那么进行错误处理（内部调用<code>abort</code>函数结束进程）。</p>
<p><strong>step 2：</strong> chunk 大小与 tc_idx 之间的映射关系</p>
<p><code>tcache</code>中所维护的已释放的<code>chunk</code>，根据<code>chunk</code>的不同大小，会被维护到不同的链表中。链表的索引（即<code>entries</code>数组的下标）就是<code>tc_idx</code>。将<code>chunk</code>大小映射为<code>tc_idx</code>的宏定义为<code>csize2tidx</code>。</p>
<p><strong>1）</strong> 查看宏定义<code>csize2tidx</code>的定义（在 malloc.c 中）</p>
<pre><code class="hljs vbnet">/*&nbsp;<span class="hljs-keyword">When</span>&nbsp;<span class="hljs-string">"x"</span>&nbsp;<span class="hljs-keyword">is</span>&nbsp;<span class="hljs-keyword">from</span>&nbsp;chunksize().&nbsp;&nbsp;*/<br><span class="hljs-meta">#&nbsp;define&nbsp;csize2tidx(x)&nbsp;(((x)&nbsp;-&nbsp;MINSIZE&nbsp;+&nbsp;MALLOC_ALIGNMENT&nbsp;-&nbsp;1)&nbsp;/&nbsp;MALLOC_ALIGNMENT)</span><br></code></pre>
<p>从上面的注释可以看出，宏定义<code>csize2tidx</code>（名称可以理解为：chunk-size-to-tcache-index）的参数<code>x</code>表示<code>chunk</code>的大小。</p>
<p>从上文中的分析中我们知道，在 64-bit 系统上，<code>MINSIZE</code>、<code>MALLOC_ALIGNMENT</code>的值分别为 0x20、0x10。</p>
<p>因此，在 64-bit 系统上，宏定义<code>csize2tidx</code>等价于：</p>
<pre><code class="hljs cpp"><span class="hljs-meta">#&nbsp;<span class="hljs-meta-keyword">define</span>&nbsp;csize2tidx(x)&nbsp;(((x)&nbsp;-&nbsp;17)&nbsp;/&nbsp;16)</span><br></code></pre>
<p>于是，可以很容易地得出<code>chunk</code>大小与<code>tc_idx</code>之间的映射关系，详见下文。</p>
<p><strong><font size="4">研究结论：</font></strong></p>
<p><strong>结构体<code>tcache_perthread_struct</code>中各字段的意义：</strong></p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>类型</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>counts</td>
<td>大小为 TCACHE_MAX_BINS 的数组，其中元素的数据类型为 <code>uint16_t</code></td>
<td>用于存储 tcache 所维护的各个链表中的节点数量，即 counts[i] 的值表示 entries[i] 链表中的节点数量。</td>
</tr>
<tr>
<td>entries</td>
<td>大小为 TCACHE_MAX_BINS 的数组，其中元素的数据类型为 <code>tcache_entry *</code></td>
<td>用于存储 tcache 所维护的各个链表，即 entries[i] 表示由大小为 32+i*16 的 chunk 所组成的单向链表中的头节点</td>
</tr>
</tbody>
</table>
<p><strong>结构体<code>tcache_entry</code>中各字段的意义：</strong></p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>类型</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>next</td>
<td>struct tcache_entry *</td>
<td>指向链表中的下一个已释放的 chunk，即 next 的值为下一个已释放 chunk 中“用户数据”的起始地址</td>
</tr>
<tr>
<td>key</td>
<td>struct tcache_perthread_struct *</td>
<td>用于检查一个 chunk 是否重复释放</td>
</tr>
</tbody>
</table>
<p><strong>在 64-bit 系统上，<code>chunk</code>大小与<code>tc_idx</code>之间的映射关系：</strong></p>
<table>
<thead>
<tr>
<th>tc_idx 的值</th>
<th>对应的 chunk 大小</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>32</td>
</tr>
<tr>
<td>1</td>
<td>48</td>
</tr>
<tr>
<td>2</td>
<td>64</td>
</tr>
<tr>
<td>3</td>
<td>80</td>
</tr>
<tr>
<td>i</td>
<td>32+i*16</td>
</tr>
<tr>
<td>62</td>
<td>1024</td>
</tr>
<tr>
<td>63</td>
<td>1040</td>
</tr>
</tbody>
</table>
<p><strong>注意：</strong> <code>chunk</code>大小 &gt; 1040 字节的，不会被维护在<code>tcache</code>中。这是因为，结构体<code>tcache_perthread_struct</code>中，数据成员<code>entries</code>的数组大小为<code>TCACHE_MAX_BINS</code>（值被定义为 64）。</p>
<p><a href="#jump3">返回上一级</a></p>
<hr>
<h3 id="hspanidjump4chunkspan"><span><span id="jump4">第一个 chunk 的来龙去脉</span></span></h3>
<p><strong><font size="4">研究过程：</font></strong></p>
<p><strong>step 1：</strong> 准备</p>
<p><strong>1）</strong> 启动可执行目标文件<code>vm4_main</code>，并设置一些断点等</p>
<pre><code class="hljs go">$&nbsp;gdb&nbsp;-q&nbsp;-x&nbsp;tvm4_4.gdb<br>Temporary&nbsp;breakpoint&nbsp;<span class="hljs-number">1</span>&nbsp;at&nbsp;<span class="hljs-number">0x11a9</span>:&nbsp;file&nbsp;vm4_main.cpp,&nbsp;line&nbsp;<span class="hljs-number">37.</span><br><br>Temporary&nbsp;breakpoint&nbsp;<span class="hljs-number">1</span>,&nbsp;main&nbsp;(argc=<span class="hljs-number">0</span>,&nbsp;argv=<span class="hljs-number">0x0</span>)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">37</span><br><span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br>Breakpoint&nbsp;<span class="hljs-number">2</span>&nbsp;at&nbsp;<span class="hljs-number">0x7ffff7e5f</span>260:&nbsp;malloc.&nbsp;(<span class="hljs-number">2</span>&nbsp;locations)<br>Breakpoint&nbsp;<span class="hljs-number">3</span>&nbsp;at&nbsp;<span class="hljs-number">0x7ffff7e5cbf</span>0:&nbsp;file&nbsp;malloc.c,&nbsp;line&nbsp;<span class="hljs-number">3545.</span><br>Breakpoint&nbsp;<span class="hljs-number">4</span>&nbsp;at&nbsp;<span class="hljs-number">0x5555555551dd</span>:&nbsp;file&nbsp;vm4_main.cpp,&nbsp;line&nbsp;<span class="hljs-number">39.</span><br></code></pre>
<p>tvm4_4.gdb 文件的内容为：</p>
<pre><code class="hljs cpp">file&nbsp;./vm4_main<br>start<br>directory&nbsp;/home/workspace/git-projects/glibc<span class="hljs-number">-2.31</span>/<span class="hljs-built_in">malloc</span><br><span class="hljs-built_in">set</span>&nbsp;listsize&nbsp;<span class="hljs-number">20</span><br><br>b&nbsp;<span class="hljs-built_in">malloc</span><br>b&nbsp;_int_malloc<br>b&nbsp;vm4_main.cpp:<span class="hljs-number">39</span><br></code></pre>
<p><strong>2）</strong> 继续执行</p>
<pre><code class="hljs perl">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">2</span>,&nbsp;__GI___libc_malloc&nbsp;(bytes=<span class="hljs-number">8</span>)&nbsp;at&nbsp;malloc.c:<span class="hljs-number">3023</span><br><span class="hljs-number">3023</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br>(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">3</span>,&nbsp;_int_malloc&nbsp;(av=av@entry=<span class="hljs-number">0x7ffff7fadb80</span>&nbsp;&lt;main_arena&gt;,&nbsp;bytes=bytes@entry=<span class="hljs-number">640</span>)&nbsp;at&nbsp;malloc.c:<span class="hljs-number">3545</span><br><span class="hljs-number">3545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!checked_request2size&nbsp;(bytes,&nbsp;&amp;nb))<br>(gdb)&nbsp;p/<span class="hljs-keyword">x</span>&nbsp;bytes<br>$1&nbsp;=&nbsp;<span class="hljs-number">0x280</span><br></code></pre>
<p><strong>需要注意的是</strong>，<code>obj1</code>对象申请的堆内存大小为 8 字节，而这里<code>_int_malloc</code>函数中的参数<code>bytes</code>的值为 640（十六进制为 0x280）字节。</p>
<p>另外，从上一篇中我们知道，第一个<code>chunk</code>的大小为 0x290 字节。那么，目前正在分配的是否就是第一个<code>chunk</code>呢？继续往下看。</p>
<p><strong>3）</strong> 查看当前线程的调用堆栈信息</p>
<pre><code class="hljs shell">(gdb)&nbsp;bt<br><span class="hljs-meta">#</span><span class="bash">0&nbsp;&nbsp;_int_malloc&nbsp;(av=av@entry=0x7ffff7fadb80&nbsp;&lt;main_arena&gt;,&nbsp;bytes=bytes@entry=640)&nbsp;at&nbsp;malloc.c:3545</span><br><span class="hljs-meta">#</span><span class="bash">1&nbsp;&nbsp;0x00007ffff7e5dafb&nbsp;<span class="hljs-keyword">in</span>&nbsp;tcache_init&nbsp;()&nbsp;at&nbsp;malloc.c:2982</span><br><span class="hljs-meta">#</span><span class="bash">2&nbsp;&nbsp;0x00007ffff7e5ed8e&nbsp;<span class="hljs-keyword">in</span>&nbsp;tcache_init&nbsp;()&nbsp;at&nbsp;malloc.c:3044</span><br><span class="hljs-meta">#</span><span class="bash">3&nbsp;&nbsp;__GI___libc_malloc&nbsp;(bytes=8)&nbsp;at&nbsp;malloc.c:3044</span><br><span class="hljs-meta">#</span><span class="bash">4&nbsp;&nbsp;malloc_hook_ini&nbsp;(sz=8,&nbsp;<span class="hljs-built_in">caller</span>=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;hooks.c:32</span><br><span class="hljs-meta">#</span><span class="bash">5&nbsp;&nbsp;0x00005555555552f3&nbsp;<span class="hljs-keyword">in</span>&nbsp;HeapObject::HeapObject&nbsp;(this=0x7fffffffdc30,&nbsp;size=8)&nbsp;at&nbsp;vm4_main.cpp:11</span><br><span class="hljs-meta">#</span><span class="bash">6&nbsp;&nbsp;0x00005555555551dd&nbsp;<span class="hljs-keyword">in</span>&nbsp;main&nbsp;(argc=1,&nbsp;argv=0x7fffffffdd98)&nbsp;at&nbsp;vm4_main.cpp:38</span><br></code></pre>
<p>从上面的调用堆栈信息可以看出，目前正在分配的<code>chunk</code>的根源是由“obj1 对象申请堆内存”导致的，并且该<code>chunk</code>的分配发生在<code>obj1.data_</code>所在<code>chunk</code>被分配之前。另外，目前正在分配的<code>chunk</code>的上一级为<code>tcache_init</code>函数。那么，是不是<code>tcache_init</code>函数中有申请大小为 0x280 字节的堆内存的操作呢。继续往下看。</p>
<p><strong>4）</strong> 单步执行直到运行到 malloc.c:4142 行时停止，并观察局部变量<code>p</code>的值和进程的内存映射情况</p>
<pre><code class="hljs objectivec">(gdb)&nbsp;n<br><span class="hljs-number">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*sz&nbsp;=&nbsp;request2size&nbsp;(req);<br><span class="hljs-meta">#&nbsp;省略...</span><br>(gdb)&nbsp;n<br><span class="hljs-number">4141</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*p&nbsp;=&nbsp;sysmalloc&nbsp;(nb,&nbsp;av);<br>(gdb)&nbsp;n<br><span class="hljs-number">4142</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(p&nbsp;!=&nbsp;<span class="hljs-literal">NULL</span>)<br>(gdb)&nbsp;p/x&nbsp;p<br>$<span class="hljs-number">2</span>&nbsp;=&nbsp;<span class="hljs-number">0x555555559010</span><br>(gdb)&nbsp;i&nbsp;proc&nbsp;mappings&nbsp;<br>process&nbsp;<span class="hljs-number">673635</span><br>Mapped&nbsp;address&nbsp;spaces:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Start&nbsp;Addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End&nbsp;Addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Offset&nbsp;objfile<br><span class="hljs-meta">#&nbsp;省略...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x555555559000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x55555557a000</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x21000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x0</span>&nbsp;[heap]<br></code></pre>
<p>从上面的结果中可以看出，局部变量<code>p</code>的值为 0x555555559010，堆的起始地址为 0x555555559000。</p>
<p>查看 malloc.c:4142 行附近的代码：</p>
<pre><code class="hljs cpp"><span class="hljs-number">4141</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*p&nbsp;=&nbsp;sysmalloc&nbsp;(nb,&nbsp;av);<br><span class="hljs-number">4142</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(p&nbsp;!=&nbsp;<span class="hljs-literal">NULL</span>)<br><span class="hljs-number">4143</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alloc_perturb&nbsp;(p,&nbsp;bytes);<br><span class="hljs-number">4144</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;p;<br></code></pre>
<p>结合上述源码，我们可以发现，局部变量<code>p</code>就是<code>_int_malloc</code>函数的返回值。我们知道，<code>_int_malloc</code>函数的返回值表示用户数据的起始地址。从而，目前正在分配的<code>chunk</code>的起始地址为 0x555555559000，也就是本进程中堆的起始地址。因此，目前正在分配的<code>chunk</code>正是上一篇中我们所提到的“第一个 chunk ”。</p>
<p><strong>step 2：</strong> 第一个 chunk 是如何被创建的？</p>
<p>通过全局搜索 glibc 2.31 版本的源码可以发现，<code>tcache_init</code>函数仅在宏定义<code>MAYBE_INIT_TCACHE</code>中被调用。</p>
<p><strong>1）</strong> 查看<code>MAYBE_INIT_TCACHE</code>的定义（在 malloc.c 中）</p>
<pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span>&nbsp;USE_TCACHE</span><br><br><span class="hljs-comment">//&nbsp;省略..</span><br><br><span class="hljs-meta">#&nbsp;<span class="hljs-meta-keyword">define</span>&nbsp;MAYBE_INIT_TCACHE()&nbsp;\<br>&nbsp;&nbsp;<span class="hljs-meta-keyword">if</span>&nbsp;(__glibc_unlikely&nbsp;(tcache&nbsp;==&nbsp;NULL))&nbsp;\<br>&nbsp;&nbsp;&nbsp;&nbsp;tcache_init();</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span>&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;!USE_TCACHE&nbsp;*/</span></span><br><span class="hljs-meta">#&nbsp;<span class="hljs-meta-keyword">define</span>&nbsp;MAYBE_INIT_TCACHE()</span><br><br><span class="hljs-comment">//&nbsp;省略..</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;<span class="hljs-comment">/*&nbsp;!USE_TCACHE&nbsp;&nbsp;*/</span></span><br></code></pre>
<p>从上面的源码可以看出，<code>tcache_init</code>函数要被调用，需要同时满足两个条件：1）<code>tcache</code>机制已开启；2）变量<code>tcache</code>的值等于<code>NULL</code>。</p>
<p><strong>2）</strong> 查看变量<code>tcache</code>的定义（在 malloc.c 中）</p>
<pre><code class="hljs cpp"><span class="hljs-keyword">static</span>&nbsp;__thread&nbsp;tcache_perthread_struct&nbsp;*tcache&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br></code></pre>
<p>从上面的源码可以看出，变量<code>tcache</code>的初始值等于<code>NULL</code>。由于该变量被关键字<code>static</code>和<code>__thread</code>修饰。所以，变量<code>tcache</code>是一个静态变量，并且每个线程各自持有一份该变量的不同实体。</p>
<p><strong>3）</strong> 查看宏定义<code>MAYBE_INIT_TCACHE</code>在函数<code>__libc_malloc</code>中被调用的地方</p>
<pre><code class="hljs cpp"><span class="hljs-number">3021</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*<br><span class="hljs-number">3022</span>&nbsp;&nbsp;&nbsp;&nbsp;__libc_malloc&nbsp;(<span class="hljs-keyword">size_t</span>&nbsp;bytes)<br><span class="hljs-number">3023</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3034</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span>&nbsp;USE_TCACHE</span><br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3043</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3044</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAYBE_INIT_TCACHE&nbsp;();<br><span class="hljs-number">3045</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3054</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">3082</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p>结合上述源码以及本节中步骤“step 1：3）”中的调用堆栈信息，我们可以发现，<strong>第一个<code>chunk</code>是在第一次为用户分配堆内存前创建的。</strong></p>
<p><strong>step 3：</strong> 第一个 chunk 的作用？</p>
<p><strong>1）</strong> 查看<code>tcache_init</code>函数的定义（在 malloc.c 中）</p>
<pre><code class="hljs cpp">(gdb)&nbsp;l&nbsp;<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">2971</span>,<span class="hljs-built_in">malloc</span>.c:<span class="hljs-number">3004</span><br><span class="hljs-number">2971</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span><br><span class="hljs-number">2972</span>&nbsp;&nbsp;&nbsp;&nbsp;tcache_init(<span class="hljs-keyword">void</span>)<br><span class="hljs-number">2973</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">2974</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mstate&nbsp;ar_ptr;<br><span class="hljs-number">2975</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>&nbsp;*victim&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="hljs-number">2976</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">size_t</span>&nbsp;bytes&nbsp;=&nbsp;<span class="hljs-keyword">sizeof</span>&nbsp;(tcache_perthread_struct);<br><span class="hljs-number">2977</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">2978</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(tcache_shutting_down)<br><span class="hljs-number">2979</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>;<br><span class="hljs-number">2980</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">2981</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arena_get&nbsp;(ar_ptr,&nbsp;bytes);<br><span class="hljs-number">2982</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim&nbsp;=&nbsp;_int_malloc&nbsp;(ar_ptr,&nbsp;bytes);<br><span class="hljs-number">2983</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!victim&nbsp;&amp;&amp;&nbsp;ar_ptr&nbsp;!=&nbsp;<span class="hljs-literal">NULL</span>)<br><span class="hljs-number">2984</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">2985</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ar_ptr&nbsp;=&nbsp;arena_get_retry&nbsp;(ar_ptr,&nbsp;bytes);<br><span class="hljs-number">2986</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim&nbsp;=&nbsp;_int_malloc&nbsp;(ar_ptr,&nbsp;bytes);<br><span class="hljs-number">2987</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">2988</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">2989</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">2990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(ar_ptr&nbsp;!=&nbsp;<span class="hljs-literal">NULL</span>)<br><span class="hljs-number">2991</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__libc_lock_unlock&nbsp;(ar_ptr-&gt;mutex);<br><span class="hljs-number">2992</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">2993</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;In&nbsp;a&nbsp;low&nbsp;memory&nbsp;situation,&nbsp;we&nbsp;may&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;allocate&nbsp;memory<br>2994&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;in&nbsp;which&nbsp;case,&nbsp;we&nbsp;just&nbsp;keep&nbsp;trying&nbsp;later.&nbsp;&nbsp;However,&nbsp;we<br>2995&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;typically&nbsp;do&nbsp;this&nbsp;very&nbsp;early,&nbsp;so&nbsp;either&nbsp;there&nbsp;is&nbsp;sufficient<br>2996&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memory,&nbsp;or&nbsp;there&nbsp;isn't&nbsp;enough&nbsp;memory&nbsp;to&nbsp;do&nbsp;non-trivial<br>2997&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allocations&nbsp;anyway.&nbsp;&nbsp;*/</span><br><span class="hljs-number">2998</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(victim)<br><span class="hljs-number">2999</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">3000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcache&nbsp;=&nbsp;(tcache_perthread_struct&nbsp;*)&nbsp;victim;<br><span class="hljs-number">3001</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memset</span>&nbsp;(tcache,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-keyword">sizeof</span>&nbsp;(tcache_perthread_struct));<br><span class="hljs-number">3002</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">3003</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">3004</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p>从上面的源码可以发现，第 2892 行的语句<code>victim = _int_malloc (ar_ptr, bytes);</code>中的实参<code>bytes</code>是一个局部常量，值为<code>tcache_perthread_struct</code>所占用的字节数（等于 0x280 字节，如下）。</p>
<pre><code class="hljs bash">(gdb)&nbsp;p/x&nbsp;sizeof&nbsp;(tcache_perthread_struct)<br><span class="hljs-variable">$3</span>&nbsp;=&nbsp;0x280<br></code></pre>
<p>结合第 3000 行的语句<code>tcache = (tcache_perthread_struct *) victim;</code>，表示将第一个<code>chunk</code>的用户数据的起始地址保存到变量<code>tcache</code>中。因此，我们可以推断，<strong>第一个<code>chunk</code>的作用为：</strong>用于存储一个类型为<code>tcache_perthread_struct</code>的对象。</p>
<p>关于<code>tcache_perthread_struct</code>的更多内容，可参考本文中的 <a href="#jump6">理解 struct tcache_perthread_struct 中各字段的意义</a>。</p>
<p><strong><font size="4">研究结论：</font></strong></p>
<ul>
<li><p>第一个 chunk 是何时分配的？</p>
<p>第一个<code>chunk</code>是在第一次为用户分配堆内存前创建的。</p></li>
<li><p>第一个 chunk 被创建需要满足的条件？</p>
<p>要创建第一个<code>chunk</code>，需要同时满足两个条件：1）<code>tcache</code>机制已开启；2）静态变量<code>tcache</code>（线程局部存储）的值等于<code>NULL</code>。</p></li>
<li><p>第一个 chunk 的作用？</p>
<p>用于存储一个类型为<code>tcache_perthread_struct</code>的对象。</p></li>
</ul>
<hr>
<h3 id="hspanidjump5freechunkspan"><span><span id="jump5">为什么在调用 free 函数后，被释放的 chunk 从内存数据来看仍是一个已分配块？</span></span></h3>
<p><strong><font size="4">研究过程：</font></strong></p>
<p>以释放<code>obj2.data_</code>所在的已分配块为例。</p>
<p><strong>step 1：</strong> 准备</p>
<p><strong>1）</strong> 启动可执行目标文件<code>vm4_main</code>，并设置一些断点等</p>
<pre><code class="hljs cpp">$&nbsp;gdb&nbsp;-q&nbsp;-x&nbsp;tvm4_2.gdb<br>Temporary&nbsp;breakpoint&nbsp;<span class="hljs-number">1</span>&nbsp;at&nbsp;<span class="hljs-number">0x11a9</span>:&nbsp;file&nbsp;vm4_main.cpp,&nbsp;line&nbsp;<span class="hljs-number">37.</span><br><br>Temporary&nbsp;breakpoint&nbsp;<span class="hljs-number">1</span>,&nbsp;main&nbsp;(argc=<span class="hljs-number">0</span>,&nbsp;argv=<span class="hljs-number">0x0</span>)&nbsp;at&nbsp;vm4_main.cpp:<span class="hljs-number">37</span><br><span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br>Breakpoint&nbsp;<span class="hljs-number">2</span>&nbsp;at&nbsp;<span class="hljs-number">0x7ffff7e5f850</span>:&nbsp;<span class="hljs-built_in">free</span>.&nbsp;(<span class="hljs-number">2</span>&nbsp;locations)<br>Breakpoint&nbsp;<span class="hljs-number">3</span>&nbsp;at&nbsp;<span class="hljs-number">0x7ffff7e5b9c0</span>:&nbsp;file&nbsp;<span class="hljs-built_in">malloc</span>.c,&nbsp;line&nbsp;<span class="hljs-number">4155.</span><br>Breakpoint&nbsp;<span class="hljs-number">4</span>&nbsp;at&nbsp;<span class="hljs-number">0x55555555521c</span>:&nbsp;file&nbsp;vm4_main.cpp,&nbsp;line&nbsp;<span class="hljs-number">44.</span><br></code></pre>
<p>tvm4_2.gdb 文件的内容为：</p>
<pre><code class="hljs cpp">file&nbsp;./vm4_main<br>start<br>directory&nbsp;/home/workspace/git-projects/glibc<span class="hljs-number">-2.31</span>/<span class="hljs-built_in">malloc</span><br><span class="hljs-built_in">set</span>&nbsp;listsize&nbsp;<span class="hljs-number">20</span><br><br>b&nbsp;<span class="hljs-built_in">free</span><br>b&nbsp;_int_free<br>b&nbsp;vm4_main.cpp:<span class="hljs-number">44</span><br></code></pre>
<p><strong>2）</strong> 继续执行，并查看当前线程的调用堆栈信息</p>
<pre><code class="hljs objectivec">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;<span class="hljs-number">2</span>,&nbsp;__GI___libc_free&nbsp;(mem=<span class="hljs-number">0x5555555592c0</span>)&nbsp;at&nbsp;malloc.c:<span class="hljs-number">3087</span><br><span class="hljs-number">3087</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br>(gdb)&nbsp;bt<br><span class="hljs-meta">#0&nbsp;&nbsp;__GI___libc_free&nbsp;(mem=0x5555555592c0)&nbsp;at&nbsp;malloc.c:3087</span><br><span class="hljs-meta">#1&nbsp;&nbsp;0x000055555555536f&nbsp;in&nbsp;HeapObject::Free&nbsp;(this=0x7fffffffdc40)&nbsp;at&nbsp;vm4_main.cpp:26</span><br><span class="hljs-meta">#2&nbsp;&nbsp;0x000055555555521c&nbsp;in&nbsp;main&nbsp;(argc=1,&nbsp;argv=0x7fffffffdd98)&nbsp;at&nbsp;vm4_main.cpp:43</span><br>(gdb)&nbsp;l&nbsp;vm4_main.cpp:<span class="hljs-number">43</span><br><span class="hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::size_t&nbsp;size_;<br><span class="hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;};<br><span class="hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;main(<span class="hljs-keyword">int</span>&nbsp;argc,&nbsp;<span class="hljs-keyword">char</span>&nbsp;*argv[])<br><span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HeapObject&nbsp;obj1(<span class="hljs-number">8</span>);<br><span class="hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HeapObject&nbsp;obj2(<span class="hljs-number">4</span>);<br><span class="hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HeapObject&nbsp;obj3(<span class="hljs-number">64</span>);<br><span class="hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HeapObject&nbsp;obj4(<span class="hljs-number">4</span>);<br><span class="hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj2.Free();<br><span class="hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj4.Free();<br><span class="hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj3.Free();<br><span class="hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj1.Free();<br><span class="hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HeapObject&nbsp;obj5(<span class="hljs-number">32</span>);<br><span class="hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj5.Free();<br><span class="hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">52</span><br></code></pre>
<p>从上面的调用堆栈信息可以看出，目前正在分析的是释放<code>obj2.data_</code>所在已分配块的过程。</p>
<p>在上文中，我们已经分析了<code>obj2</code>对象释放堆内存时，实际调用了<code>free</code>函数的哪些代码。这里不再赘述。接下来，我们直接研究<code>_int_free</code>函数是如何释放<code>obj2.data_</code>所在<code>chunk</code>的。</p>
<p><strong>step 2：</strong> 在<code>obj2</code>对象释放堆内存时，实际调用了<code>_int_free</code>函数中的哪部分代码？</p>
<p><strong>1）</strong> 继续执行</p>
<pre><code class="hljs shell">(gdb)&nbsp;c<br>Continuing.<br><br>Breakpoint&nbsp;3,&nbsp;_int_free&nbsp;(av=0x7ffff7fadb80&nbsp;&lt;main_arena&gt;,&nbsp;p=0x5555555592b0,&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;have_lock=0)&nbsp;at&nbsp;malloc.c:4155<br>4155&nbsp;&nbsp;&nbsp;&nbsp;{<br>(gdb)&nbsp;bt<br><span class="hljs-meta">#</span><span class="bash">0&nbsp;&nbsp;_int_free&nbsp;(av=0x7ffff7fadb80&nbsp;&lt;main_arena&gt;,&nbsp;p=0x5555555592b0,&nbsp;have_lock=0)&nbsp;at&nbsp;malloc.c:4155</span><br><span class="hljs-meta">#</span><span class="bash">1&nbsp;&nbsp;0x000055555555536f&nbsp;<span class="hljs-keyword">in</span>&nbsp;HeapObject::Free&nbsp;(this=0x7fffffffdc40)&nbsp;at&nbsp;vm4_main.cpp:26</span><br><span class="hljs-meta">#</span><span class="bash">2&nbsp;&nbsp;0x000055555555521c&nbsp;<span class="hljs-keyword">in</span>&nbsp;main&nbsp;(argc=1,&nbsp;argv=0x7fffffffdd98)&nbsp;at&nbsp;vm4_main.cpp:43</span><br>(gdb)&nbsp;f&nbsp;2<br><span class="hljs-meta">#</span><span class="bash">2&nbsp;&nbsp;0x000055555555521c&nbsp;<span class="hljs-keyword">in</span>&nbsp;main&nbsp;(argc=1,&nbsp;argv=0x7fffffffdd98)&nbsp;at&nbsp;vm4_main.cpp:43</span><br>43&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj2.Free();<br>(gdb)&nbsp;p&nbsp;obj2.data_<br><span class="hljs-meta">$</span><span class="bash">1&nbsp;=&nbsp;(void&nbsp;*)&nbsp;0x5555555592c0</span><br></code></pre>
<p>从上面的结果中可以看出，<code>obj2.data_</code>的值为 0x5555555592c0，而<code>_int_free</code>函数的参数<code>p</code>的值为 0x5555555592b0（即<code>obj2.data_</code>所在<code>chunk</code>的起始地址）。</p>
<p>也就是说，<code>free</code>函数的参数表示用户数据的起始地址，<code>_int_free</code>函数的参数<code>p</code>表示用户数据所在<code>chunk</code>的起始地址。<strong>这一点需要注意</strong>。</p>
<p><strong>2）</strong> 在<code>obj2</code>对象释放堆内存时，实际调用的<code>_int_free</code>函数的代码部分如下（这里除了未被调用的以外，还省略了一些合法性检查）：</p>
<pre><code class="hljs cpp"><span class="hljs-number">4153</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span><br><span class="hljs-number">4154</span>&nbsp;&nbsp;&nbsp;&nbsp;_int_free&nbsp;(mstate&nbsp;av,&nbsp;mchunkptr&nbsp;p,&nbsp;<span class="hljs-keyword">int</span>&nbsp;have_lock)<br><span class="hljs-number">4155</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">4156</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTERNAL_SIZE_T&nbsp;size;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*&nbsp;its&nbsp;size&nbsp;*/</span><br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">4165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size&nbsp;=&nbsp;chunksize&nbsp;(p);<br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">4181</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span>&nbsp;USE_TCACHE</span><br><span class="hljs-number">4182</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">4183</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">size_t</span>&nbsp;tc_idx&nbsp;=&nbsp;csize2tidx&nbsp;(size);<br><span class="hljs-number">4184</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(tcache&nbsp;!=&nbsp;<span class="hljs-literal">NULL</span>&nbsp;&amp;&amp;&nbsp;tc_idx&nbsp;&lt;&nbsp;mp_.tcache_bins)<br><span class="hljs-number">4185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-comment">//&nbsp;省略...&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class="hljs-number">4206</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(tcache-&gt;counts[tc_idx]&nbsp;&lt;&nbsp;mp_.tcache_count)<br><span class="hljs-number">4207</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="hljs-number">4208</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcache_put&nbsp;(p,&nbsp;tc_idx);<br><span class="hljs-number">4209</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>;<br><span class="hljs-number">4210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">4211</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">4212</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="hljs-number">4213</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><span class="hljs-comment">//&nbsp;省略...</span><br><span class="hljs-number">4428</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p>关于<code>csize2tidx</code>、<code>tc_idx</code>、<code>tcache-&gt;counts[tc_idx]</code>和<code>tcache_put</code>的更多内容，见本文中的 <a href="#jump3_2_1">理解 tcache_perthread_struct 结构体中各字段的意义</a>。</p>
<p>第 4183 行语句的作用：根据要释放的<code>chunk</code>的大小，确定该<code>chunk</code>应该添加到<code>tcache</code>中的哪个链表里面。链表索引保存在<code>tc_idx</code>变量中。</p>
<p>第 4184 行语句的作用：检查是否开启了<code>tcache</code>机制和所计算出来的链表索引是否越界。</p>
<p>第 4206 行语句的作用：检查要存放的链表中的节点数量是否已经达到最大值。</p>
<p>第 4208 行语句的作用：将要释放的<code>chunk</code>维护在<code>tcache</code>中。</p>
<p>正因为<code>obj2.data_</code>所在的<code>chunk</code>在释放后被维护在了<code>tcache</code>中。并且，该过程未更新该<code>chunk</code>和下一个<code>chunk</code>的头部。因此，在调用<code>free</code>函数后，被释放的<code>chunk</code>从内存数据来看仍是一个已分配块。</p>
<p><strong><font size="4">研究结论：</font></strong></p>
<p>调用<code>free</code>函数后，如果被释放的<code>chunk</code>被维护在<code>tcache</code>中，那么该<code>chunk</code>和下一个<code>chunk</code>的头部不会被更新。也就是说，这些被释放的<code>chunk</code>从内存数据来看仍是一个已分配块，但实际上是作为空闲块由<code>tcache</code>维护了。</p>
<hr>
<h3 id="hspanidjumpreferencesreferencesspan"><span><span id="jumpReferences">References</span></span></h3>
<ul>
<li><p><a href="https://sourceware.org/pipermail/libc-announce/2020/000025.html"><font size="4">glibc-2.31</font></a></p></li>
<li><p><a href="https://dangokyo.me/2018/01/16/extra-heap-exploitation-tcache-and-potential-exploitation/"><font size="4">Extra Heap Exploitation 2: TCache and Potential Exploitation</font></a></p></li>
<li><p><a href="http://tukan.farm/2017/07/08/tcache/"><font size="4">thread local caching in glibc malloc</font></a></p></li>
<li><p><a href="https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc"><font size="4">Add per-thread cache to malloc</font></a></p></li>
</ul>
<hr>
<p><font size="4"><strong>下一篇：</strong><a href="https://csstormq.github.io/#jump计算机系统">计算机系统之目录</a></font></p>
<p><font size="4"><strong>上一篇：</strong><a href="https://csstormq.github.io/blog/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%AF%87%E4%B9%8B%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%EF%BC%888%EF%BC%89%EF%BC%9A%E7%90%86%E8%A7%A3%20glibc%20malloc%20%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89">计算机系统篇之虚拟内存（8）：理解 glibc malloc 的工作原理（上）</a>
</font></p>
<p><font size="4"></font></p><p align="center"><font size="4"><a href="https://csstormq.github.io"><strong>首页</strong></a> </font></p><p></p></div></div></body>
</html>
