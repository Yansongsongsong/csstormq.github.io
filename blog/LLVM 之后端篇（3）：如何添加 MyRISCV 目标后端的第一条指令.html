<!DOCTYPE html>
<html>
<head>  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,user-scalable=0">
  <meta name="author" content="微信公众号：颜家大少">
  <meta name="email" content="3056432@qq.com">
  <meta name="description" content="一个Markdown在线转换工具，让Markdown内容，不需作任何调整就能同时在微信公众号、博客园、掘金、csdn等平台正确显示当前预览的效果">
  <title>StormQ's Blog</title>  
  <style type="text/css" id="markdown_preview_css"> 
 .output_wrapper pre code{font-family: Consolas, Inconsolata, Courier, monospace; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important;  overflow: auto !important;}  
.output_wrapper a:hover { text-decoration: underline; color: rgb(0, 96, 100); }
.output_wrapper figcaption { margin-top: 10px; text-align: center; color: rgb(153, 153, 153); font-size: 0.7em; }
.output_wrapper pre code .linenum { padding-right: 20px; word-spacing: 0px; }
.task-list-list { list-style-type: none; }
.task-list-list.checked { color: rgb(62, 62, 62); }
.task-list-list.uncheck { color: rgb(191, 193, 191); }
.task-list-list .icon_uncheck, .task-list-list .icon_check { display: inline-block; vertical-align: middle; margin-right: 10px; }
.task-list-list .icon_check::before { content: "√"; border: 2px solid rgb(62, 62, 62); color: red; }
.task-list-list .icon_uncheck::before { content: "x"; border: 2px solid rgb(191, 193, 191); color: rgb(191, 193, 191); }
.task-list-list .icon_check::before, .task-list-list .icon_uncheck::before { padding: 2px 8px 2px 5px; border-radius: 5px; }
@font-face { font-family: "KaTeX_AMS"; src: url("fonts/KaTeX_AMS-Regular.woff2") format("woff2"), url("fonts/KaTeX_AMS-Regular.woff") format("woff"), url("fonts/KaTeX_AMS-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Caligraphic"; src: url("fonts/KaTeX_Caligraphic-Bold.woff2") format("woff2"), url("fonts/KaTeX_Caligraphic-Bold.woff") format("woff"), url("fonts/KaTeX_Caligraphic-Bold.ttf") format("truetype"); font-style: normal; font-weight: bold; }
@font-face { font-family: "KaTeX_Caligraphic"; src: url("fonts/KaTeX_Caligraphic-Regular.woff2") format("woff2"), url("fonts/KaTeX_Caligraphic-Regular.woff") format("woff"), url("fonts/KaTeX_Caligraphic-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Fraktur"; src: url("fonts/KaTeX_Fraktur-Bold.woff2") format("woff2"), url("fonts/KaTeX_Fraktur-Bold.woff") format("woff"), url("fonts/KaTeX_Fraktur-Bold.ttf") format("truetype"); font-style: normal; font-weight: bold; }
@font-face { font-family: "KaTeX_Fraktur"; src: url("fonts/KaTeX_Fraktur-Regular.woff2") format("woff2"), url("fonts/KaTeX_Fraktur-Regular.woff") format("woff"), url("fonts/KaTeX_Fraktur-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Main"; src: url("fonts/KaTeX_Main-Bold.woff2") format("woff2"), url("fonts/KaTeX_Main-Bold.woff") format("woff"), url("fonts/KaTeX_Main-Bold.ttf") format("truetype"); font-style: normal; font-weight: bold; }
@font-face { font-family: "KaTeX_Main"; src: url("fonts/KaTeX_Main-BoldItalic.woff2") format("woff2"), url("fonts/KaTeX_Main-BoldItalic.woff") format("woff"), url("fonts/KaTeX_Main-BoldItalic.ttf") format("truetype"); font-style: italic; font-weight: bold; }
@font-face { font-family: "KaTeX_Main"; src: url("fonts/KaTeX_Main-Italic.woff2") format("woff2"), url("fonts/KaTeX_Main-Italic.woff") format("woff"), url("fonts/KaTeX_Main-Italic.ttf") format("truetype"); font-style: italic; font-weight: normal; }
@font-face { font-family: "KaTeX_Main"; src: url("fonts/KaTeX_Main-Regular.woff2") format("woff2"), url("fonts/KaTeX_Main-Regular.woff") format("woff"), url("fonts/KaTeX_Main-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Math"; src: url("fonts/KaTeX_Math-BoldItalic.woff2") format("woff2"), url("fonts/KaTeX_Math-BoldItalic.woff") format("woff"), url("fonts/KaTeX_Math-BoldItalic.ttf") format("truetype"); font-style: italic; font-weight: bold; }
@font-face { font-family: "KaTeX_Math"; src: url("fonts/KaTeX_Math-Italic.woff2") format("woff2"), url("fonts/KaTeX_Math-Italic.woff") format("woff"), url("fonts/KaTeX_Math-Italic.ttf") format("truetype"); font-style: italic; font-weight: normal; }
@font-face { font-family: "KaTeX_SansSerif"; src: url("fonts/KaTeX_SansSerif-Bold.woff2") format("woff2"), url("fonts/KaTeX_SansSerif-Bold.woff") format("woff"), url("fonts/KaTeX_SansSerif-Bold.ttf") format("truetype"); font-style: normal; font-weight: bold; }
@font-face { font-family: "KaTeX_SansSerif"; src: url("fonts/KaTeX_SansSerif-Italic.woff2") format("woff2"), url("fonts/KaTeX_SansSerif-Italic.woff") format("woff"), url("fonts/KaTeX_SansSerif-Italic.ttf") format("truetype"); font-style: italic; font-weight: normal; }
@font-face { font-family: "KaTeX_SansSerif"; src: url("fonts/KaTeX_SansSerif-Regular.woff2") format("woff2"), url("fonts/KaTeX_SansSerif-Regular.woff") format("woff"), url("fonts/KaTeX_SansSerif-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Script"; src: url("fonts/KaTeX_Script-Regular.woff2") format("woff2"), url("fonts/KaTeX_Script-Regular.woff") format("woff"), url("fonts/KaTeX_Script-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Size1"; src: url("fonts/KaTeX_Size1-Regular.woff2") format("woff2"), url("fonts/KaTeX_Size1-Regular.woff") format("woff"), url("fonts/KaTeX_Size1-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Size2"; src: url("fonts/KaTeX_Size2-Regular.woff2") format("woff2"), url("fonts/KaTeX_Size2-Regular.woff") format("woff"), url("fonts/KaTeX_Size2-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Size3"; src: url("fonts/KaTeX_Size3-Regular.woff2") format("woff2"), url("fonts/KaTeX_Size3-Regular.woff") format("woff"), url("fonts/KaTeX_Size3-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Size4"; src: url("fonts/KaTeX_Size4-Regular.woff2") format("woff2"), url("fonts/KaTeX_Size4-Regular.woff") format("woff"), url("fonts/KaTeX_Size4-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@font-face { font-family: "KaTeX_Typewriter"; src: url("fonts/KaTeX_Typewriter-Regular.woff2") format("woff2"), url("fonts/KaTeX_Typewriter-Regular.woff") format("woff"), url("fonts/KaTeX_Typewriter-Regular.ttf") format("truetype"); font-style: normal; font-weight: normal; }
@media screen {
  .katex .mtable .vertical-separator { min-width: 1px; }
  .katex .mfrac .frac-line, .katex .overline .overline-line, .katex .underline .underline-line, .katex .hline, .katex .hdashline, .katex .rule { min-height: 1px; }
}
.katex-display { display: block; margin: 1em 0px; text-align: center; }
.katex-display > .katex { display: block; text-align: center; white-space: nowrap; }
.katex-display > .katex > .katex-html { display: block; }
.katex-display > .katex > .katex-html > .tag { position: absolute; right: 0px; }
.katex { font: 1.21em / 1.2 KaTeX_Main, Times New Roman, serif; text-indent: 0px; text-rendering: auto; }
.katex * { }
.katex .katex-mathml { position: absolute; clip: rect(1px, 1px, 1px, 1px); padding: 0px; border: 0px none; height: 1px; width: 1px; overflow: hidden; }
.katex .katex-html { }
.katex .katex-html > .newline { display: block; }
.katex .base { position: relative; display: inline-block; white-space: nowrap; width: min-content; }
.katex .strut { display: inline-block; }
.katex .textbf { font-weight: bold; }
.katex .textit { font-style: italic; }
.katex .textrm { font-family: KaTeX_Main; }
.katex .textsf { font-family: KaTeX_SansSerif; }
.katex .texttt { font-family: KaTeX_Typewriter; }
.katex .mathit { font-family: KaTeX_Math; font-style: italic; }
.katex .mathrm { font-style: normal; }
.katex .mathbf { font-family: KaTeX_Main; font-weight: bold; }
.katex .boldsymbol { font-family: KaTeX_Math; font-weight: bold; font-style: italic; }
.katex .amsrm { font-family: KaTeX_AMS; }
.katex .mathbb, .katex .textbb { font-family: KaTeX_AMS; }
.katex .mathcal { font-family: KaTeX_Caligraphic; }
.katex .mathfrak, .katex .textfrak { font-family: KaTeX_Fraktur; }
.katex .mathtt { font-family: KaTeX_Typewriter; }
.katex .mathscr, .katex .textscr { font-family: KaTeX_Script; }
.katex .mathsf, .katex .textsf { font-family: KaTeX_SansSerif; }
.katex .mainit { font-family: KaTeX_Main; font-style: italic; }
.katex .mainrm { font-family: KaTeX_Main; font-style: normal; }
.katex .vlist-t { display: inline-table; table-layout: fixed; }
.katex .vlist-r { display: table-row; }
.katex .vlist { display: table-cell; vertical-align: bottom; position: relative; }
.katex .vlist > span { display: block; height: 0px; position: relative; }
.katex .vlist > span > span { display: inline-block; }
.katex .vlist > span > .pstrut { overflow: hidden; width: 0px; }
.katex .vlist-t2 { margin-right: -2px; }
.katex .vlist-s { display: table-cell; vertical-align: bottom; font-size: 1px; width: 2px; min-width: 2px; }
.katex .msupsub { text-align: left; }
.katex .mfrac > span > span { text-align: center; }
.katex .mfrac .frac-line { display: inline-block; width: 100%; border-bottom-style: solid; }
.katex .mspace { display: inline-block; }
.katex .llap, .katex .rlap, .katex .clap { width: 0px; position: relative; }
.katex .llap > .inner, .katex .rlap > .inner, .katex .clap > .inner { position: absolute; }
.katex .llap > .fix, .katex .rlap > .fix, .katex .clap > .fix { display: inline-block; }
.katex .llap > .inner { right: 0px; }
.katex .rlap > .inner, .katex .clap > .inner { left: 0px; }
.katex .clap > .inner > span { margin-left: -50%; margin-right: 50%; }
.katex .rule { display: inline-block; border: 0px solid; position: relative; }
.katex .overline .overline-line, .katex .underline .underline-line, .katex .hline { display: inline-block; width: 100%; border-bottom-style: solid; }
.katex .hdashline { display: inline-block; width: 100%; border-bottom-style: dashed; }
.katex .sqrt > .root { margin-left: 0.277778em; margin-right: -0.555556em; }
.katex .sizing, .katex .fontsize-ensurer { display: inline-block; }
.katex .sizing.reset-size1.size1, .katex .fontsize-ensurer.reset-size1.size1 { font-size: 1em; }
.katex .sizing.reset-size1.size2, .katex .fontsize-ensurer.reset-size1.size2 { font-size: 1.2em; }
.katex .sizing.reset-size1.size3, .katex .fontsize-ensurer.reset-size1.size3 { font-size: 1.4em; }
.katex .sizing.reset-size1.size4, .katex .fontsize-ensurer.reset-size1.size4 { font-size: 1.6em; }
.katex .sizing.reset-size1.size5, .katex .fontsize-ensurer.reset-size1.size5 { font-size: 1.8em; }
.katex .sizing.reset-size1.size6, .katex .fontsize-ensurer.reset-size1.size6 { font-size: 2em; }
.katex .sizing.reset-size1.size7, .katex .fontsize-ensurer.reset-size1.size7 { font-size: 2.4em; }
.katex .sizing.reset-size1.size8, .katex .fontsize-ensurer.reset-size1.size8 { font-size: 2.88em; }
.katex .sizing.reset-size1.size9, .katex .fontsize-ensurer.reset-size1.size9 { font-size: 3.456em; }
.katex .sizing.reset-size1.size10, .katex .fontsize-ensurer.reset-size1.size10 { font-size: 4.148em; }
.katex .sizing.reset-size1.size11, .katex .fontsize-ensurer.reset-size1.size11 { font-size: 4.976em; }
.katex .sizing.reset-size2.size1, .katex .fontsize-ensurer.reset-size2.size1 { font-size: 0.833333em; }
.katex .sizing.reset-size2.size2, .katex .fontsize-ensurer.reset-size2.size2 { font-size: 1em; }
.katex .sizing.reset-size2.size3, .katex .fontsize-ensurer.reset-size2.size3 { font-size: 1.16667em; }
.katex .sizing.reset-size2.size4, .katex .fontsize-ensurer.reset-size2.size4 { font-size: 1.33333em; }
.katex .sizing.reset-size2.size5, .katex .fontsize-ensurer.reset-size2.size5 { font-size: 1.5em; }
.katex .sizing.reset-size2.size6, .katex .fontsize-ensurer.reset-size2.size6 { font-size: 1.66667em; }
.katex .sizing.reset-size2.size7, .katex .fontsize-ensurer.reset-size2.size7 { font-size: 2em; }
.katex .sizing.reset-size2.size8, .katex .fontsize-ensurer.reset-size2.size8 { font-size: 2.4em; }
.katex .sizing.reset-size2.size9, .katex .fontsize-ensurer.reset-size2.size9 { font-size: 2.88em; }
.katex .sizing.reset-size2.size10, .katex .fontsize-ensurer.reset-size2.size10 { font-size: 3.45667em; }
.katex .sizing.reset-size2.size11, .katex .fontsize-ensurer.reset-size2.size11 { font-size: 4.14667em; }
.katex .sizing.reset-size3.size1, .katex .fontsize-ensurer.reset-size3.size1 { font-size: 0.714286em; }
.katex .sizing.reset-size3.size2, .katex .fontsize-ensurer.reset-size3.size2 { font-size: 0.857143em; }
.katex .sizing.reset-size3.size3, .katex .fontsize-ensurer.reset-size3.size3 { font-size: 1em; }
.katex .sizing.reset-size3.size4, .katex .fontsize-ensurer.reset-size3.size4 { font-size: 1.14286em; }
.katex .sizing.reset-size3.size5, .katex .fontsize-ensurer.reset-size3.size5 { font-size: 1.28571em; }
.katex .sizing.reset-size3.size6, .katex .fontsize-ensurer.reset-size3.size6 { font-size: 1.42857em; }
.katex .sizing.reset-size3.size7, .katex .fontsize-ensurer.reset-size3.size7 { font-size: 1.71429em; }
.katex .sizing.reset-size3.size8, .katex .fontsize-ensurer.reset-size3.size8 { font-size: 2.05714em; }
.katex .sizing.reset-size3.size9, .katex .fontsize-ensurer.reset-size3.size9 { font-size: 2.46857em; }
.katex .sizing.reset-size3.size10, .katex .fontsize-ensurer.reset-size3.size10 { font-size: 2.96286em; }
.katex .sizing.reset-size3.size11, .katex .fontsize-ensurer.reset-size3.size11 { font-size: 3.55429em; }
.katex .sizing.reset-size4.size1, .katex .fontsize-ensurer.reset-size4.size1 { font-size: 0.625em; }
.katex .sizing.reset-size4.size2, .katex .fontsize-ensurer.reset-size4.size2 { font-size: 0.75em; }
.katex .sizing.reset-size4.size3, .katex .fontsize-ensurer.reset-size4.size3 { font-size: 0.875em; }
.katex .sizing.reset-size4.size4, .katex .fontsize-ensurer.reset-size4.size4 { font-size: 1em; }
.katex .sizing.reset-size4.size5, .katex .fontsize-ensurer.reset-size4.size5 { font-size: 1.125em; }
.katex .sizing.reset-size4.size6, .katex .fontsize-ensurer.reset-size4.size6 { font-size: 1.25em; }
.katex .sizing.reset-size4.size7, .katex .fontsize-ensurer.reset-size4.size7 { font-size: 1.5em; }
.katex .sizing.reset-size4.size8, .katex .fontsize-ensurer.reset-size4.size8 { font-size: 1.8em; }
.katex .sizing.reset-size4.size9, .katex .fontsize-ensurer.reset-size4.size9 { font-size: 2.16em; }
.katex .sizing.reset-size4.size10, .katex .fontsize-ensurer.reset-size4.size10 { font-size: 2.5925em; }
.katex .sizing.reset-size4.size11, .katex .fontsize-ensurer.reset-size4.size11 { font-size: 3.11em; }
.katex .sizing.reset-size5.size1, .katex .fontsize-ensurer.reset-size5.size1 { font-size: 0.555556em; }
.katex .sizing.reset-size5.size2, .katex .fontsize-ensurer.reset-size5.size2 { font-size: 0.666667em; }
.katex .sizing.reset-size5.size3, .katex .fontsize-ensurer.reset-size5.size3 { font-size: 0.777778em; }
.katex .sizing.reset-size5.size4, .katex .fontsize-ensurer.reset-size5.size4 { font-size: 0.888889em; }
.katex .sizing.reset-size5.size5, .katex .fontsize-ensurer.reset-size5.size5 { font-size: 1em; }
.katex .sizing.reset-size5.size6, .katex .fontsize-ensurer.reset-size5.size6 { font-size: 1.11111em; }
.katex .sizing.reset-size5.size7, .katex .fontsize-ensurer.reset-size5.size7 { font-size: 1.33333em; }
.katex .sizing.reset-size5.size8, .katex .fontsize-ensurer.reset-size5.size8 { font-size: 1.6em; }
.katex .sizing.reset-size5.size9, .katex .fontsize-ensurer.reset-size5.size9 { font-size: 1.92em; }
.katex .sizing.reset-size5.size10, .katex .fontsize-ensurer.reset-size5.size10 { font-size: 2.30444em; }
.katex .sizing.reset-size5.size11, .katex .fontsize-ensurer.reset-size5.size11 { font-size: 2.76444em; }
.katex .sizing.reset-size6.size1, .katex .fontsize-ensurer.reset-size6.size1 { font-size: 0.5em; }
.katex .sizing.reset-size6.size2, .katex .fontsize-ensurer.reset-size6.size2 { font-size: 0.6em; }
.katex .sizing.reset-size6.size3, .katex .fontsize-ensurer.reset-size6.size3 { font-size: 0.7em; }
.katex .sizing.reset-size6.size4, .katex .fontsize-ensurer.reset-size6.size4 { font-size: 0.8em; }
.katex .sizing.reset-size6.size5, .katex .fontsize-ensurer.reset-size6.size5 { font-size: 0.9em; }
.katex .sizing.reset-size6.size6, .katex .fontsize-ensurer.reset-size6.size6 { font-size: 1em; }
.katex .sizing.reset-size6.size7, .katex .fontsize-ensurer.reset-size6.size7 { font-size: 1.2em; }
.katex .sizing.reset-size6.size8, .katex .fontsize-ensurer.reset-size6.size8 { font-size: 1.44em; }
.katex .sizing.reset-size6.size9, .katex .fontsize-ensurer.reset-size6.size9 { font-size: 1.728em; }
.katex .sizing.reset-size6.size10, .katex .fontsize-ensurer.reset-size6.size10 { font-size: 2.074em; }
.katex .sizing.reset-size6.size11, .katex .fontsize-ensurer.reset-size6.size11 { font-size: 2.488em; }
.katex .sizing.reset-size7.size1, .katex .fontsize-ensurer.reset-size7.size1 { font-size: 0.416667em; }
.katex .sizing.reset-size7.size2, .katex .fontsize-ensurer.reset-size7.size2 { font-size: 0.5em; }
.katex .sizing.reset-size7.size3, .katex .fontsize-ensurer.reset-size7.size3 { font-size: 0.583333em; }
.katex .sizing.reset-size7.size4, .katex .fontsize-ensurer.reset-size7.size4 { font-size: 0.666667em; }
.katex .sizing.reset-size7.size5, .katex .fontsize-ensurer.reset-size7.size5 { font-size: 0.75em; }
.katex .sizing.reset-size7.size6, .katex .fontsize-ensurer.reset-size7.size6 { font-size: 0.833333em; }
.katex .sizing.reset-size7.size7, .katex .fontsize-ensurer.reset-size7.size7 { font-size: 1em; }
.katex .sizing.reset-size7.size8, .katex .fontsize-ensurer.reset-size7.size8 { font-size: 1.2em; }
.katex .sizing.reset-size7.size9, .katex .fontsize-ensurer.reset-size7.size9 { font-size: 1.44em; }
.katex .sizing.reset-size7.size10, .katex .fontsize-ensurer.reset-size7.size10 { font-size: 1.72833em; }
.katex .sizing.reset-size7.size11, .katex .fontsize-ensurer.reset-size7.size11 { font-size: 2.07333em; }
.katex .sizing.reset-size8.size1, .katex .fontsize-ensurer.reset-size8.size1 { font-size: 0.347222em; }
.katex .sizing.reset-size8.size2, .katex .fontsize-ensurer.reset-size8.size2 { font-size: 0.416667em; }
.katex .sizing.reset-size8.size3, .katex .fontsize-ensurer.reset-size8.size3 { font-size: 0.486111em; }
.katex .sizing.reset-size8.size4, .katex .fontsize-ensurer.reset-size8.size4 { font-size: 0.555556em; }
.katex .sizing.reset-size8.size5, .katex .fontsize-ensurer.reset-size8.size5 { font-size: 0.625em; }
.katex .sizing.reset-size8.size6, .katex .fontsize-ensurer.reset-size8.size6 { font-size: 0.694444em; }
.katex .sizing.reset-size8.size7, .katex .fontsize-ensurer.reset-size8.size7 { font-size: 0.833333em; }
.katex .sizing.reset-size8.size8, .katex .fontsize-ensurer.reset-size8.size8 { font-size: 1em; }
.katex .sizing.reset-size8.size9, .katex .fontsize-ensurer.reset-size8.size9 { font-size: 1.2em; }
.katex .sizing.reset-size8.size10, .katex .fontsize-ensurer.reset-size8.size10 { font-size: 1.44028em; }
.katex .sizing.reset-size8.size11, .katex .fontsize-ensurer.reset-size8.size11 { font-size: 1.72778em; }
.katex .sizing.reset-size9.size1, .katex .fontsize-ensurer.reset-size9.size1 { font-size: 0.289352em; }
.katex .sizing.reset-size9.size2, .katex .fontsize-ensurer.reset-size9.size2 { font-size: 0.347222em; }
.katex .sizing.reset-size9.size3, .katex .fontsize-ensurer.reset-size9.size3 { font-size: 0.405093em; }
.katex .sizing.reset-size9.size4, .katex .fontsize-ensurer.reset-size9.size4 { font-size: 0.462963em; }
.katex .sizing.reset-size9.size5, .katex .fontsize-ensurer.reset-size9.size5 { font-size: 0.520833em; }
.katex .sizing.reset-size9.size6, .katex .fontsize-ensurer.reset-size9.size6 { font-size: 0.578704em; }
.katex .sizing.reset-size9.size7, .katex .fontsize-ensurer.reset-size9.size7 { font-size: 0.694444em; }
.katex .sizing.reset-size9.size8, .katex .fontsize-ensurer.reset-size9.size8 { font-size: 0.833333em; }
.katex .sizing.reset-size9.size9, .katex .fontsize-ensurer.reset-size9.size9 { font-size: 1em; }
.katex .sizing.reset-size9.size10, .katex .fontsize-ensurer.reset-size9.size10 { font-size: 1.20023em; }
.katex .sizing.reset-size9.size11, .katex .fontsize-ensurer.reset-size9.size11 { font-size: 1.43981em; }
.katex .sizing.reset-size10.size1, .katex .fontsize-ensurer.reset-size10.size1 { font-size: 0.24108em; }
.katex .sizing.reset-size10.size2, .katex .fontsize-ensurer.reset-size10.size2 { font-size: 0.289296em; }
.katex .sizing.reset-size10.size3, .katex .fontsize-ensurer.reset-size10.size3 { font-size: 0.337512em; }
.katex .sizing.reset-size10.size4, .katex .fontsize-ensurer.reset-size10.size4 { font-size: 0.385728em; }
.katex .sizing.reset-size10.size5, .katex .fontsize-ensurer.reset-size10.size5 { font-size: 0.433944em; }
.katex .sizing.reset-size10.size6, .katex .fontsize-ensurer.reset-size10.size6 { font-size: 0.48216em; }
.katex .sizing.reset-size10.size7, .katex .fontsize-ensurer.reset-size10.size7 { font-size: 0.578592em; }
.katex .sizing.reset-size10.size8, .katex .fontsize-ensurer.reset-size10.size8 { font-size: 0.694311em; }
.katex .sizing.reset-size10.size9, .katex .fontsize-ensurer.reset-size10.size9 { font-size: 0.833173em; }
.katex .sizing.reset-size10.size10, .katex .fontsize-ensurer.reset-size10.size10 { font-size: 1em; }
.katex .sizing.reset-size10.size11, .katex .fontsize-ensurer.reset-size10.size11 { font-size: 1.19961em; }
.katex .sizing.reset-size11.size1, .katex .fontsize-ensurer.reset-size11.size1 { font-size: 0.200965em; }
.katex .sizing.reset-size11.size2, .katex .fontsize-ensurer.reset-size11.size2 { font-size: 0.241158em; }
.katex .sizing.reset-size11.size3, .katex .fontsize-ensurer.reset-size11.size3 { font-size: 0.281351em; }
.katex .sizing.reset-size11.size4, .katex .fontsize-ensurer.reset-size11.size4 { font-size: 0.321543em; }
.katex .sizing.reset-size11.size5, .katex .fontsize-ensurer.reset-size11.size5 { font-size: 0.361736em; }
.katex .sizing.reset-size11.size6, .katex .fontsize-ensurer.reset-size11.size6 { font-size: 0.401929em; }
.katex .sizing.reset-size11.size7, .katex .fontsize-ensurer.reset-size11.size7 { font-size: 0.482315em; }
.katex .sizing.reset-size11.size8, .katex .fontsize-ensurer.reset-size11.size8 { font-size: 0.578778em; }
.katex .sizing.reset-size11.size9, .katex .fontsize-ensurer.reset-size11.size9 { font-size: 0.694534em; }
.katex .sizing.reset-size11.size10, .katex .fontsize-ensurer.reset-size11.size10 { font-size: 0.833601em; }
.katex .sizing.reset-size11.size11, .katex .fontsize-ensurer.reset-size11.size11 { font-size: 1em; }
.katex .delimsizing.size1 { font-family: KaTeX_Size1; }
.katex .delimsizing.size2 { font-family: KaTeX_Size2; }
.katex .delimsizing.size3 { font-family: KaTeX_Size3; }
.katex .delimsizing.size4 { font-family: KaTeX_Size4; }
.katex .delimsizing.mult .delim-size1 > span { font-family: KaTeX_Size1; }
.katex .delimsizing.mult .delim-size4 > span { font-family: KaTeX_Size4; }
.katex .nulldelimiter { display: inline-block; width: 0.12em; }
.katex .delimcenter { position: relative; }
.katex .op-symbol { position: relative; }
.katex .op-symbol.small-op { font-family: KaTeX_Size1; }
.katex .op-symbol.large-op { font-family: KaTeX_Size2; }
.katex .op-limits > .vlist-t { text-align: center; }
.katex .accent > .vlist-t { text-align: center; }
.katex .accent .accent-body:not(.accent-full) { width: 0px; }
.katex .accent .accent-body { position: relative; }
.katex .overlay { display: block; }
.katex .mtable .vertical-separator { display: inline-block; margin: 0px -0.025em; border-right: 0.05em solid; }
.katex .mtable .vs-dashed { border-right: 0.05em dashed; }
.katex .mtable .arraycolsep { display: inline-block; }
.katex .mtable .col-align-c > .vlist-t { text-align: center; }
.katex .mtable .col-align-l > .vlist-t { text-align: left; }
.katex .mtable .col-align-r > .vlist-t { text-align: right; }
.katex .svg-align { text-align: left; }
.katex svg, .screenShotTempCanvas { display: block; position: absolute; width: 100%; height: inherit; fill: currentcolor; stroke: currentcolor; fill-rule: nonzero; fill-opacity: 1; stroke-width: 1px; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 4; stroke-dasharray: none; stroke-dashoffset: 0px; stroke-opacity: 1; }
.katex svg path { stroke: none; }
.katex .stretchy { width: 100%; display: block; position: relative; overflow: hidden; }
.katex .stretchy::before, .katex .stretchy::after { content: ""; }
.katex .hide-tail { width: 100%; position: relative; overflow: hidden; }
.katex .halfarrow-left { position: absolute; left: 0px; width: 50.2%; overflow: hidden; }
.katex .halfarrow-right { position: absolute; right: 0px; width: 50.2%; overflow: hidden; }
.katex .brace-left { position: absolute; left: 0px; width: 25.1%; overflow: hidden; }
.katex .brace-center { position: absolute; left: 25%; width: 50%; overflow: hidden; }
.katex .brace-right { position: absolute; right: 0px; width: 25.1%; overflow: hidden; }
.katex .x-arrow-pad { padding: 0px 0.5em; }
.katex .x-arrow, .katex .mover, .katex .munder { text-align: center; }
.katex .boxpad { padding: 0px 0.3em; }
.katex .fbox { box-sizing: border-box; border: 0.04em solid black; }
.katex .fcolorbox { box-sizing: border-box; border: 0.04em solid; }
.katex .cancel-pad { padding: 0px 0.2em; }
.katex .cancel-lap { margin-left: -0.2em; margin-right: -0.2em; }
.katex .sout { border-bottom-style: solid; border-bottom-width: 0.08em; }
.output_wrapper pre code { display: -webkit-box !important; } 
.output_wrapper .hljs{color: rgb(169, 183, 198); background: rgb(40, 43, 46) none repeat scroll 0% 0%; display: block; overflow-x: auto; padding: 0.5em;}

.output_wrapper .hljs-params{color: rgb(255, 152, 35);}

.output_wrapper .hljs-number,.output_wrapper  .hljs-literal,.output_wrapper  .hljs-symbol,.output_wrapper  .hljs-bullet{color: rgb(174, 135, 250);}

.output_wrapper .hljs-function,.output_wrapper  .hljs-built_in,.output_wrapper  .hljs-name,.output_wrapper  .hljs-keyword,.output_wrapper  .hljs-selector-tag,.output_wrapper  .hljs-deletion{color: rgb(248, 35, 117);}

.output_wrapper .hljs-variable,.output_wrapper  .hljs-template-variable,.output_wrapper  .hljs-link{color: rgb(98, 151, 85);}

.output_wrapper .hljs-comment,.output_wrapper  .hljs-quote{color: rgb(128, 128, 128);}

.output_wrapper .hljs-meta{color: rgb(91, 218, 237);}

.output_wrapper .hljs-string,.output_wrapper  .hljs-attribute,.output_wrapper  .hljs-addition{color: rgb(238, 220, 112);}

.output_wrapper .hljs-attr,.output_wrapper  .hljs-section,.output_wrapper  .hljs-title,.output_wrapper  .hljs-type{color: rgb(165, 218, 45);}

.output_wrapper .hljs-selector-class{color: rgb(165, 218, 45);}

.output_wrapper .hljs-emphasis{font-style: italic;}

.output_wrapper .hljs-strong{font-weight: bold;}
 
.output_wrapper pre code {line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px;} 
.output_wrapper{font-size: 16px; color: rgb(62, 62, 62); line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;}

.output_wrapper *{font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;}

.output_wrapper p{margin: 1.5em 0px;}

.output_wrapper h1,.output_wrapper  h2,.output_wrapper  h3,.output_wrapper  h4,.output_wrapper  h5,.output_wrapper  h6{margin: 1.5em 0px; font-weight: bold;}

.output_wrapper h1{font-size: 1.6em;}

.output_wrapper h2{font-size: 1.4em;}

.output_wrapper h3{font-size: 1.3em;}

.output_wrapper h4{font-size: 1.2em;}

.output_wrapper h5{font-size: 1em;}

.output_wrapper h6{font-size: 1em;}

.output_wrapper h3{margin-bottom: 2em; margin-right: 5px; padding: 8px 15px; letter-spacing: 2px; background-image: linear-gradient(to right bottom, rgb(0, 188, 212), rgb(63, 81, 181)); background-color: rgb(63, 81, 181); color: rgb(255, 255, 255); border-left: 10px solid rgb(51, 51, 51); border-radius: 5px; text-shadow: rgb(102, 102, 102) 1px 1px 1px; box-shadow: rgb(102, 102, 102) 1px 1px 2px;}

.output_wrapper ul,.output_wrapper  ol{padding-left: 32px;}

.output_wrapper ul{list-style-type: disc;}

.output_wrapper ol{list-style-type: decimal;}

.output_wrapper li *{}

.output_wrapper li{margin-bottom: 0.5em;}

.output_wrapper .code_size_default{line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px;}

.output_wrapper .code_size_tight{line-height: 15px; font-size: 11px; font-weight: normal; word-spacing: -3px; letter-spacing: 0px;}

.output_wrapper pre code{font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px;}

.output_wrapper blockquote{display: block; padding: 15px 15px 15px 1rem; font-size: 0.9em; margin: 1em 0px; color: rgb(129, 145, 152); border-left: 6px solid rgb(220, 230, 240); background: rgb(242, 247, 251) none repeat scroll 0% 0%; overflow: auto; overflow-wrap: normal; word-break: normal;}

.output_wrapper blockquote p{margin: 0px;}

.output_wrapper a{text-decoration: none; color: rgb(30, 107, 184); overflow-wrap: break-word;}

.output_wrapper strong{font-weight: bold;}

.output_wrapper em{font-style: italic;}

.output_wrapper del{font-style: italic;}

.output_wrapper strong em{font-weight: bold;}

.output_wrapper hr{height: 1px; margin: 1.5rem 0px; border-color: rgb(165, 165, 165) currentcolor currentcolor; border-style: dashed none none; border-width: 1px medium medium; border-image: none 100% / 1 / 0 stretch;}

.output_wrapper code{overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(233, 105, 0); background: rgb(248, 248, 248) none repeat scroll 0% 0%;}

.output_wrapper img{display: block; margin: 0px auto; max-width: 100%;}

.output_wrapper figcaption{margin-top: 10px; text-align: center; color: rgb(153, 153, 153); font-size: 0.7em;}

.output_wrapper table{display: table; width: 100%; text-align: left;}

.output_wrapper tbody{border: 0px none;}

.output_wrapper table tr{border-color: rgb(204, 204, 204) currentcolor currentcolor; border-style: solid none none; border-width: 1px 0px 0px; border-image: none 100% / 1 / 0 stretch; background-color: white;}

.output_wrapper table tr th,.output_wrapper  table tr td{font-size: 1em; border: 1px solid rgb(204, 204, 204); padding: 0.5em 1em; text-align: left;}

.output_wrapper table tr th{font-weight: bold; background-color: rgb(240, 240, 240);}

.output_wrapper .katex-display{font-size: 1.22em;}

.output_wrapper .katex{padding: 8px 3px;}

.output_wrapper .katex-display > .katex{display: inline-block; text-align: center; padding: 3px;}

.output_wrapper .katex img{display: inline-block; vertical-align: middle;}

.output_wrapper a[href^="#"] sup{vertical-align: super; margin: 0px 2px; padding: 1px 3px; color: rgb(255, 255, 255); background: rgb(102, 102, 102) none repeat scroll 0% 0%; font-size: 0.7em;}

.output_wrapper .task-list-list{list-style-type: none;}

.output_wrapper .task-list-list.checked{color: rgb(62, 62, 62);}

.output_wrapper .task-list-list.uncheck{color: rgb(191, 193, 191);}

.output_wrapper .task-list-list .icon_uncheck,.output_wrapper  .task-list-list .icon_check{display: inline-block; vertical-align: middle; margin-right: 10px;}

.output_wrapper .task-list-list .icon_check::before{content: "√"; border: 2px solid rgb(62, 62, 62); color: red;}

.output_wrapper .task-list-list .icon_uncheck::before{content: "x"; border: 2px solid rgb(191, 193, 191); color: rgb(191, 193, 191);}

.output_wrapper .task-list-list .icon_check::before,.output_wrapper  .task-list-list .icon_uncheck::before{padding: 2px 8px 2px 5px; border-radius: 5px;}

.output_wrapper .toc{margin-left: 25px;}

.output_wrapper .toc_item{display: block;}

.output_wrapper .toc_left{margin-left: 25px;}
 
</style>  
  <style type="text/css" id="export_setting_css">body { width: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255) none repeat scroll 0% 0%; }
#export_content { margin: 40px 20%; padding: 20px; background: rgb(255, 255, 255) none repeat scroll 0% 0%; }</style>  

</head><body><div id="export_content"><div class="output_wrapper" id="output_wrapper_id"><h1 id="hpaligncenterfontsize6llvm3myriscvfontp"><span><p align="center"><strong><font size="6">LLVM 之后端篇（3）：如何添加 MyRISCV 目标后端的第一条指令</font></strong></p></span></h1>
<p align="right">Author: stormQ</p>
<p align="right">Created: Sunday, 09. January 2022 11:47AM</p>
<p align="right">Last Modified: Tuesday, 22. February 2022 10:10PM</p>
<hr>
<ul>
<li><h3 id="h"><span>目录</span></h3>
<ul>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump摘要">摘要</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump0">测试程序</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump1">描述目标属性</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump2">定义寄存器和寄存器类</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump3">定义指令</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump4">定义调用约定</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump5">支持生成汇编代码</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jump6">构建并运行</a></p>
<p class="task-list-list checked" style="list-style-type: none;"><i class="icon_check"></i><a href="#jumpReferences">References</a></p></ul><p></p>
</li></ul>
<hr>
<h3 id="hspanidjumpspan"><span><span id="jump摘要">摘要</span></span></h3>
<p>本文基于<code>release/13.x</code>版本的 LLVM 源码，介绍了在注册目标后端<code>MyRISCV</code>后如何为其添加第一条指令。从而，能够将本文的 LLVM IR 测试程序翻译成汇编代码。</p>
<hr>
<h3 id="hspanidjump0span"><span><span id="jump0">测试程序</span></span></h3>
<p>测试程序 test.ll：</p>
<pre><code class="hljs nginx"><span class="hljs-attribute">define</span>&nbsp;i32&nbsp;<span class="hljs-variable">@test</span>()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attribute">ret</span>&nbsp;i32&nbsp;<span class="hljs-number">1</span><br>}<br></code></pre>
<p>生成目标后端<code>riscv32</code>的汇编代码（作为对照结果）：</p>
<pre><code class="hljs cpp">$&nbsp;llc&nbsp;-march=riscv32&nbsp;-filetype=<span class="hljs-keyword">asm</span>&nbsp;test.ll&nbsp;-o&nbsp;test.s<br></code></pre>
<p>test.s 的内容如下：</p>
<pre><code class="hljs bash">&nbsp;&nbsp;&nbsp;&nbsp;.text<br>&nbsp;&nbsp;&nbsp;&nbsp;.attribute&nbsp;&nbsp;4,&nbsp;16<br>&nbsp;&nbsp;&nbsp;&nbsp;.attribute&nbsp;&nbsp;5,&nbsp;<span class="hljs-string">"rv32i2p0"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;.file&nbsp;&nbsp;&nbsp;<span class="hljs-string">"test.ll"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;.globl&nbsp;&nbsp;<span class="hljs-built_in">test</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;--&nbsp;Begin&nbsp;function&nbsp;test</span><br>&nbsp;&nbsp;&nbsp;&nbsp;.p2align&nbsp;&nbsp;&nbsp;&nbsp;2<br>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="hljs-built_in">type</span>&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">test</span>,@<span class="hljs-keyword">function</span><br><span class="hljs-built_in">test</span>:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;@test</span><br>&nbsp;&nbsp;&nbsp;&nbsp;.cfi_startproc<br><span class="hljs-comment">#&nbsp;%bb.0:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;addi&nbsp;&nbsp;&nbsp;&nbsp;a0,&nbsp;zero,&nbsp;1<br>&nbsp;&nbsp;&nbsp;&nbsp;ret<br>.Lfunc_end0:<br>&nbsp;&nbsp;&nbsp;&nbsp;.size&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">test</span>,&nbsp;.Lfunc_end0-test<br>&nbsp;&nbsp;&nbsp;&nbsp;.cfi_endproc<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;--&nbsp;End&nbsp;function</span><br>&nbsp;&nbsp;&nbsp;&nbsp;.section&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">".note.GNU-stack"</span>,<span class="hljs-string">""</span>,@progbits<br></code></pre>
<p>从上面的结果可以看出，目标后端<code>riscv32</code>将 LLVM IR 语句<code>ret i32 1</code>翻译成了<code>addi    a0, zero, 1</code>和<code>ret</code>两条汇编代码。</p>
<p>接下来，在目标后端<code>MyRISCV</code>中实现相同的功能。</p>
<hr>
<h3 id="hspanidjump1span"><span><span id="jump1">描述目标属性</span></span></h3>
<p>LLVM 中，<code>&lt;Target&gt;.td</code>文件用于描述目标属性，比如：支持的指令集、处理器等。同时，也作为主文件包含其它<code>.td</code>文件。</p>
<p>对于<code>MyRISCV</code>目标后端，<code>MyRISCV.td</code>位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs ruby">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-keyword">include</span>&nbsp;<span class="hljs-string">"llvm/Target/Target.td"</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<span class="hljs-keyword">include</span>&nbsp;<span class="hljs-string">"MyRISCVRegisterInfo.td"</span><br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-keyword">include</span>&nbsp;<span class="hljs-string">"MyRISCVInstrInfo.td"</span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-keyword">include</span>&nbsp;<span class="hljs-string">"MyRISCVCallingConv.td"</span><br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span>&nbsp;:&nbsp;<span class="hljs-title">ProcessorModel</span><span class="hljs-title">&lt;</span>"<span class="hljs-title">generic</span><span class="hljs-title">-</span><span class="hljs-title">rv32</span>",&nbsp;<span class="hljs-title">NoSchedModel</span>,&nbsp;<span class="hljs-title">[]</span><span class="hljs-title">&gt;</span>;</span><br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span>&nbsp;<span class="hljs-title">MyRISCVInstrInfo</span>&nbsp;:&nbsp;<span class="hljs-title">InstrInfo</span>;</span><br>&nbsp;<span class="hljs-number">10</span>&nbsp;<br>&nbsp;<span class="hljs-number">11</span>&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span>&nbsp;<span class="hljs-title">MyRISCV</span>&nbsp;:&nbsp;<span class="hljs-title">Target</span>&nbsp;{</span><br>&nbsp;<span class="hljs-number">12</span>&nbsp;&nbsp;&nbsp;let&nbsp;InstructionSet&nbsp;=&nbsp;MyRISCVInstrInfo;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;}<br></code></pre>
<ul>
<li><p>第 1 行，用于包含<code>InstrInfo</code>、<code>Target</code>等抽象记录的定义。</p></li>
<li><p>第 3～5 行，分别包含用于描述寄存器、指令、调用约定的<code>.td</code>文件。</p></li>
<li><p>第 7 行，定义支持的处理器类型。抽象记录<code>ProcessorModel</code>的第 1 个参数表示处理器的名称（这里为<code>generic-rv32</code>，也可以是其它名称），第 2 个参数表示处理器的调度模型（为了简单起见，这里为<code>NoSchedModel</code>，也可以自定义调度模型）。<strong>需要注意的是，</strong> 至少要定义一种支持的处理器类型，否则编译时会报错<code>error: zero-size array ‘llvm::MyRISCVSubTypeKV’</code>。</p></li>
<li><p>第 9 行，定义指令的全局属性（这里使用抽象记录<code>InstrInfo</code>中的默认值）。每个目标后端都必须实例化抽象记录<code>InstrInfo</code>（这里为<code>MyRISCVInstrInfo</code>，也可以是其它名称）。</p></li>
<li><p>第 11～13 行，定义目标的全局属性（这里仅指定了指令属性为<code>MyRISCVInstrInfo</code>，其它字段使用抽象记录<code>Target</code>中的默认值）。每个目标后端都必须实例化抽象记录<code>Target</code>（这里为<code>MyRISCV</code>，也可以是其它名称）。<strong>需要注意的是，</strong> 这里的实例名称<code>MyRISCV</code>会影响<code>MyRISCVGenSubtargetInfo.inc</code>、<code>MyRISCVGenInstrInfo.inc</code>、<code>MyRISCVGenRegisterInfo.inc</code>等<code>.inc</code>文件的生成。比如：结构体<code>MyRISCVGenSubtargetInfo</code>、<code>MyRISCVGenInstrInfo</code>、<code>MyRISCVGenRegisterInfo</code>等前部分的内容即为这里的实例名称。</p></li>
</ul>
<hr>
<h3 id="hspanidjump2span"><span><span id="jump2">定义寄存器和寄存器类</span></span></h3>
<p>LLVM 中，<code>&lt;Target&gt;RegisterInfo.td</code>文件用于描述寄存器和寄存器类。寄存器类是一组具有相同大小的寄存器集合，同时也定义了寄存器分配的默认先后顺序。</p>
<p>对于<code>MyRISCV</code>目标后端，<code>MyRISCVRegisterInfo.td</code>位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs vbscript">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;MyRISCVReg&lt;bits&lt;<span class="hljs-number">5</span>&gt;&nbsp;enc,&nbsp;<span class="hljs-built_in">string</span>&nbsp;name,&nbsp;list&lt;<span class="hljs-built_in">string</span>&gt;&nbsp;alt&nbsp;=&nbsp;[]&gt;<br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Register&lt;name,&nbsp;alt&gt;&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">let</span>&nbsp;HWEncoding{<span class="hljs-number">4</span><span class="hljs-number">-0</span>}&nbsp;=&nbsp;enc;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">let</span>&nbsp;Namespace&nbsp;=&nbsp;<span class="hljs-string">"MyRISCV"</span>;<br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;}<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;def&nbsp;ABIRegAltName&nbsp;:&nbsp;RegAltNameIndex;<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-keyword">let</span>&nbsp;RegAltNameIndices&nbsp;=&nbsp;[ABIRegAltName]&nbsp;<span class="hljs-keyword">in</span>&nbsp;{<br>&nbsp;<span class="hljs-number">10</span>&nbsp;&nbsp;&nbsp;def&nbsp;X0&nbsp;&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">0</span>,&nbsp;&nbsp;<span class="hljs-string">"x0"</span>,&nbsp;&nbsp;[<span class="hljs-string">"zero"</span>]&gt;;<br>&nbsp;<span class="hljs-number">11</span>&nbsp;&nbsp;&nbsp;def&nbsp;X1&nbsp;&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">1</span>,&nbsp;&nbsp;<span class="hljs-string">"x1"</span>,&nbsp;&nbsp;[<span class="hljs-string">"ra"</span>]&gt;;<br>&nbsp;<span class="hljs-number">12</span>&nbsp;&nbsp;&nbsp;def&nbsp;X2&nbsp;&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">2</span>,&nbsp;&nbsp;<span class="hljs-string">"x2"</span>,&nbsp;&nbsp;[<span class="hljs-string">"sp"</span>]&gt;;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;&nbsp;&nbsp;def&nbsp;X3&nbsp;&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">3</span>,&nbsp;&nbsp;<span class="hljs-string">"x3"</span>,&nbsp;&nbsp;[<span class="hljs-string">"gp"</span>]&gt;;<br>&nbsp;<span class="hljs-number">14</span>&nbsp;&nbsp;&nbsp;def&nbsp;X4&nbsp;&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">4</span>,&nbsp;&nbsp;<span class="hljs-string">"x4"</span>,&nbsp;&nbsp;[<span class="hljs-string">"tp"</span>]&gt;;<br>&nbsp;<span class="hljs-number">15</span>&nbsp;&nbsp;&nbsp;def&nbsp;X5&nbsp;&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">5</span>,&nbsp;&nbsp;<span class="hljs-string">"x5"</span>,&nbsp;&nbsp;[<span class="hljs-string">"t0"</span>]&gt;;<br>&nbsp;<span class="hljs-number">16</span>&nbsp;&nbsp;&nbsp;def&nbsp;X6&nbsp;&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">6</span>,&nbsp;&nbsp;<span class="hljs-string">"x6"</span>,&nbsp;&nbsp;[<span class="hljs-string">"t1"</span>]&gt;;<br>&nbsp;<span class="hljs-number">17</span>&nbsp;&nbsp;&nbsp;def&nbsp;X7&nbsp;&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">7</span>,&nbsp;&nbsp;<span class="hljs-string">"x7"</span>,&nbsp;&nbsp;[<span class="hljs-string">"t2"</span>]&gt;;<br>&nbsp;<span class="hljs-number">18</span>&nbsp;&nbsp;&nbsp;def&nbsp;X8&nbsp;&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">8</span>,&nbsp;&nbsp;<span class="hljs-string">"x8"</span>,&nbsp;&nbsp;[<span class="hljs-string">"s0"</span>,&nbsp;<span class="hljs-string">"fp"</span>]&gt;;<br>&nbsp;<span class="hljs-number">19</span>&nbsp;&nbsp;&nbsp;def&nbsp;X9&nbsp;&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">9</span>,&nbsp;&nbsp;<span class="hljs-string">"x9"</span>,&nbsp;&nbsp;[<span class="hljs-string">"s1"</span>]&gt;;<br>&nbsp;<span class="hljs-number">20</span>&nbsp;&nbsp;&nbsp;def&nbsp;X10&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">10</span>,&nbsp;<span class="hljs-string">"x10"</span>,&nbsp;[<span class="hljs-string">"a0"</span>]&gt;;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;&nbsp;&nbsp;def&nbsp;X11&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">11</span>,&nbsp;<span class="hljs-string">"x11"</span>,&nbsp;[<span class="hljs-string">"a1"</span>]&gt;;<br>&nbsp;<span class="hljs-number">22</span>&nbsp;&nbsp;&nbsp;def&nbsp;X12&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">12</span>,&nbsp;<span class="hljs-string">"x12"</span>,&nbsp;[<span class="hljs-string">"a2"</span>]&gt;;<br>&nbsp;<span class="hljs-number">23</span>&nbsp;&nbsp;&nbsp;def&nbsp;X13&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">13</span>,&nbsp;<span class="hljs-string">"x13"</span>,&nbsp;[<span class="hljs-string">"a3"</span>]&gt;;<br>&nbsp;<span class="hljs-number">24</span>&nbsp;&nbsp;&nbsp;def&nbsp;X14&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">14</span>,&nbsp;<span class="hljs-string">"x14"</span>,&nbsp;[<span class="hljs-string">"a4"</span>]&gt;;<br>&nbsp;<span class="hljs-number">25</span>&nbsp;&nbsp;&nbsp;def&nbsp;X15&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">15</span>,&nbsp;<span class="hljs-string">"x15"</span>,&nbsp;[<span class="hljs-string">"a5"</span>]&gt;;<br>&nbsp;<span class="hljs-number">26</span>&nbsp;&nbsp;&nbsp;def&nbsp;X16&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">16</span>,&nbsp;<span class="hljs-string">"x16"</span>,&nbsp;[<span class="hljs-string">"a6"</span>]&gt;;<br>&nbsp;<span class="hljs-number">27</span>&nbsp;&nbsp;&nbsp;def&nbsp;X17&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">17</span>,&nbsp;<span class="hljs-string">"x17"</span>,&nbsp;[<span class="hljs-string">"a7"</span>]&gt;;<br>&nbsp;<span class="hljs-number">28</span>&nbsp;&nbsp;&nbsp;def&nbsp;X18&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">18</span>,&nbsp;<span class="hljs-string">"x18"</span>,&nbsp;[<span class="hljs-string">"s2"</span>]&gt;;<br>&nbsp;<span class="hljs-number">29</span>&nbsp;&nbsp;&nbsp;def&nbsp;X19&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">19</span>,&nbsp;<span class="hljs-string">"x19"</span>,&nbsp;[<span class="hljs-string">"s3"</span>]&gt;;<br>&nbsp;<span class="hljs-number">30</span>&nbsp;&nbsp;&nbsp;def&nbsp;X20&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">20</span>,&nbsp;<span class="hljs-string">"x20"</span>,&nbsp;[<span class="hljs-string">"s4"</span>]&gt;;<br>&nbsp;<span class="hljs-number">31</span>&nbsp;&nbsp;&nbsp;def&nbsp;X21&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">21</span>,&nbsp;<span class="hljs-string">"x21"</span>,&nbsp;[<span class="hljs-string">"s5"</span>]&gt;;<br>&nbsp;<span class="hljs-number">32</span>&nbsp;&nbsp;&nbsp;def&nbsp;X22&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">22</span>,&nbsp;<span class="hljs-string">"x22"</span>,&nbsp;[<span class="hljs-string">"s6"</span>]&gt;;<br>&nbsp;<span class="hljs-number">33</span>&nbsp;&nbsp;&nbsp;def&nbsp;X23&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">23</span>,&nbsp;<span class="hljs-string">"x23"</span>,&nbsp;[<span class="hljs-string">"s7"</span>]&gt;;<br>&nbsp;<span class="hljs-number">34</span>&nbsp;&nbsp;&nbsp;def&nbsp;X24&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">24</span>,&nbsp;<span class="hljs-string">"x24"</span>,&nbsp;[<span class="hljs-string">"s8"</span>]&gt;;<br>&nbsp;<span class="hljs-number">35</span>&nbsp;&nbsp;&nbsp;def&nbsp;X25&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">25</span>,&nbsp;<span class="hljs-string">"x25"</span>,&nbsp;[<span class="hljs-string">"s9"</span>]&gt;;<br>&nbsp;<span class="hljs-number">36</span>&nbsp;&nbsp;&nbsp;def&nbsp;X26&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">26</span>,&nbsp;<span class="hljs-string">"x26"</span>,&nbsp;[<span class="hljs-string">"s10"</span>]&gt;;<br>&nbsp;<span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;def&nbsp;X27&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">27</span>,&nbsp;<span class="hljs-string">"x27"</span>,&nbsp;[<span class="hljs-string">"s11"</span>]&gt;;<br>&nbsp;<span class="hljs-number">38</span>&nbsp;&nbsp;&nbsp;def&nbsp;X28&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">28</span>,&nbsp;<span class="hljs-string">"x28"</span>,&nbsp;[<span class="hljs-string">"t3"</span>]&gt;;<br>&nbsp;<span class="hljs-number">39</span>&nbsp;&nbsp;&nbsp;def&nbsp;X29&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">29</span>,&nbsp;<span class="hljs-string">"x29"</span>,&nbsp;[<span class="hljs-string">"t4"</span>]&gt;;<br>&nbsp;<span class="hljs-number">40</span>&nbsp;&nbsp;&nbsp;def&nbsp;X30&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">30</span>,&nbsp;<span class="hljs-string">"x30"</span>,&nbsp;[<span class="hljs-string">"t5"</span>]&gt;;<br>&nbsp;<span class="hljs-number">41</span>&nbsp;&nbsp;&nbsp;def&nbsp;X31&nbsp;:&nbsp;MyRISCVReg&lt;<span class="hljs-number">31</span>,&nbsp;<span class="hljs-string">"x31"</span>,&nbsp;[<span class="hljs-string">"t6"</span>]&gt;;<br>&nbsp;<span class="hljs-number">42</span>&nbsp;}<br>&nbsp;<span class="hljs-number">43</span>&nbsp;<br>&nbsp;<span class="hljs-number">44</span>&nbsp;def&nbsp;GPR&nbsp;:&nbsp;RegisterClass&lt;<span class="hljs-string">"MyRISCV"</span>,&nbsp;[i32],&nbsp;<span class="hljs-number">32</span>,&nbsp;(add<br>&nbsp;<span class="hljs-number">45</span>&nbsp;&nbsp;&nbsp;(sequence&nbsp;<span class="hljs-string">"X%u"</span>,&nbsp;<span class="hljs-number">10</span>,&nbsp;<span class="hljs-number">17</span>),<br>&nbsp;<span class="hljs-number">46</span>&nbsp;&nbsp;&nbsp;(sequence&nbsp;<span class="hljs-string">"X%u"</span>,&nbsp;<span class="hljs-number">5</span>,&nbsp;<span class="hljs-number">7</span>),<br>&nbsp;<span class="hljs-number">47</span>&nbsp;&nbsp;&nbsp;(sequence&nbsp;<span class="hljs-string">"X%u"</span>,&nbsp;<span class="hljs-number">28</span>,&nbsp;<span class="hljs-number">31</span>),<br>&nbsp;<span class="hljs-number">48</span>&nbsp;&nbsp;&nbsp;(sequence&nbsp;<span class="hljs-string">"X%u"</span>,&nbsp;<span class="hljs-number">8</span>,&nbsp;<span class="hljs-number">9</span>),<br>&nbsp;<span class="hljs-number">49</span>&nbsp;&nbsp;&nbsp;(sequence&nbsp;<span class="hljs-string">"X%u"</span>,&nbsp;<span class="hljs-number">18</span>,&nbsp;<span class="hljs-number">27</span>),<br>&nbsp;<span class="hljs-number">50</span>&nbsp;&nbsp;&nbsp;(sequence&nbsp;<span class="hljs-string">"X%u"</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">4</span>)<br>&nbsp;<span class="hljs-number">51</span>&nbsp;)&gt;;<br></code></pre>
<ul>
<li><p>第 1～5 行，定义抽象记录<code>MyRISCVReg</code>，便于定义后面的寄存器。其第 1 个参数表示寄存器的编码（占用 5 个 bits），第 2 个参数表示寄存器的名称，第 3 个参数表示寄存器的别名列表。LLVM 中，每个寄存器定义（比如<code>X0</code>）都会由 TableGen 生成唯一的标识符（比如<code>llvm::MyRISCV::X0</code>，定义在<code>MyRISCVGenRegisterInfo.inc</code>文件中）。而字段<code>Namespace</code>的值指定了这些标识符所在的命令空间。</p></li>
<li><p>第 7、9、42 行（optional），定义寄存器别名选择类型<code>ABIRegAltName</code>，并允许应用于<code>X0~X31</code>寄存器。这意味着，生成汇编代码时，可以打印寄存器的名称（比如<code>x0</code>），也可以打印寄存器的别名（比如<code>zero</code>）。其实现位于<code>llvm/lib/Target/MyRISCV/MCTargetDesc/MyRISCVInstPrinter.cpp</code>文件中。</p></li>
<li><p>第 10～41 行，定义<code>X0~X31</code>32 个寄存器。这些寄存器的用途可参考《<a href="https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMAFDQC/riscv-spec-20191213.pdf"><font size="4">riscv-spec-20191213</font></a>》Table 25.1: Assembler mnemonics for RISC-V integer and floating-point registers, and their role in the first standard calling convention。</p></li>
<li><p>第 44～51 行，定义 32-bit 通用寄存器<code>GPR</code>。抽象记录<code>RegisterClass</code>的第 1 个参数表示命令空间，第 2 个参数表示该寄存器类所支持的数据类型，第 3 个参数表示对齐要求（单位：bit，通常为寄存器大小），第 4 个参数表示包含哪些寄存器以及默认的寄存器分配顺序，排放规则通常为：由调用者保存的寄存器 -&gt; 由被调用者保存的寄存器 -&gt; 特殊的寄存器。比如：寄存器<code>x10~x17</code>用于存放函数参数，由调用者保存，所以放到靠前的位置，同时在寄存器分配时也会被优先分配。</p></li>
</ul>
<hr>
<h3 id="hspanidjump3span"><span><span id="jump3">定义指令</span></span></h3>
<p>LLVM 中，<code>&lt;Target&gt;InstrInfo.td</code>文件用于描述指令。</p>
<p>对于<code>MyRISCV</code>目标后端，<code>MyRISCVInstrInfo.td</code>位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs bash">&nbsp;&nbsp;1&nbsp;class&nbsp;RV32&nbsp;:&nbsp;Instruction&nbsp;{<br>&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Size&nbsp;=&nbsp;4;<br>&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Namespace&nbsp;=&nbsp;<span class="hljs-string">"MyRISCV"</span>;<br>&nbsp;&nbsp;4&nbsp;&nbsp;&nbsp;bits&lt;32&gt;&nbsp;Inst;<br>&nbsp;&nbsp;5&nbsp;}<br>&nbsp;&nbsp;6&nbsp;<br>&nbsp;&nbsp;7&nbsp;def&nbsp;MyRISCVRetFlag&nbsp;:&nbsp;SDNode&lt;<span class="hljs-string">"MyRISCVISD::RET_FLAG"</span>,&nbsp;SDTNone,<br>&nbsp;&nbsp;8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[SDNPHasChain,&nbsp;SDNPOptInGlue,&nbsp;SDNPVariadic]&gt;;<br>&nbsp;&nbsp;9&nbsp;<br>&nbsp;10&nbsp;def&nbsp;simm12&nbsp;:&nbsp;Operand&lt;i32&gt;,&nbsp;ImmLeaf&lt;i32,&nbsp;[{<span class="hljs-built_in">return</span>&nbsp;isInt&lt;12&gt;(Imm);}]&gt;;<br>&nbsp;11&nbsp;<br>&nbsp;12&nbsp;def&nbsp;ADDI&nbsp;:&nbsp;RV32&nbsp;{<br>&nbsp;13&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;OutOperandList&nbsp;=&nbsp;(outs&nbsp;GPR:<span class="hljs-variable">$rd</span>);<br>&nbsp;14&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;InOperandList&nbsp;=&nbsp;(ins&nbsp;GPR:<span class="hljs-variable">$rs1</span>,&nbsp;simm12:<span class="hljs-variable">$imm12</span>);<br>&nbsp;15&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;AsmString&nbsp;=&nbsp;<span class="hljs-string">"addi&nbsp;<span class="hljs-variable">$rd</span>,&nbsp;<span class="hljs-variable">$rs1</span>,&nbsp;<span class="hljs-variable">$imm12</span>"</span>;<br>&nbsp;16&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Pattern&nbsp;=&nbsp;[(<span class="hljs-built_in">set</span>&nbsp;GPR:<span class="hljs-variable">$rd</span>,&nbsp;(add&nbsp;GPR:<span class="hljs-variable">$rs1</span>,&nbsp;simm12:<span class="hljs-variable">$imm12</span>))];<br>&nbsp;17&nbsp;&nbsp;&nbsp;bits&lt;5&gt;&nbsp;rd;<br>&nbsp;18&nbsp;&nbsp;&nbsp;bits&lt;5&gt;&nbsp;rs1;<br>&nbsp;19&nbsp;&nbsp;&nbsp;bits&lt;12&gt;&nbsp;imm12;<br>&nbsp;20&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Inst{31-20}&nbsp;=&nbsp;imm12;<br>&nbsp;21&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Inst{19-15}&nbsp;=&nbsp;rs1;<br>&nbsp;22&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Inst{14-12}&nbsp;=&nbsp;0b000;<br>&nbsp;23&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Inst{11-7}&nbsp;=&nbsp;rd;<br>&nbsp;24&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Inst{6-0}&nbsp;=&nbsp;0b0010011;<br>&nbsp;25&nbsp;}<br>&nbsp;26&nbsp;<br>&nbsp;27&nbsp;def&nbsp;JALR&nbsp;:&nbsp;RV32&nbsp;{<br>&nbsp;28&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;OutOperandList&nbsp;=&nbsp;(outs&nbsp;GPR:<span class="hljs-variable">$rd</span>);<br>&nbsp;29&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;InOperandList&nbsp;=&nbsp;(ins&nbsp;GPR:<span class="hljs-variable">$rs1</span>,&nbsp;simm12:<span class="hljs-variable">$imm12</span>);<br>&nbsp;30&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;AsmString&nbsp;=&nbsp;<span class="hljs-string">"jalr&nbsp;<span class="hljs-variable">$rd</span>,&nbsp;<span class="hljs-variable">${imm12}</span>(<span class="hljs-variable">${rs1}</span>)"</span>;<br>&nbsp;31&nbsp;&nbsp;&nbsp;bits&lt;5&gt;&nbsp;rd;<br>&nbsp;32&nbsp;&nbsp;&nbsp;bits&lt;5&gt;&nbsp;rs1;<br>&nbsp;33&nbsp;&nbsp;&nbsp;bits&lt;12&gt;&nbsp;imm12;<br>&nbsp;34&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Inst{31-20}&nbsp;=&nbsp;imm12;<br>&nbsp;35&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Inst{19-15}&nbsp;=&nbsp;rs1;<br>&nbsp;36&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Inst{14-12}&nbsp;=&nbsp;0b000;<br>&nbsp;37&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Inst{11-7}&nbsp;=&nbsp;rd;<br>&nbsp;38&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Inst{6-0}&nbsp;=&nbsp;0b1101111;<br>&nbsp;39&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;isCall&nbsp;=&nbsp;1;<br>&nbsp;40&nbsp;}<br>&nbsp;41&nbsp;<br>&nbsp;42&nbsp;def&nbsp;:&nbsp;InstAlias&lt;<span class="hljs-string">"ret"</span>,&nbsp;(JALR&nbsp;X0,&nbsp;X1,&nbsp;0),&nbsp;4&gt;;<br>&nbsp;43&nbsp;<br>&nbsp;44&nbsp;def&nbsp;PseudoRET&nbsp;:&nbsp;RV32,&nbsp;PseudoInstExpansion&lt;(JALR&nbsp;X0,&nbsp;X1,&nbsp;0)&gt;&nbsp;{<br>&nbsp;45&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;OutOperandList&nbsp;=&nbsp;(outs);<br>&nbsp;46&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;InOperandList&nbsp;=&nbsp;(ins);<br>&nbsp;47&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;Pattern&nbsp;=&nbsp;[(MyRISCVRetFlag)];<br>&nbsp;48&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;isPseudo&nbsp;=&nbsp;1;<br>&nbsp;49&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;isReturn&nbsp;=&nbsp;1;<br>&nbsp;50&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">let</span>&nbsp;isTerminator&nbsp;=&nbsp;1;<br>&nbsp;51&nbsp;}<br></code></pre>
<ul>
<li><p>第 1～5 行，定义抽象记录<code>RV32</code>，用于定义 32-bit 指令的公共字段或值。字段<code>Size</code>表示指令编码占用的字节数。字段<code>Inst</code>表示指令的二进制编码。</p></li>
<li><p>第 7～8 行，定义<code>SDNode</code>节点<code>MyRISCVRetFlag</code>，其操作码为枚举值<code>MyRISCVISD::RET_FLAG</code>（定义在<code>llvm/lib/Target/MyRISCV/MyRISCVISelLowering.h</code>文件中），指令选择过程中需要用到。</p></li>
<li><p>第 10 行，定义 12-bit 的有符号立即数，数据类型为<code>i32</code>。</p></li>
<li><p>第 12～25 行，定义具象记录<code>ADDI</code>，用于表示<code>addi</code>指令。</p>
<p>字段<code>OutOperandList</code>表示指令的输出，<code>(outs GPR:$rd)</code>表示指令的输出是一个寄存器类<code>GPR</code>中的寄存器，即用<code>$rd</code>存放<code>addi</code>指令的运算结果。另外，需要定义同名的字段即<code>bits&lt;5&gt; rd;</code>。而<code>let Inst{11-7} = rd;</code>表示该寄存器在指令编码中占用低 7~11 bit（共 5 个 bits）。</p>
<p>字段<code>InOperandList</code>表示指令的输入，<code>(ins GPR:$rs1, simm12:$imm12)</code>表示指令的第 1 个操作数是寄存器类<code>GPR</code>中的寄存器（用<code>$rs1</code>表示），第 2 个操作数是类型为<code>simm12</code>的立即数（用<code>$imm12</code>表示）。同样地，也需要为这两个操作数定义同名的字段，以及在指令编码中占用哪些 bits。</p>
<p>字段<code>AsmString</code>表示指令的汇编代码格式，比如：<code>addi a0, zero, 1</code>。</p>
<p>字段<code>Pattern</code>表示指令的匹配模式，<code>[(set GPR:$rd, (add GPR:$rs1, simm12:$imm12))]</code>表示如果<code>SDNode</code>节点为<code>add</code>（对应的的操作码为<code>ISD::ADD</code>），运算结果和第 1 个操作数都为<code>GPR</code>中的寄存器，第 2 个操作数为<code>simm12</code>类型的立即数，那么会匹配为<code>addi</code>指令。</p>
<p>第 20 ~24 行表示指令编码中字段与 bit 位之间的对应关系。可参考《<a href="https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMAFDQC/riscv-spec-20191213.pdf"><font size="4">riscv-spec-20191213</font></a>》Table 24.2: Instruction listing for RISC-V。</p></li>
<li><p>第 27～40 行，定义具象记录<code>JALR</code>，用于表示<code>jalr</code>指令。字段<code>isCall</code>的值为 1 表示该指令用于函数调用。</p></li>
<li><p>第 42 行，定义汇编代码<code>jalr x0, 0(x1)</code>的别名为<code>ret</code>，并且优先打印该别名（由于抽象记录<code>InstAlias</code>的第三个参数表示优先级，默认值为 1，这里值为 4，所以优先打印别名）。</p></li>
<li><p>第 44～52 行，定义伪指令<code>PseudoRET</code>。</p>
<p><code>PseudoInstExpansion&lt;(JALR X0, X1, 0)</code>表示伪指令<code>PseudoRET</code>实际对应的指令为<code>JALR X0, X1, 0</code>。</p>
<p><code>let Pattern = [(MyRISCVRetFlag)];</code>表示<code>SDNode</code>节点为<code>MyRISCVRetFlag</code>时会匹配到该伪指令。</p>
<p><code>let isPseudo = 1;</code>表示该指令是伪指令。</p>
<p><code>let isReturn = 1;</code>表示该指令会导致从函数返回。</p>
<p><code>let isTerminator = 1;</code>表示该指令必须作为基本块的最后一条指令。</p></li>
</ul>
<hr>
<h3 id="hspanidjump4span"><span><span id="jump4">定义调用约定</span></span></h3>
<p>LLVM 中，<code>&lt;Target&gt;CallingConv.td</code>文件用于描述程序调用约定。</p>
<p>对于<code>MyRISCV</code>目标后端，<code>MyRISCVCallingConv.td</code>位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs ruby">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span>&nbsp;<span class="hljs-title">RetCC_MyRISCV</span>&nbsp;:&nbsp;<span class="hljs-title">CallingConv</span><span class="hljs-title">&lt;</span>[</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;&nbsp;&nbsp;CCIfType&lt;[i1,&nbsp;i8,&nbsp;i16,&nbsp;i32],&nbsp;CCAssignToReg&lt;[X1<span class="hljs-number">0</span>,&nbsp;X11]<span class="hljs-meta">&gt;&gt;</span>,<br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;&nbsp;&nbsp;CCIfType&lt;[i32],&nbsp;CCAssignToStack&lt;<span class="hljs-number">4</span>,&nbsp;<span class="hljs-number">4</span>&gt;&gt;,<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;]&gt;;<br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span>&nbsp;<span class="hljs-title">CC_MyRISCV</span>&nbsp;:&nbsp;<span class="hljs-title">CallingConv</span><span class="hljs-title">&lt;</span>[</span><br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;&nbsp;&nbsp;CCIfType&lt;[i1,&nbsp;i8,&nbsp;i16,&nbsp;i32],&nbsp;CCAssignToReg&lt;[X1<span class="hljs-number">0</span>,&nbsp;X11,&nbsp;X12,&nbsp;X13,&nbsp;X14,&nbsp;X15,&nbsp;X16,&nbsp;X17]<span class="hljs-meta">&gt;&gt;</span>,<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;&nbsp;&nbsp;CCIfType&lt;[i32],&nbsp;CCAssignToStack&lt;<span class="hljs-number">4</span>,&nbsp;<span class="hljs-number">4</span>&gt;&gt;,<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;]&gt;;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<br>&nbsp;<span class="hljs-number">11</span>&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span>&nbsp;<span class="hljs-title">CC_Save</span>&nbsp;:&nbsp;<span class="hljs-title">CalleeSavedRegs</span><span class="hljs-title">&lt;</span><span class="hljs-params">(add&nbsp;X2,&nbsp;X8,&nbsp;X9,&nbsp;(sequence&nbsp;<span class="hljs-string">"X%u"</span>,&nbsp;<span class="hljs-number">18</span>,&nbsp;<span class="hljs-number">27</span>)</span></span>)&gt;;<br></code></pre>
<ul>
<li><p>第 1～4 行，定义具象记录<code>RetCC_MyRISCV</code>，用于描述函数返回值如何返回（对应<code>MyRISCVGenCallingConv.inc</code>文件中的<code>RetCC_MyRISCV()</code>函数）。</p>
<p><code>CCIfType&lt;[i1, i8, i16, i32], CCAssignToReg&lt;[X10, X11]&gt;&gt;</code>表示如果返回值的数据类型为<code>i1</code>、<code>i8</code>、<code>i16</code>或<code>i32</code>，那么可以将返回值保存到寄存器<code>x10</code>或<code>x11</code>中。</p>
<p><code>CCIfType&lt;[i32], CCAssignToStack&lt;4, 4&gt;&gt;</code>表示返回值需要保存到栈内存中时，存放规则为每个值占用 4 字节并以 4 字节进行内存对齐。</p></li>
<li><p>第 6～9 行，定义具象记录<code>CC_MyRISCV</code>，用于描述函数参数如何传递（对应<code>MyRISCVGenCallingConv.inc</code>文件中的<code>CC_MyRISCV()</code>函数）。</p>
<p><code>CCIfType&lt;[i1, i8, i16, i32], CCAssignToReg&lt;[X10, X11, X12, X13, X14, X15, X16, X17]&gt;&gt;</code>表示如果函数参数的数据类型为<code>i1</code>、<code>i8</code>、<code>i16</code>或<code>i32</code>，那么可以将函数参数保存到寄存器<code>x10～x17</code>中。</p>
<p><code>CCIfType&lt;[i32], CCAssignToStack&lt;4, 4&gt;&gt;</code>表示函数参数需要保存到栈内存中时，存放规则为每个值占用 4 字节并以 4 字节进行内存对齐。</p></li>
<li><p>第 11 行，定义具象记录<code>CC_Save</code>，用于描述由被调用者保存的寄存器，包括<code>x2</code>、<code>x8</code>、<code>x9</code>和<code>x18~x27</code>（对应<code>MyRISCVGenRegisterInfo.inc</code>文件中的<code>CC_Save_SaveList</code>数组）。</p></li>
</ul>
<hr>
<h3 id="hspanidjump5span"><span><span id="jump5">支持生成汇编代码</span></span></h3>
<p><strong>step 0：</strong> 注册目标后端 MyRISCV</p>
<p>具体步骤参考上一篇《LLVM 之后端篇（2）：如何扩展 llc 的目标后端》。</p>
<p><strong>step 1：</strong> MyRISCV.h</p>
<p><code>MyRISCV.h</code>用于声明全局函数，位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCV_H</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCV_H</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVTargetMachine</span>;</span><br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">FunctionPass</span>;</span><br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-function">FunctionPass&nbsp;*<span class="hljs-title">createMyRISCVISelDag</span><span class="hljs-params">(MyRISCVTargetMachine&nbsp;&amp;TM)</span></span>;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<br>&nbsp;<span class="hljs-number">11</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;namespace&nbsp;llvm</span><br>&nbsp;<span class="hljs-number">12</span>&nbsp;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCV_H</span></span><br></code></pre>
<ul>
<li><p>第 6～7 行，前向声明<code>MyRISCVTargetMachine</code>和<code>FunctionPass</code>类，以减少头文件依赖。</p></li>
<li><p>第 9 行，全局函数<code>llvm::createMyRISCVISelDag()</code>用于创建目标后端<code>MyRISCV</code>的指令选择 Pass，其实现位于<code>llvm/lib/Target/MyRISCV/MyRISCVISelDAGToDAG.cpp</code>文件。</p></li>
</ul>
<p><strong>step 2：</strong> MyRISCVTargetMachine.h</p>
<p><code>MyRISCVTargetMachine.h</code>用于声明继承自<code>llvm::LLVMTargetMachine</code>的派生类<code>MyRISCVTargetMachine</code>，位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVTARGETMACHINE_H</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVTARGETMACHINE_H</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/Target/TargetMachine.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVSubtarget.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVTargetMachine</span>&nbsp;:</span>&nbsp;<span class="hljs-keyword">public</span>&nbsp;LLVMTargetMachine&nbsp;{<br>&nbsp;<span class="hljs-number">10</span>&nbsp;&nbsp;&nbsp;MyRISCVSubtarget&nbsp;Subtarget;<br>&nbsp;<span class="hljs-number">11</span>&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;TargetLoweringObjectFile&gt;&nbsp;TLOF;<br>&nbsp;<span class="hljs-number">12</span>&nbsp;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<span class="hljs-keyword">public</span>:<br>&nbsp;<span class="hljs-number">14</span>&nbsp;&nbsp;&nbsp;MyRISCVTargetMachine(<span class="hljs-keyword">const</span>&nbsp;Target&nbsp;&amp;T,&nbsp;<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;TT,&nbsp;StringRef&nbsp;CPU,<br>&nbsp;<span class="hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringRef&nbsp;FS,&nbsp;<span class="hljs-keyword">const</span>&nbsp;TargetOptions&nbsp;&amp;Options,<br>&nbsp;<span class="hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional&lt;Reloc::Model&gt;&nbsp;RM,&nbsp;Optional&lt;CodeModel::Model&gt;&nbsp;CM,<br>&nbsp;<span class="hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CodeGenOpt::Level&nbsp;OL,&nbsp;<span class="hljs-keyword">bool</span>&nbsp;JIT);<br>&nbsp;<span class="hljs-number">18</span>&nbsp;<br>&nbsp;<span class="hljs-number">19</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">const</span>&nbsp;MyRISCVSubtarget&nbsp;*<span class="hljs-title">getSubtargetImpl</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;Function&nbsp;&amp;F)</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override&nbsp;</span>{<br>&nbsp;<span class="hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;&amp;Subtarget;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">22</span>&nbsp;<br>&nbsp;<span class="hljs-number">23</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">const</span>&nbsp;MyRISCVSubtarget&nbsp;*<span class="hljs-title">getSubtargetImpl</span><span class="hljs-params">()</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;</span>{&nbsp;<span class="hljs-keyword">return</span>&nbsp;&amp;Subtarget;&nbsp;}<br>&nbsp;<span class="hljs-number">24</span>&nbsp;<br>&nbsp;<span class="hljs-number">25</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function">TargetPassConfig&nbsp;*<span class="hljs-title">createPassConfig</span><span class="hljs-params">(PassManagerBase&nbsp;&amp;PM)</span>&nbsp;override</span>;<br>&nbsp;<span class="hljs-number">26</span>&nbsp;<br>&nbsp;<span class="hljs-number">27</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function">TargetLoweringObjectFile&nbsp;*<span class="hljs-title">getObjFileLowering</span><span class="hljs-params">()</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override&nbsp;</span>{<br>&nbsp;<span class="hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;TLOF.get();<br>&nbsp;<span class="hljs-number">29</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">30</span>&nbsp;};<br>&nbsp;<span class="hljs-number">31</span>&nbsp;<br>&nbsp;<span class="hljs-number">32</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;namespace&nbsp;llvm</span><br>&nbsp;<span class="hljs-number">33</span>&nbsp;<br>&nbsp;<span class="hljs-number">34</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVTARGETMACHINE_H</span></span><br></code></pre>
<ul>
<li><p>第 19～21、25、27～29 行，每个目标后端至少需要覆写基类<code>llvm::LLVMTargetMachine</code>中的这 3 个虚函数。</p></li>
<li><p>第 23 行，自定义公有成员函数<code>getSubtargetImpl()</code>，以便于其它类获取<code>MyRISCVTargetMachine::Subtarget</code>对象。</p></li>
</ul>
<p><strong>step 3：</strong> MyRISCVTargetMachine.cpp</p>
<p>llvm/lib/Target/MyRISCV/MyRISCVTargetMachine.cpp 的内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVTargetMachine.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCV.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"TargetInfo/MyRISCVTargetInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/CodeGen/TargetPassConfig.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/CodeGen/TargetLoweringObjectFileImpl.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/Support/TargetRegistry.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-keyword">using</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;{<br>&nbsp;<span class="hljs-number">11</span>&nbsp;<br>&nbsp;<span class="hljs-number">12</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVPassConfig</span>&nbsp;:</span>&nbsp;<span class="hljs-keyword">public</span>&nbsp;TargetPassConfig&nbsp;{<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<span class="hljs-keyword">public</span>:<br>&nbsp;<span class="hljs-number">14</span>&nbsp;&nbsp;&nbsp;MyRISCVPassConfig(MyRISCVTargetMachine&nbsp;&amp;TM,&nbsp;PassManagerBase&nbsp;&amp;PM)<br>&nbsp;<span class="hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;TargetPassConfig(TM,&nbsp;PM)&nbsp;{}<br>&nbsp;<span class="hljs-number">16</span>&nbsp;<br>&nbsp;<span class="hljs-number">17</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">addInstSelector</span><span class="hljs-params">()</span>&nbsp;override&nbsp;</span>{<br>&nbsp;<span class="hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addPass(createMyRISCVISelDag(getMyRISCVTargetMachine()));<br>&nbsp;<span class="hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-literal">false</span>;<br>&nbsp;<span class="hljs-number">20</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">21</span>&nbsp;<br>&nbsp;<span class="hljs-number">22</span>&nbsp;<span class="hljs-keyword">private</span>:<br>&nbsp;<span class="hljs-number">23</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function">MyRISCVTargetMachine&nbsp;&amp;<span class="hljs-title">getMyRISCVTargetMachine</span><span class="hljs-params">()</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;</span>{<br>&nbsp;<span class="hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;getTM&lt;MyRISCVTargetMachine&gt;();<br>&nbsp;<span class="hljs-number">25</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">26</span>&nbsp;};<br>&nbsp;<span class="hljs-number">27</span>&nbsp;<br>&nbsp;<span class="hljs-number">28</span>&nbsp;<span class="hljs-function">StringRef&nbsp;<span class="hljs-title">computeDataLayout</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;TT)</span>&nbsp;</span>{<br>&nbsp;<span class="hljs-number">29</span>&nbsp;&nbsp;&nbsp;assert(TT.isArch32Bit()&nbsp;&amp;&amp;&nbsp;<span class="hljs-string">"Only&nbsp;RV32&nbsp;is&nbsp;currently&nbsp;supported!"</span>);<br>&nbsp;<span class="hljs-number">30</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-string">"e-m:e-p:32:32-i64:64-n32-S128"</span>;<br>&nbsp;<span class="hljs-number">31</span>&nbsp;}<br>&nbsp;<span class="hljs-number">32</span>&nbsp;<br>&nbsp;<span class="hljs-number">33</span>&nbsp;Reloc::<span class="hljs-function">Model&nbsp;<span class="hljs-title">getEffectiveRelocModel</span><span class="hljs-params">(Optional&lt;Reloc::Model&gt;&nbsp;RM)</span>&nbsp;</span>{<br>&nbsp;<span class="hljs-number">34</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;RM.hasValue()&nbsp;?&nbsp;*RM&nbsp;:&nbsp;Reloc::Static;<br>&nbsp;<span class="hljs-number">35</span>&nbsp;}<br>&nbsp;<span class="hljs-number">36</span>&nbsp;<br>&nbsp;<span class="hljs-number">37</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;anonymous&nbsp;namespace</span><br>&nbsp;<span class="hljs-number">38</span>&nbsp;<br>&nbsp;<span class="hljs-number">39</span>&nbsp;MyRISCVTargetMachine::MyRISCVTargetMachine(<span class="hljs-keyword">const</span>&nbsp;Target&nbsp;&amp;T,&nbsp;<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;TT,<br>&nbsp;<span class="hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringRef&nbsp;CPU,&nbsp;StringRef&nbsp;FS,<br>&nbsp;<span class="hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;TargetOptions&nbsp;&amp;Options,<br>&nbsp;<span class="hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional&lt;Reloc::Model&gt;&nbsp;RM,<br>&nbsp;<span class="hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional&lt;CodeModel::Model&gt;&nbsp;CM,<br>&nbsp;<span class="hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CodeGenOpt::Level&nbsp;OL,&nbsp;<span class="hljs-keyword">bool</span>&nbsp;JIT)<br>&nbsp;<span class="hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;LLVMTargetMachine(T,&nbsp;computeDataLayout(TT),&nbsp;TT,&nbsp;CPU,&nbsp;FS,&nbsp;Options,<br>&nbsp;<span class="hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getEffectiveRelocModel(RM),<br>&nbsp;<span class="hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getEffectiveCodeModel(CM,&nbsp;CodeModel::Small),&nbsp;OL),<br>&nbsp;<span class="hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subtarget(TT,&nbsp;CPU,&nbsp;CPU,&nbsp;FS,&nbsp;*<span class="hljs-keyword">this</span>),<br>&nbsp;<span class="hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TLOF(<span class="hljs-built_in">std</span>::make_unique&lt;TargetLoweringObjectFileELF&gt;())&nbsp;{<br>&nbsp;<span class="hljs-number">50</span>&nbsp;&nbsp;&nbsp;initAsmInfo();<br>&nbsp;<span class="hljs-number">51</span>&nbsp;}<br>&nbsp;<span class="hljs-number">52</span>&nbsp;<br>&nbsp;<span class="hljs-number">53</span>&nbsp;TargetPassConfig&nbsp;*MyRISCVTargetMachine::createPassConfig(PassManagerBase&nbsp;&amp;PM)&nbsp;{<br>&nbsp;<span class="hljs-number">54</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-keyword">new</span>&nbsp;MyRISCVPassConfig(*<span class="hljs-keyword">this</span>,&nbsp;PM);<br>&nbsp;<span class="hljs-number">55</span>&nbsp;}<br>&nbsp;<span class="hljs-number">56</span>&nbsp;<br>&nbsp;<span class="hljs-number">57</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-string">"C"</span>&nbsp;<span class="hljs-function">LLVM_EXTERNAL_VISIBILITY&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">LLVMInitializeMyRISCVTarget</span><span class="hljs-params">()</span>&nbsp;</span>{<br>&nbsp;<span class="hljs-number">58</span>&nbsp;&nbsp;&nbsp;RegisterTargetMachine&lt;MyRISCVTargetMachine&gt;&nbsp;X(getMyRISCV32Target());<br>&nbsp;<span class="hljs-number">59</span>&nbsp;}<br></code></pre>
<ul>
<li><p>第 12～26 行，定义继承自<code>llvm::TargetPassConfig</code>的派生类<code>MyRISCVPassConfig</code>，用于定制代码生成流水线中的各种 Pass。</p>
<p>函数<code>addInstSelector()</code>用于安装目标后端的指令选择 Pass（这里为<code>MyRISCVDAGToDAGISel</code>类，定义在<code>llvm/lib/Target/MyRISCV/MyRISCVISelDAGToDAG.cpp</code>文件中）。</p></li>
<li><p>第 50 行，函数<code>LLVMTargetMachine::initAsmInfo()</code>用于执行一些初始化操作。该函数所依赖的对象（比如：<code>MCAsmInfo</code>）在<code>llvm/lib/Target/MyRISCV/MCTargetDesc/MyRISCVMCTargetDesc.cpp</code>文件中进行创建并注册。</p></li>
</ul>
<p><strong>step 4：</strong> MyRISCVSubtarget.h</p>
<p><code>MyRISCVSubtarget.h</code>用于声明继承自<code>llvm::MyRISCVGenSubtargetInfo</code>（位于<code>MyRISCVGenSubtargetInfo.inc</code>文件）的派生类<code>MyRISCVSubtarget</code>，位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVSUBTARGET_H</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVSUBTARGET_H</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVISelLowering.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVFrameLowering.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVInstrInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVRegisterInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/CodeGen/TargetSubtargetInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_SUBTARGETINFO_HEADER</span><br>&nbsp;<span class="hljs-number">11</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenSubtargetInfo.inc"</span></span><br>&nbsp;<span class="hljs-number">12</span>&nbsp;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm&nbsp;{<br>&nbsp;<span class="hljs-number">14</span>&nbsp;<br>&nbsp;<span class="hljs-number">15</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVTargetMachine</span>;</span><br>&nbsp;<span class="hljs-number">16</span>&nbsp;<br>&nbsp;<span class="hljs-number">17</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVSubtarget</span>&nbsp;:</span>&nbsp;<span class="hljs-keyword">public</span>&nbsp;MyRISCVGenSubtargetInfo&nbsp;{<br>&nbsp;<span class="hljs-number">18</span>&nbsp;&nbsp;&nbsp;MyRISCVTargetLowering&nbsp;TLInfo;<br>&nbsp;<span class="hljs-number">19</span>&nbsp;&nbsp;&nbsp;MyRISCVFrameLowering&nbsp;FrameLowering;<br>&nbsp;<span class="hljs-number">20</span>&nbsp;&nbsp;&nbsp;MyRISCVInstrInfo&nbsp;InstrInfo;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;&nbsp;&nbsp;MyRISCVRegisterInfo&nbsp;RegInfo;<br>&nbsp;<span class="hljs-number">22</span>&nbsp;<br>&nbsp;<span class="hljs-number">23</span>&nbsp;<span class="hljs-keyword">public</span>:<br>&nbsp;<span class="hljs-number">24</span>&nbsp;&nbsp;&nbsp;MyRISCVSubtarget(<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;TT,&nbsp;StringRef&nbsp;CPU,&nbsp;StringRef&nbsp;TuneCPU,<br>&nbsp;<span class="hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringRef&nbsp;FS,&nbsp;MyRISCVTargetMachine&nbsp;&amp;TM);<br>&nbsp;<span class="hljs-number">26</span>&nbsp;<br>&nbsp;<span class="hljs-number">27</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">const</span>&nbsp;MyRISCVTargetLowering&nbsp;*<span class="hljs-title">getTargetLowering</span><span class="hljs-params">()</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override&nbsp;</span>{<br>&nbsp;<span class="hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;&amp;TLInfo;<br>&nbsp;<span class="hljs-number">29</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">30</span>&nbsp;<br>&nbsp;<span class="hljs-number">31</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">const</span>&nbsp;MyRISCVFrameLowering&nbsp;*<span class="hljs-title">getFrameLowering</span><span class="hljs-params">()</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override&nbsp;</span>{<br>&nbsp;<span class="hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;&amp;FrameLowering;<br>&nbsp;<span class="hljs-number">33</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">34</span>&nbsp;<br>&nbsp;<span class="hljs-number">35</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">const</span>&nbsp;MyRISCVInstrInfo&nbsp;*<span class="hljs-title">getInstrInfo</span><span class="hljs-params">()</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override&nbsp;</span>{&nbsp;<span class="hljs-keyword">return</span>&nbsp;&amp;InstrInfo;&nbsp;}<br>&nbsp;<span class="hljs-number">36</span>&nbsp;<br>&nbsp;<span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">const</span>&nbsp;MyRISCVRegisterInfo&nbsp;*<span class="hljs-title">getRegisterInfo</span><span class="hljs-params">()</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override&nbsp;</span>{&nbsp;<span class="hljs-keyword">return</span>&nbsp;&amp;RegInfo;&nbsp;}<br>&nbsp;<span class="hljs-number">38</span>&nbsp;<br>&nbsp;<span class="hljs-number">39</span>&nbsp;<span class="hljs-keyword">private</span>:<br>&nbsp;<span class="hljs-number">40</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">ParseSubtargetFeatures</span><span class="hljs-params">(StringRef&nbsp;CPU,&nbsp;StringRef&nbsp;TuneCPU,&nbsp;StringRef&nbsp;FS)</span></span>;<br>&nbsp;<span class="hljs-number">41</span>&nbsp;<br>&nbsp;<span class="hljs-number">42</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function">MyRISCVSubtarget&nbsp;&amp;<span class="hljs-title">initializeSubtargetDependencies</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;TT,<br>&nbsp;<span class="hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringRef&nbsp;CPU,<br>&nbsp;<span class="hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringRef&nbsp;FS)</span></span>;<br>&nbsp;<span class="hljs-number">45</span>&nbsp;};<br>&nbsp;<span class="hljs-number">46</span>&nbsp;<br>&nbsp;<span class="hljs-number">47</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;namespace&nbsp;llvm</span><br>&nbsp;<span class="hljs-number">48</span>&nbsp;<br>&nbsp;<span class="hljs-number">49</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVSUBTARGET_H</span></span><br></code></pre>
<ul>
<li><p>第 27～37 行，每个目标后端至少需要覆写基类<code>llvm::TargetSubtargetInfo</code>中的这 4 个虚函数。</p></li>
<li><p>第 40 行，该函数是由 TableGen 生成的，其实现位于<code>MyRISCVGenSubtargetInfo.inc</code>文件，这里需要提供其函数声明。</p></li>
<li><p>第 42～44 行，自定义私有成员函数<code>initializeSubtargetDependencies()</code>，用于初始化<code>MyRISCVSubtarget</code>。</p></li>
</ul>
<p><strong>step 5：</strong> MyRISCVSubtarget.cpp</p>
<p>llvm/lib/Target/MyRISCV/MyRISCVSubtarget.cpp 的内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVSubtarget.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVTargetMachine.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-keyword">using</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm;<br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;DEBUG_TYPE&nbsp;<span class="hljs-meta-string">"riscv-subtarget"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_SUBTARGETINFO_MC_DESC</span><br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_SUBTARGETINFO_TARGET_DESC</span><br>&nbsp;<span class="hljs-number">10</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_SUBTARGETINFO_CTOR</span><br>&nbsp;<span class="hljs-number">11</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenSubtargetInfo.inc"</span></span><br>&nbsp;<span class="hljs-number">12</span>&nbsp;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;MyRISCVSubtarget::MyRISCVSubtarget(<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;TT,&nbsp;StringRef&nbsp;CPU,<br>&nbsp;<span class="hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringRef&nbsp;TuneCPU,&nbsp;StringRef&nbsp;FS,<br>&nbsp;<span class="hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MyRISCVTargetMachine&nbsp;&amp;TM)<br>&nbsp;<span class="hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;MyRISCVGenSubtargetInfo(TT,&nbsp;CPU,&nbsp;TuneCPU,&nbsp;FS),&nbsp;TLInfo(TM),<br>&nbsp;<span class="hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FrameLowering(initializeSubtargetDependencies(TT,&nbsp;CPU,&nbsp;FS)),<br>&nbsp;<span class="hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InstrInfo(*<span class="hljs-keyword">this</span>),&nbsp;RegInfo(getHwMode())&nbsp;{<br>&nbsp;<span class="hljs-number">19</span>&nbsp;}<br>&nbsp;<span class="hljs-number">20</span>&nbsp;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;MyRISCVSubtarget&nbsp;&amp;<br>&nbsp;<span class="hljs-number">22</span>&nbsp;MyRISCVSubtarget::initializeSubtargetDependencies(<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;TT,<br>&nbsp;<span class="hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringRef&nbsp;CPU,<br>&nbsp;<span class="hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringRef&nbsp;FS)&nbsp;{<br>&nbsp;<span class="hljs-number">25</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(CPU.empty())&nbsp;{<br>&nbsp;<span class="hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(TT.isArch32Bit()&nbsp;&amp;&amp;&nbsp;<span class="hljs-string">"Only&nbsp;RV32&nbsp;is&nbsp;currently&nbsp;supported!"</span>);<br>&nbsp;<span class="hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CPU&nbsp;=&nbsp;<span class="hljs-string">"generic-rv32"</span>;<br>&nbsp;<span class="hljs-number">28</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">29</span>&nbsp;&nbsp;&nbsp;ParseSubtargetFeatures(CPU,&nbsp;CPU,&nbsp;FS);<br>&nbsp;<span class="hljs-number">30</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;*<span class="hljs-keyword">this</span>;<br>&nbsp;<span class="hljs-number">31</span>&nbsp;}<br></code></pre>
<ul>
<li><p>第 27 行，设置处理器的默认名称为<code>generic-rv32</code>，对应<code>MyRISCV.td</code>中某个<code>ProcessorModel</code>具象记录的第一个参数的值。</p></li>
<li><p>第 29 行，该函数是由 TableGen 生成的，其实现位于<code>MyRISCVGenSubtargetInfo.inc</code>文件。</p></li>
</ul>
<p><strong>step 6：</strong> MyRISCVRegisterInfo.h</p>
<p><code>MyRISCVRegisterInfo.h</code>用于声明继承自<code>llvm::MyRISCVGenRegisterInfo</code>（位于<code>MyRISCVGenRegisterInfo.inc</code>文件）的派生类<code>MyRISCVRegisterInfo</code>，位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVREGISTERINFO_H</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVREGISTERINFO_H</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/CodeGen/TargetRegisterInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_REGINFO_HEADER</span><br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenRegisterInfo.inc"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm&nbsp;{<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<br>&nbsp;<span class="hljs-number">11</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVRegisterInfo</span>&nbsp;:</span>&nbsp;<span class="hljs-keyword">public</span>&nbsp;MyRISCVGenRegisterInfo&nbsp;{<br>&nbsp;<span class="hljs-number">12</span>&nbsp;<span class="hljs-keyword">public</span>:<br>&nbsp;<span class="hljs-number">13</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">explicit</span>&nbsp;<span class="hljs-title">MyRISCVRegisterInfo</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span>&nbsp;HwMode)</span></span>;<br>&nbsp;<span class="hljs-number">14</span>&nbsp;<br>&nbsp;<span class="hljs-number">15</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">const</span>&nbsp;MCPhysReg&nbsp;*<span class="hljs-title">getCalleeSavedRegs</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;MachineFunction&nbsp;*MF)</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override</span>;<br>&nbsp;<span class="hljs-number">16</span>&nbsp;<br>&nbsp;<span class="hljs-number">17</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function">BitVector&nbsp;<span class="hljs-title">getReservedRegs</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;MachineFunction&nbsp;&amp;MF)</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override</span>;<br>&nbsp;<span class="hljs-number">18</span>&nbsp;<br>&nbsp;<span class="hljs-number">19</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">eliminateFrameIndex</span><span class="hljs-params">(MachineBasicBlock::iterator&nbsp;MI,&nbsp;<span class="hljs-keyword">int</span>&nbsp;SPAdj,<br>&nbsp;<span class="hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">unsigned</span>&nbsp;FIOperandNum,<br>&nbsp;<span class="hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RegScavenger&nbsp;*RS&nbsp;=&nbsp;<span class="hljs-literal">nullptr</span>)</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override</span>;<br>&nbsp;<span class="hljs-number">22</span>&nbsp;<br>&nbsp;<span class="hljs-number">23</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function">Register&nbsp;<span class="hljs-title">getFrameRegister</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;MachineFunction&nbsp;&amp;MF)</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override</span>;<br>&nbsp;<span class="hljs-number">24</span>&nbsp;};<br>&nbsp;<span class="hljs-number">25</span>&nbsp;<br>&nbsp;<span class="hljs-number">26</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;namespace&nbsp;llvm</span><br>&nbsp;<span class="hljs-number">27</span>&nbsp;<br>&nbsp;<span class="hljs-number">28</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVREGISTERINFO_H</span></span><br></code></pre>
<ul>
<li><p>第 6～7 行，用于包含基类<code>llvm::MyRISCVGenRegisterInfo</code>的声明。</p></li>
<li><p>第 15～23 行，每个目标后端至少需要覆写基类<code>llvm::TargetRegisterInfo</code>中的这 4 个虚函数。</p>
<p>函数<code>getCalleeSavedRegs()</code>，用于返回由被调用者保存的所有寄存器。</p>
<p>函数<code>getReservedRegs()</code>，用于返回保留的寄存器。这些保留的寄存器是不可分配的（比如：虽然栈指针寄存器<code>X2</code>属于寄存器类<code>GPR</code>，但如果将<code>X2</code>视作保留寄存器，那么在寄存器分配时不会分配该寄存器），并且总被认为是<code>live</code>的。</p>
<p>函数<code>getFrameRegister()</code>，用于返回保存帧指针的寄存器。</p></li>
</ul>
<p><strong>step 7：</strong> MyRISCVRegisterInfo.cpp</p>
<p>llvm/lib/Target/MyRISCV/MyRISCVRegisterInfo.cpp 的内容如下：</p>
<pre><code class="hljs php">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MyRISCVRegisterInfo.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MyRISCVSubtarget.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MyRISCVFrameLowering.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MCTargetDesc/MyRISCVMCTargetDesc.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-comment">#include&nbsp;"llvm/CodeGen/MachineFunction.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-comment">#define&nbsp;GET_REGINFO_TARGET_DESC</span><br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MyRISCVGenRegisterInfo.inc"</span><br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;using&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">llvm</span>;<br>&nbsp;<span class="hljs-number">11</span>&nbsp;<br>&nbsp;<span class="hljs-number">12</span>&nbsp;MyRISCVRegisterInfo::MyRISCVRegisterInfo(unsigned&nbsp;HwMode)<br>&nbsp;<span class="hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;MyRISCVGenRegisterInfo(MyRISCV::X1,&nbsp;<span class="hljs-comment">/*DwarfFlavour*/</span>&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-comment">/*EHFlavor*/</span>&nbsp;<span class="hljs-number">0</span>,<br>&nbsp;<span class="hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*PC*/</span>&nbsp;<span class="hljs-number">0</span>,&nbsp;HwMode)&nbsp;{}<br>&nbsp;<span class="hljs-number">15</span>&nbsp;<br>&nbsp;<span class="hljs-number">16</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;MCPhysReg&nbsp;*<br>&nbsp;<span class="hljs-number">17</span>&nbsp;MyRISCVRegisterInfo::getCalleeSavedRegs(<span class="hljs-keyword">const</span>&nbsp;MachineFunction&nbsp;*MF)&nbsp;<span class="hljs-keyword">const</span>&nbsp;{<br>&nbsp;<span class="hljs-number">18</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;CC_Save_SaveList;<br>&nbsp;<span class="hljs-number">19</span>&nbsp;}<br>&nbsp;<span class="hljs-number">20</span>&nbsp;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;BitVector&nbsp;MyRISCVRegisterInfo::getReservedRegs(<span class="hljs-keyword">const</span>&nbsp;MachineFunction&nbsp;&amp;MF)&nbsp;<span class="hljs-keyword">const</span>&nbsp;{<br>&nbsp;<span class="hljs-number">22</span>&nbsp;&nbsp;&nbsp;BitVector&nbsp;Reserved(getNumRegs());<br>&nbsp;<span class="hljs-number">23</span>&nbsp;&nbsp;&nbsp;Reserved.set(MyRISCV::X0);<br>&nbsp;<span class="hljs-number">24</span>&nbsp;&nbsp;&nbsp;Reserved.set(MyRISCV::X2);<br>&nbsp;<span class="hljs-number">25</span>&nbsp;&nbsp;&nbsp;Reserved.set(MyRISCV::X3);<br>&nbsp;<span class="hljs-number">26</span>&nbsp;&nbsp;&nbsp;Reserved.set(MyRISCV::X4);<br>&nbsp;<span class="hljs-number">27</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;Reserved;<br>&nbsp;<span class="hljs-number">28</span>&nbsp;}<br>&nbsp;<span class="hljs-number">29</span>&nbsp;<br>&nbsp;<span class="hljs-number">30</span>&nbsp;void&nbsp;MyRISCVRegisterInfo::eliminateFrameIndex(MachineBasicBlock::iterator&nbsp;MI,<br>&nbsp;<span class="hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;SPAdj,&nbsp;unsigned&nbsp;FIOperandNum,<br>&nbsp;<span class="hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RegScavenger&nbsp;*RS)&nbsp;<span class="hljs-keyword">const</span>&nbsp;{<br>&nbsp;<span class="hljs-number">33</span>&nbsp;}<br>&nbsp;<span class="hljs-number">34</span>&nbsp;<br>&nbsp;<span class="hljs-number">35</span>&nbsp;Register&nbsp;MyRISCVRegisterInfo::getFrameRegister(<span class="hljs-keyword">const</span>&nbsp;MachineFunction&nbsp;&amp;MF)&nbsp;<span class="hljs-keyword">const</span>&nbsp;{<br>&nbsp;<span class="hljs-number">36</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;MyRISCV::X8;<br>&nbsp;<span class="hljs-number">37</span>&nbsp;}<br></code></pre>
<p><strong>step 8：</strong> MyRISCVMCInstLower.h</p>
<p><code>MyRISCVMCInstLower.h</code>用于声明类<code>MyRISCVMCInstLower</code>，该类负责将机器指令的表示形式从<code>MachineInstr</code>转换为轻量级的<code>MCInst</code>，位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVMCINSTLOWER_H</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVMCINSTLOWER_H</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MCContext</span>;</span><br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">AsmPrinter</span>;</span><br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MachineInstr</span>;</span><br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MachineOperand</span>;</span><br>&nbsp;<span class="hljs-number">10</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MCInst</span>;</span><br>&nbsp;<span class="hljs-number">11</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MCOperand</span>;</span><br>&nbsp;<span class="hljs-number">12</span>&nbsp;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVMCInstLower</span>&nbsp;{</span><br>&nbsp;<span class="hljs-number">14</span>&nbsp;&nbsp;&nbsp;MCContext&nbsp;&amp;Ctx;<br>&nbsp;<span class="hljs-number">15</span>&nbsp;&nbsp;&nbsp;AsmPrinter&nbsp;&amp;Printer;<br>&nbsp;<span class="hljs-number">16</span>&nbsp;<br>&nbsp;<span class="hljs-number">17</span>&nbsp;<span class="hljs-keyword">public</span>:<br>&nbsp;<span class="hljs-number">18</span>&nbsp;&nbsp;&nbsp;MyRISCVMCInstLower(MCContext&nbsp;&amp;Ctx,&nbsp;AsmPrinter&nbsp;&amp;Printer);<br>&nbsp;<span class="hljs-number">19</span>&nbsp;<br>&nbsp;<span class="hljs-number">20</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Lower</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;MachineInstr&nbsp;*MI,&nbsp;MCInst&nbsp;&amp;OutMI)</span>&nbsp;<span class="hljs-keyword">const</span></span>;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;<br>&nbsp;<span class="hljs-number">22</span>&nbsp;<span class="hljs-keyword">private</span>:<br>&nbsp;<span class="hljs-number">23</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">LowerOperand</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;MachineOperand&nbsp;&amp;MO,&nbsp;MCOperand&nbsp;&amp;MCOp)</span>&nbsp;<span class="hljs-keyword">const</span></span>;<br>&nbsp;<span class="hljs-number">24</span>&nbsp;};<br>&nbsp;<span class="hljs-number">25</span>&nbsp;<br>&nbsp;<span class="hljs-number">26</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;namespace&nbsp;llvm</span><br>&nbsp;<span class="hljs-number">27</span>&nbsp;<br>&nbsp;<span class="hljs-number">28</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVMCINSTLOWER_H</span></span><br></code></pre>
<p><strong>step 9：</strong> MyRISCVMCInstLower.cpp</p>
<p>llvm/lib/Target/MyRISCV/MyRISCVMCInstLower.cpp 的内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVMCInstLower.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/CodeGen/AsmPrinter.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/CodeGen/MachineInstr.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/CodeGen/MachineOperand.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/MC/MCInst.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/MC/MCExpr.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/MC/MCContext.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-keyword">using</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<br>&nbsp;<span class="hljs-number">11</span>&nbsp;MyRISCVMCInstLower::MyRISCVMCInstLower(MCContext&nbsp;&amp;Ctx,&nbsp;AsmPrinter&nbsp;&amp;Printer)<br>&nbsp;<span class="hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Ctx(Ctx),&nbsp;Printer(Printer)&nbsp;{}<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<br>&nbsp;<span class="hljs-number">14</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;MyRISCVMCInstLower::Lower(<span class="hljs-keyword">const</span>&nbsp;MachineInstr&nbsp;*MI,&nbsp;MCInst&nbsp;&amp;OutMI)&nbsp;<span class="hljs-keyword">const</span>&nbsp;{<br>&nbsp;<span class="hljs-number">15</span>&nbsp;&nbsp;&nbsp;OutMI.setOpcode(MI-&gt;getOpcode());<br>&nbsp;<span class="hljs-number">16</span>&nbsp;<br>&nbsp;<span class="hljs-number">17</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for</span>&nbsp;(<span class="hljs-keyword">const</span>&nbsp;MachineOperand&nbsp;&amp;MO&nbsp;:&nbsp;MI-&gt;operands())&nbsp;{<br>&nbsp;<span class="hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MCOperand&nbsp;MCOp;<br>&nbsp;<span class="hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(LowerOperand(MO,&nbsp;MCOp))&nbsp;{<br>&nbsp;<span class="hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutMI.addOperand(MCOp);<br>&nbsp;<span class="hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">22</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">23</span>&nbsp;}<br>&nbsp;<span class="hljs-number">24</span>&nbsp;<br>&nbsp;<span class="hljs-number">25</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;MyRISCVMCInstLower::LowerOperand(<span class="hljs-keyword">const</span>&nbsp;MachineOperand&nbsp;&amp;MO,<br>&nbsp;<span class="hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MCOperand&nbsp;&amp;MCOp)&nbsp;<span class="hljs-keyword">const</span>&nbsp;{<br>&nbsp;<span class="hljs-number">27</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">switch</span>&nbsp;(MO.getType())&nbsp;{<br>&nbsp;<span class="hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">case</span>&nbsp;MachineOperand::MO_Register:<br>&nbsp;<span class="hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(MO.isImplicit())&nbsp;{<br>&nbsp;<span class="hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-literal">false</span>;<br>&nbsp;<span class="hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MCOp&nbsp;=&nbsp;MCOperand::createReg(MO.getReg());<br>&nbsp;<span class="hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">break</span>;<br>&nbsp;<span class="hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">case</span>&nbsp;MachineOperand::MO_Immediate:<br>&nbsp;<span class="hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MCOp&nbsp;=&nbsp;MCOperand::createImm(MO.getImm());<br>&nbsp;<span class="hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">break</span>;<br>&nbsp;<span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">default</span>:<br>&nbsp;<span class="hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;llvm_unreachable(<span class="hljs-string">"Unknown&nbsp;operand&nbsp;type!"</span>);<br>&nbsp;<span class="hljs-number">39</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">40</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-literal">true</span>;<br>&nbsp;<span class="hljs-number">41</span>&nbsp;}<br></code></pre>
<ul>
<li><p>第 14~23 行，函数<code>Lower()</code>用于将机器指令的表示形式从<code>MachineInstr</code>转换为轻量级的<code>MCInst</code>。其中，第 15 行用于设置<code>MCInst</code>的操作码，第 17~22 行用于设置<code>MCInst</code>的所有操作数。</p></li>
<li><p>第 25~41 行，函数<code>LowerOperand()</code>用于将机器指令操作数的表示形式从<code>MachineOperand</code>转换为<code>MCOperand</code>。目前仅支持操作数为<code>寄存器</code>或<code>立即数</code>的情形。</p></li>
</ul>
<p><strong>step 10：</strong> MyRISCVISelLowering.h</p>
<p><code>MyRISCVRegisterInfo.h</code>用于声明继承自<code>llvm::TargetLowering</code>的派生类<code>MyRISCVTargetLowering</code>，位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVISELLOWERING_H</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVISELLOWERING_H</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/CodeGen/SelectionDAG.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/CodeGen/TargetLowering.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVSubtarget</span>;</span><br>&nbsp;<span class="hljs-number">10</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVTargetMachine</span>;</span><br>&nbsp;<span class="hljs-number">11</span>&nbsp;<br>&nbsp;<span class="hljs-number">12</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;MyRISCVISD&nbsp;{<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<br>&nbsp;<span class="hljs-number">14</span>&nbsp;<span class="hljs-keyword">enum</span>&nbsp;NodeType&nbsp;{<br>&nbsp;<span class="hljs-number">15</span>&nbsp;&nbsp;&nbsp;FIRST_NUMBER&nbsp;=&nbsp;ISD::BUILTIN_OP_END,<br>&nbsp;<span class="hljs-number">16</span>&nbsp;&nbsp;&nbsp;RET_FLAG,<br>&nbsp;<span class="hljs-number">17</span>&nbsp;};<br>&nbsp;<span class="hljs-number">18</span>&nbsp;<br>&nbsp;<span class="hljs-number">19</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;//&nbsp;end&nbsp;namespace&nbsp;MyRISCVISD</span><br>&nbsp;<span class="hljs-number">20</span>&nbsp;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVTargetLowering</span>&nbsp;:</span>&nbsp;<span class="hljs-keyword">public</span>&nbsp;TargetLowering&nbsp;{<br>&nbsp;<span class="hljs-number">22</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;MyRISCVSubtarget&nbsp;&amp;Subtarget;<br>&nbsp;<span class="hljs-number">23</span>&nbsp;<br>&nbsp;<span class="hljs-number">24</span>&nbsp;<span class="hljs-keyword">public</span>:<br>&nbsp;<span class="hljs-number">25</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">explicit</span>&nbsp;<span class="hljs-title">MyRISCVTargetLowering</span><span class="hljs-params">(MyRISCVTargetMachine&nbsp;&amp;TM)</span></span>;<br>&nbsp;<span class="hljs-number">26</span>&nbsp;<br>&nbsp;<span class="hljs-number">27</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;*<span class="hljs-title">getTargetNodeName</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span>&nbsp;Opcode)</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override</span>;<br>&nbsp;<span class="hljs-number">28</span>&nbsp;<br>&nbsp;<span class="hljs-number">29</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function">SDValue&nbsp;<span class="hljs-title">LowerFormalArguments</span><span class="hljs-params">(SDValue&nbsp;Chain,&nbsp;CallingConv::ID&nbsp;CallConv,<br>&nbsp;<span class="hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">bool</span>&nbsp;IsVarArg,<br>&nbsp;<span class="hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;SmallVectorImpl&lt;ISD::InputArg&gt;&nbsp;&amp;Ins,<br>&nbsp;<span class="hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;SDLoc&nbsp;&amp;DL,&nbsp;SelectionDAG&nbsp;&amp;DAG,<br>&nbsp;<span class="hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SmallVectorImpl&lt;SDValue&gt;&nbsp;&amp;InVals)</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override</span>;<br>&nbsp;<span class="hljs-number">34</span>&nbsp;<br>&nbsp;<span class="hljs-number">35</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function">SDValue&nbsp;<span class="hljs-title">LowerReturn</span><span class="hljs-params">(SDValue&nbsp;Chain,&nbsp;CallingConv::ID&nbsp;CallConv,&nbsp;<span class="hljs-keyword">bool</span>&nbsp;IsVarArg,<br>&nbsp;<span class="hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;SmallVectorImpl&lt;ISD::OutputArg&gt;&nbsp;&amp;Outs,<br>&nbsp;<span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;SmallVectorImpl&lt;SDValue&gt;&nbsp;&amp;OutVals,&nbsp;<span class="hljs-keyword">const</span>&nbsp;SDLoc&nbsp;&amp;DL,<br>&nbsp;<span class="hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SelectionDAG&nbsp;&amp;DAG)</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;override</span>;<br>&nbsp;<span class="hljs-number">39</span>&nbsp;};<br>&nbsp;<span class="hljs-number">40</span>&nbsp;<br>&nbsp;<span class="hljs-number">41</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;namespace&nbsp;llvm</span><br>&nbsp;<span class="hljs-number">42</span>&nbsp;<br>&nbsp;<span class="hljs-number">43</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVISELLOWERING_H</span></span><br></code></pre>
<ul>
<li><p>第 16 行，定义目标后端<code>MyRISCV</code>特有的操作码<code>MyRISCVISD::RET_FLAG</code>。这意味着，在选择机器指令（即<code>pre-isel</code>阶段）之前<code>SDNode</code>节点的操作码可以是<code>MyRISCVISD::RET_FLAG</code>。<strong>需要注意的是，</strong> 这些特定于目标的操作码的值应该大于<code>ISD::BUILTIN_OP_END</code>。</p></li>
<li><p>第 27 行，该函数用于返回特定于目标的<code>SDNode</code>节点的名称。</p></li>
<li><p>第 29～33 行，该函数用于 Lowering 函数参数。即将函数参数转换为何种<code>SDNode</code>节点。</p></li>
<li><p>第 35～38 行，该函数用于 Lowering 函数返回值。即将函数返回值转换何种<code>SDNode</code>节点。</p></li>
</ul>
<p><strong>step 11：</strong> MyRISCVISelLowering.cpp</p>
<p>llvm/lib/Target/MyRISCV/MyRISCVISelLowering.cpp 的内容如下：</p>
<pre><code class="hljs php">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MyRISCVISelLowering.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MyRISCVSubtarget.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MyRISCVTargetMachine.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MCTargetDesc/MyRISCVMCTargetDesc.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-comment">#include&nbsp;"llvm/CodeGen/CallingConvLower.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;using&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">llvm</span>;<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MyRISCVGenCallingConv.inc"</span><br>&nbsp;<span class="hljs-number">10</span>&nbsp;<br>&nbsp;<span class="hljs-number">11</span>&nbsp;MyRISCVTargetLowering::MyRISCVTargetLowering(MyRISCVTargetMachine&nbsp;&amp;TM)<br>&nbsp;<span class="hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;TargetLowering(TM),&nbsp;Subtarget(*TM.getSubtargetImpl())&nbsp;{<br>&nbsp;<span class="hljs-number">13</span>&nbsp;&nbsp;&nbsp;addRegisterClass(MVT::i32,&nbsp;&amp;MyRISCV::GPRRegClass);<br>&nbsp;<span class="hljs-number">14</span>&nbsp;&nbsp;&nbsp;computeRegisterProperties(Subtarget.getRegisterInfo());<br>&nbsp;<span class="hljs-number">15</span>&nbsp;}<br>&nbsp;<span class="hljs-number">16</span>&nbsp;<br>&nbsp;<span class="hljs-number">17</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;char&nbsp;*MyRISCVTargetLowering::getTargetNodeName(unsigned&nbsp;Opcode)&nbsp;<span class="hljs-keyword">const</span>&nbsp;{<br>&nbsp;<span class="hljs-number">18</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">switch</span>&nbsp;(Opcode)&nbsp;{<br>&nbsp;<span class="hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">case</span>&nbsp;MyRISCVISD::RET_FLAG:<br>&nbsp;<span class="hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-string">"MyRISCVISD::RET_FLAG"</span>;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">default</span>:<br>&nbsp;<span class="hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;nullptr;<br>&nbsp;<span class="hljs-number">23</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">24</span>&nbsp;}<br>&nbsp;<span class="hljs-number">25</span>&nbsp;<br>&nbsp;<span class="hljs-number">26</span>&nbsp;SDValue&nbsp;MyRISCVTargetLowering::LowerFormalArguments(SDValue&nbsp;Chain,<br>&nbsp;<span class="hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CallingConv::ID&nbsp;CallConv,&nbsp;bool&nbsp;IsVarArg,<br>&nbsp;<span class="hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;SmallVectorImpl&lt;ISD::InputArg&gt;&nbsp;&amp;Ins,<br>&nbsp;<span class="hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;SDLoc&nbsp;&amp;DL,&nbsp;SelectionDAG&nbsp;&amp;DAG,<br>&nbsp;<span class="hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SmallVectorImpl&lt;SDValue&gt;&nbsp;&amp;InVals)&nbsp;<span class="hljs-keyword">const</span>&nbsp;{<br>&nbsp;<span class="hljs-number">31</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;Chain;<br>&nbsp;<span class="hljs-number">32</span>&nbsp;}<br>&nbsp;<span class="hljs-number">33</span>&nbsp;<br>&nbsp;<span class="hljs-number">34</span>&nbsp;SDValue<br>&nbsp;<span class="hljs-number">35</span>&nbsp;MyRISCVTargetLowering::LowerReturn(SDValue&nbsp;Chain,&nbsp;CallingConv::ID&nbsp;CallConv,<br>&nbsp;<span class="hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool&nbsp;IsVarArg,<br>&nbsp;<span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;SmallVectorImpl&lt;ISD::OutputArg&gt;&nbsp;&amp;Outs,<br>&nbsp;<span class="hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;SmallVectorImpl&lt;SDValue&gt;&nbsp;&amp;OutVals,<br>&nbsp;<span class="hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;SDLoc&nbsp;&amp;DL,&nbsp;SelectionDAG&nbsp;&amp;DAG)&nbsp;<span class="hljs-keyword">const</span>&nbsp;{<br>&nbsp;<span class="hljs-number">40</span>&nbsp;&nbsp;&nbsp;SmallVector&lt;CCValAssign,&nbsp;<span class="hljs-number">16</span>&gt;&nbsp;RVLocs;<br>&nbsp;<span class="hljs-number">41</span>&nbsp;<br>&nbsp;<span class="hljs-number">42</span>&nbsp;&nbsp;&nbsp;CCState&nbsp;CCInfo(CallConv,&nbsp;IsVarArg,&nbsp;DAG.getMachineFunction(),&nbsp;RVLocs,<br>&nbsp;<span class="hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*DAG.getContext());<br>&nbsp;<span class="hljs-number">44</span>&nbsp;&nbsp;&nbsp;CCInfo.AnalyzeReturn(Outs,&nbsp;RetCC_MyRISCV);<br>&nbsp;<span class="hljs-number">45</span>&nbsp;<br>&nbsp;<span class="hljs-number">46</span>&nbsp;&nbsp;&nbsp;SDValue&nbsp;Glue;<br>&nbsp;<span class="hljs-number">47</span>&nbsp;&nbsp;&nbsp;SmallVector&lt;SDValue,&nbsp;<span class="hljs-number">4</span>&gt;&nbsp;RetOps(<span class="hljs-number">1</span>,&nbsp;Chain);<br>&nbsp;<span class="hljs-number">48</span>&nbsp;<br>&nbsp;<span class="hljs-number">49</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for</span>&nbsp;(unsigned&nbsp;i&nbsp;=&nbsp;<span class="hljs-number">0</span>,&nbsp;e&nbsp;=&nbsp;RVLocs.size();&nbsp;i&nbsp;&lt;&nbsp;e;&nbsp;++i)&nbsp;{<br>&nbsp;<span class="hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CCValAssign&nbsp;&amp;VA&nbsp;=&nbsp;RVLocs[i];<br>&nbsp;<span class="hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(VA.isRegLoc()&nbsp;&amp;&amp;&nbsp;<span class="hljs-string">"Can&nbsp;only&nbsp;return&nbsp;in&nbsp;registers!"</span>);<br>&nbsp;<span class="hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Chain&nbsp;=&nbsp;DAG.getCopyToReg(Chain,&nbsp;DL,&nbsp;VA.getLocReg(),&nbsp;OutVals[i],&nbsp;Glue);<br>&nbsp;<span class="hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Glue&nbsp;=&nbsp;Chain.getValue(<span class="hljs-number">1</span>);<br>&nbsp;<span class="hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RetOps.push_back(DAG.getRegister(VA.getLocReg(),&nbsp;VA.getLocVT()));<br>&nbsp;<span class="hljs-number">55</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">56</span>&nbsp;<br>&nbsp;<span class="hljs-number">57</span>&nbsp;&nbsp;&nbsp;RetOps[<span class="hljs-number">0</span>]&nbsp;=&nbsp;Chain;<br>&nbsp;<span class="hljs-number">58</span>&nbsp;<br>&nbsp;<span class="hljs-number">59</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Glue.getNode())&nbsp;{<br>&nbsp;<span class="hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RetOps.push_back(Glue);<br>&nbsp;<span class="hljs-number">61</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">62</span>&nbsp;<br>&nbsp;<span class="hljs-number">63</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;DAG.getNode(MyRISCVISD::RET_FLAG,&nbsp;DL,&nbsp;MVT::Other,&nbsp;RetOps);<br>&nbsp;<span class="hljs-number">64</span>&nbsp;}<br></code></pre>
<ul>
<li><p>第 26～32 行，由于本文的测试程序没有函数参数，因此，这里<code>LowerFormalArguments()</code>只是返回参数<code>Chain</code>。</p></li>
<li><p>第 34～64 行，将函数返回值转换为操作码为<code>MyRISCVISD::RET_FLAG</code>的<code>SDNode</code>节点<code>MyRISCVRetFlag</code>（定义在<code>llvm/lib/Target/MyRISCV/MyRISCVInstrInfo.td</code>文件中）。该节点的第 1 个操作数总是为<code>chain-edge</code>（对应第 57 行）；最后 1 个操作数可能是<code>glue-edge</code>（对应第 59～61 行）；中间的操作数为<code>regular-edge</code>（对应第 54 行），表示用于保存函数返回值的寄存器。</p></li>
</ul>
<p><strong>step 12：</strong> MyRISCVISelDAGToDAG.cpp</p>
<p><code>MyRISCVISelDAGToDAG.cpp</code>用于定义继承自<code>llvm::SelectionDAGISel</code>的派生类<code>MyRISCVDAGToDAGISel</code>，该类用于选择机器指令，位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs php">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MyRISCV.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MyRISCVTargetMachine.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<span class="hljs-comment">#include&nbsp;"MCTargetDesc/MyRISCVMCTargetDesc.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-comment">#include&nbsp;"llvm/CodeGen/SelectionDAGISel.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;using&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">llvm</span>;<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;{<br>&nbsp;&nbsp;9&nbsp;<br>&nbsp;10&nbsp;<span class="hljs-title">class</span>&nbsp;<span class="hljs-title">MyRISCVDAGToDAGISel</span>&nbsp;:&nbsp;<span class="hljs-title">public</span>&nbsp;<span class="hljs-title">SelectionDAGISel</span>&nbsp;{<br>&nbsp;11&nbsp;<span class="hljs-title">public</span>:<br>&nbsp;12&nbsp;&nbsp;&nbsp;<span class="hljs-title">explicit</span>&nbsp;<span class="hljs-title">MyRISCVDAGToDAGISel</span>(<span class="hljs-title">MyRISCVTargetMachine</span>&nbsp;&amp;<span class="hljs-title">TM</span>)<br>&nbsp;13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;<span class="hljs-title">SelectionDAGISel</span>(<span class="hljs-title">TM</span>)&nbsp;{}<br>&nbsp;14&nbsp;<br>&nbsp;15&nbsp;&nbsp;&nbsp;<span class="hljs-title">StringRef</span>&nbsp;<span class="hljs-title">getPassName</span>()&nbsp;<span class="hljs-title">const</span>&nbsp;<span class="hljs-title">override</span>&nbsp;{<br>&nbsp;16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title">return</span>&nbsp;"<span class="hljs-title">MyRISCV</span>&nbsp;<span class="hljs-title">DAG</span>-&gt;<span class="hljs-title">DAG</span>&nbsp;<span class="hljs-title">Pattern</span>&nbsp;<span class="hljs-title">Instruction</span>&nbsp;<span class="hljs-title">Selection</span>";<br>&nbsp;<span class="hljs-number">17</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">18</span>&nbsp;<br>&nbsp;<span class="hljs-number">19</span>&nbsp;&nbsp;&nbsp;void&nbsp;Select(SDNode&nbsp;*N)&nbsp;override;<br>&nbsp;<span class="hljs-number">20</span>&nbsp;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;<span class="hljs-keyword">private</span>:<br>&nbsp;<span class="hljs-number">22</span>&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#include&nbsp;"MyRISCVGenDAGISel.inc"</span><br>&nbsp;<span class="hljs-number">23</span>&nbsp;};<br>&nbsp;<span class="hljs-number">24</span>&nbsp;<br>&nbsp;<span class="hljs-number">25</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;anonymous&nbsp;namespace</span><br>&nbsp;<span class="hljs-number">26</span>&nbsp;<br>&nbsp;<span class="hljs-number">27</span>&nbsp;void&nbsp;MyRISCVDAGToDAGISel::Select(SDNode&nbsp;*N)&nbsp;{<br>&nbsp;<span class="hljs-number">28</span>&nbsp;&nbsp;&nbsp;SDLoc&nbsp;DL(N);<br>&nbsp;<span class="hljs-number">29</span>&nbsp;<br>&nbsp;<span class="hljs-number">30</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">switch</span>&nbsp;(N-&gt;getOpcode())&nbsp;{<br>&nbsp;<span class="hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">case</span>&nbsp;ISD::Constant:&nbsp;{<br>&nbsp;<span class="hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;Imm&nbsp;=&nbsp;cast&lt;ConstantSDNode&gt;(N)-&gt;getSExtValue();<br>&nbsp;<span class="hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(<span class="hljs-number">-2048</span>&nbsp;&lt;=&nbsp;Imm&nbsp;&amp;&amp;&nbsp;Imm&nbsp;&lt;=&nbsp;<span class="hljs-number">2047</span>)&nbsp;{<br>&nbsp;<span class="hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SDValue&nbsp;SDImm&nbsp;=&nbsp;CurDAG-&gt;getTargetConstant(Imm,&nbsp;DL,&nbsp;MVT::i32);<br>&nbsp;<span class="hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SDValue&nbsp;SrcReg&nbsp;=&nbsp;CurDAG-&gt;getRegister(MyRISCV::X0,&nbsp;MVT::i32);<br>&nbsp;<span class="hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SDNode&nbsp;*Result&nbsp;=<br>&nbsp;<span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CurDAG-&gt;getMachineNode(MyRISCV::ADDI,&nbsp;DL,&nbsp;MVT::i32,&nbsp;SrcReg,&nbsp;SDImm);<br>&nbsp;<span class="hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReplaceNode(N,&nbsp;Result);<br>&nbsp;<span class="hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>;<br>&nbsp;<span class="hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">42</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">43</span>&nbsp;<br>&nbsp;<span class="hljs-number">44</span>&nbsp;&nbsp;&nbsp;SelectCode(N);<br>&nbsp;<span class="hljs-number">45</span>&nbsp;}<br>&nbsp;<span class="hljs-number">46</span>&nbsp;<br>&nbsp;<span class="hljs-number">47</span>&nbsp;FunctionPass&nbsp;*llvm::createMyRISCVISelDag(MyRISCVTargetMachine&nbsp;&amp;TM)&nbsp;{<br>&nbsp;<span class="hljs-number">48</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-keyword">new</span>&nbsp;MyRISCVDAGToDAGISel(TM);<br>&nbsp;<span class="hljs-number">49</span>&nbsp;}<br></code></pre>
<ul>
<li><p>第 15～17 行，返回指令选择 Pass——<code>MyRISCVDAGToDAGISel</code>的名称。</p></li>
<li><p>第 27～45 行，函数<code>Select()</code>用于选择机器指令。其中，<code>SelectCode()</code>函数是由 TableGen 根据<code>.td</code>文件中定义的 Patterns 自动生成的，在调用该函数之前，我们可以对某些<code>SDNode</code>节点进行特殊处理（对应第 28~40 行）。由于<code>RISCV</code>中没有数据传送指令。因此，这里使用<code>addi</code>指令将立即数（仅限于大小范围为<code>[-2048, 2047]</code>的整数）拷贝到寄存器中。</p></li>
</ul>
<p><strong>step 13：</strong> MyRISCVInstrInfo.h</p>
<p><code>MyRISCVInstrInfo.h</code>用于声明继承自<code>llvm::MyRISCVGenInstrInfo</code>（位于<code>MyRISCVGenInstrInfo.inc</code>文件）的派生类<code>MyRISCVInstrInfo</code>，位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVINSTRINFO_H</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVINSTRINFO_H</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/CodeGen/TargetInstrInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_INSTRINFO_HEADER</span><br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenInstrInfo.inc"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm&nbsp;{<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<br>&nbsp;<span class="hljs-number">11</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVSubtarget</span>;</span><br>&nbsp;<span class="hljs-number">12</span>&nbsp;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVInstrInfo</span>&nbsp;:</span>&nbsp;<span class="hljs-keyword">public</span>&nbsp;MyRISCVGenInstrInfo&nbsp;{<br>&nbsp;<span class="hljs-number">14</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;MyRISCVSubtarget&nbsp;&amp;STI;<br>&nbsp;<span class="hljs-number">15</span>&nbsp;<br>&nbsp;<span class="hljs-number">16</span>&nbsp;<span class="hljs-keyword">public</span>:<br>&nbsp;<span class="hljs-number">17</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">explicit</span>&nbsp;<span class="hljs-title">MyRISCVInstrInfo</span><span class="hljs-params">(MyRISCVSubtarget&nbsp;&amp;STI)</span></span>;<br>&nbsp;<span class="hljs-number">18</span>&nbsp;};<br>&nbsp;<span class="hljs-number">19</span>&nbsp;<br>&nbsp;<span class="hljs-number">20</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;namespace&nbsp;llvm</span><br>&nbsp;<span class="hljs-number">21</span>&nbsp;<br>&nbsp;<span class="hljs-number">22</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVINSTRINFO_H</span></span><br></code></pre>
<p><strong>step 14：</strong> MyRISCVInstrInfo.cpp</p>
<p>llvm/lib/Target/MyRISCV/MyRISCVInstrInfo.cpp 的内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVInstrInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVSubtarget.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MCTargetDesc/MyRISCVMCTargetDesc.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-keyword">using</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_INSTRINFO_CTOR_DTOR</span><br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenInstrInfo.inc"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;MyRISCVInstrInfo::MyRISCVInstrInfo(MyRISCVSubtarget&nbsp;&amp;STI)<br>&nbsp;<span class="hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;MyRISCVGenInstrInfo(),&nbsp;STI(STI)&nbsp;{}<br></code></pre>
<p><strong>step 15：</strong> MyRISCVFrameLowering.h</p>
<p><code>MyRISCVInstrInfo.h</code>用于声明继承自<code>llvm::TargetFrameLowering</code>的派生类<code>MyRISCVFrameLowering</code>，位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs cs">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#ifndef&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVFRAMELOWERING_H</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVFRAMELOWERING_H</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#include&nbsp;"llvm/CodeGen/TargetFrameLowering.h"</span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">llvm</span>&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVSubtarget</span>;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVFrameLowering</span>&nbsp;:&nbsp;<span class="hljs-title">public</span>&nbsp;<span class="hljs-title">TargetFrameLowering</span>&nbsp;{<br>&nbsp;<span class="hljs-number">11</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;MyRISCVSubtarget&nbsp;&amp;STI;<br>&nbsp;<span class="hljs-number">12</span>&nbsp;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<span class="hljs-keyword">public</span>:<br>&nbsp;<span class="hljs-number">14</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">explicit</span>&nbsp;<span class="hljs-title">MyRISCVFrameLowering</span>(<span class="hljs-params"><span class="hljs-keyword">const</span>&nbsp;MyRISCVSubtarget&nbsp;&amp;STI</span>)<br>&nbsp;15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;<span class="hljs-title">TargetFrameLowering</span>(<span class="hljs-params">StackGrowsDown,<br>&nbsp;<span class="hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*StackAlignment=*/</span>Align(<span class="hljs-number">16</span></span>),<br>&nbsp;17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*LocalAreaOffset=*/</span>0),<br>&nbsp;18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title">STI</span>(<span class="hljs-params">STI</span>)&nbsp;</span>{}<br>&nbsp;<span class="hljs-number">19</span>&nbsp;<br>&nbsp;<span class="hljs-number">20</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">emitPrologue</span>(<span class="hljs-params">MachineFunction&nbsp;&amp;MF,&nbsp;MachineBasicBlock&nbsp;&amp;MBB</span>)&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">override</span></span>;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;<br>&nbsp;<span class="hljs-number">22</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">emitEpilogue</span>(<span class="hljs-params">MachineFunction&nbsp;&amp;MF,&nbsp;MachineBasicBlock&nbsp;&amp;MBB</span>)&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">override</span></span>;<br>&nbsp;<span class="hljs-number">23</span>&nbsp;<br>&nbsp;<span class="hljs-number">24</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">hasFP</span>(<span class="hljs-params"><span class="hljs-keyword">const</span>&nbsp;MachineFunction&nbsp;&amp;MF</span>)&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">override</span></span>;<br>&nbsp;<span class="hljs-number">25</span>&nbsp;};<br>&nbsp;<span class="hljs-number">26</span>&nbsp;<br>&nbsp;<span class="hljs-number">27</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;namespace&nbsp;llvm</span><br>&nbsp;<span class="hljs-number">28</span>&nbsp;<br>&nbsp;<span class="hljs-number">29</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;&nbsp;//&nbsp;LLVM_LIB_TARGET_MYRISCV_MYRISCVFRAMELOWERING_H</span><br></code></pre>
<ul>
<li><p>第 20～22 行，每个目标后端至少需要覆写基类<code>llvm::TargetFrameLowering</code>中的这 2 个虚函数。</p>
<p>函数<code>emitPrologue()</code>，用于分配栈内存。</p>
<p>函数<code>emitEpilogue()</code>，用于回收栈内存。</p></li>
<li><p>第 24 行，函数<code>hasFP()</code>用于返回<code>MF</code>中是否应该有帧指针寄存器。</p></li>
</ul>
<p><strong>step 16：</strong> MyRISCVFrameLowering.cpp</p>
<p>llvm/lib/Target/MyRISCV/MyRISCVFrameLowering.cpp 的内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVFrameLowering.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/CodeGen/MachineFunction.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-keyword">using</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm;<br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;MyRISCVFrameLowering::emitPrologue(MachineFunction&nbsp;&amp;MF,<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MachineBasicBlock&nbsp;&amp;MBB)&nbsp;<span class="hljs-keyword">const</span>&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;}<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;MyRISCVFrameLowering::emitEpilogue(MachineFunction&nbsp;&amp;MF,<br>&nbsp;<span class="hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MachineBasicBlock&nbsp;&amp;MBB)&nbsp;<span class="hljs-keyword">const</span>&nbsp;{<br>&nbsp;<span class="hljs-number">12</span>&nbsp;}<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<br>&nbsp;<span class="hljs-number">14</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;MyRISCVFrameLowering::hasFP(<span class="hljs-keyword">const</span>&nbsp;MachineFunction&nbsp;&amp;MF)&nbsp;<span class="hljs-keyword">const</span>&nbsp;{<br>&nbsp;<span class="hljs-number">15</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-literal">false</span>;<br>&nbsp;<span class="hljs-number">16</span>&nbsp;}<br></code></pre>
<p><strong>step 17：</strong> MyRISCVAsmPrinter.cpp</p>
<p><code>MyRISCVAsmPrinter.cpp</code>用于定义继承自<code>llvm::AsmPrinter</code>的派生类<code>MyRISCVAsmPrinter</code>，位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"TargetInfo/MyRISCVTargetInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MCTargetDesc/MyRISCVMCTargetDesc.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVMCInstLower.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/CodeGen/AsmPrinter.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/MC/MCStreamer.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/Support/TargetRegistry.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-keyword">using</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;{<br>&nbsp;<span class="hljs-number">11</span>&nbsp;<br>&nbsp;<span class="hljs-number">12</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVAsmPrinter</span>&nbsp;:</span>&nbsp;<span class="hljs-keyword">public</span>&nbsp;AsmPrinter&nbsp;{<br>&nbsp;<span class="hljs-number">13</span>&nbsp;&nbsp;&nbsp;MyRISCVMCInstLower&nbsp;MCInstLowering;<br>&nbsp;<span class="hljs-number">14</span>&nbsp;<br>&nbsp;<span class="hljs-number">15</span>&nbsp;<span class="hljs-keyword">public</span>:<br>&nbsp;<span class="hljs-number">16</span>&nbsp;&nbsp;&nbsp;MyRISCVAsmPrinter(TargetMachine&nbsp;&amp;TM,&nbsp;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;MCStreamer&gt;&nbsp;Streamer)<br>&nbsp;<span class="hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;AsmPrinter(TM,&nbsp;<span class="hljs-built_in">std</span>::move(Streamer)),&nbsp;MCInstLowering(OutContext,&nbsp;*<span class="hljs-keyword">this</span>)&nbsp;{}<br>&nbsp;<span class="hljs-number">18</span>&nbsp;<br>&nbsp;<span class="hljs-number">19</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">emitInstruction</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;MachineInstr&nbsp;*MI)</span>&nbsp;override</span>;<br>&nbsp;<span class="hljs-number">20</span>&nbsp;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;<span class="hljs-keyword">private</span>:<br>&nbsp;<span class="hljs-number">22</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">emitPseudoExpansionLowering</span><span class="hljs-params">(MCStreamer&nbsp;&amp;OutStreamer,<br>&nbsp;<span class="hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;MachineInstr&nbsp;*MI)</span></span>;<br>&nbsp;<span class="hljs-number">24</span>&nbsp;};<br>&nbsp;<span class="hljs-number">25</span>&nbsp;<br>&nbsp;<span class="hljs-number">26</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;anonymous&nbsp;namespace</span><br>&nbsp;<span class="hljs-number">27</span>&nbsp;<br>&nbsp;<span class="hljs-number">28</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenMCPseudoLowering.inc"</span></span><br>&nbsp;<span class="hljs-number">29</span>&nbsp;<br>&nbsp;<span class="hljs-number">30</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;MyRISCVAsmPrinter::emitInstruction(<span class="hljs-keyword">const</span>&nbsp;MachineInstr&nbsp;*MI)&nbsp;{<br>&nbsp;<span class="hljs-number">31</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(emitPseudoExpansionLowering(*OutStreamer,&nbsp;MI))&nbsp;{<br>&nbsp;<span class="hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>;<br>&nbsp;<span class="hljs-number">33</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">34</span>&nbsp;<br>&nbsp;<span class="hljs-number">35</span>&nbsp;&nbsp;&nbsp;MCInst&nbsp;TmpInst;<br>&nbsp;<span class="hljs-number">36</span>&nbsp;&nbsp;&nbsp;MCInstLowering.Lower(MI,&nbsp;TmpInst);<br>&nbsp;<span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;EmitToStreamer(*OutStreamer,&nbsp;TmpInst);<br>&nbsp;<span class="hljs-number">38</span>&nbsp;}<br>&nbsp;<span class="hljs-number">39</span>&nbsp;<br>&nbsp;<span class="hljs-number">40</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-string">"C"</span>&nbsp;<span class="hljs-function">LLVM_EXTERNAL_VISIBILITY&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">LLVMInitializeMyRISCVAsmPrinter</span><span class="hljs-params">()</span>&nbsp;</span>{<br>&nbsp;<span class="hljs-number">41</span>&nbsp;&nbsp;&nbsp;RegisterAsmPrinter&lt;MyRISCVAsmPrinter&gt;&nbsp;X(getMyRISCV32Target());<br>&nbsp;<span class="hljs-number">42</span>&nbsp;}<br></code></pre>
<ul>
<li><p>第 22～24 行，函数<code>emitPseudoExpansionLowering()</code>由 TableGen 生成（定义在<code>MyRISCVGenMCPseudoLowering.inc</code>文件）。该函数用于处理伪指令。</p></li>
<li><p>第 30～38 行，每个目标后端至少需要覆写基类<code>llvm::AsmPrinter</code>中的虚函数<code>emitInstruction()</code>。该函数用于将机器指令的表示形式转换为<code>MCInst</code>。</p></li>
</ul>
<p><strong>step 18：</strong> CMakeLists.txt</p>
<p>llvm/lib/Target/MyRISCV/CMakeLists.txt 的内容如下：</p>
<pre><code class="hljs cpp">add_llvm_component_group(MyRISCV)<br><br><span class="hljs-built_in">set</span>(LLVM_TARGET_DEFINITIONS&nbsp;MyRISCV.td)<br><br>tablegen(LLVM&nbsp;MyRISCVGenAsmWriter.inc&nbsp;-gen-<span class="hljs-keyword">asm</span>-writer)<br>tablegen(LLVM&nbsp;MyRISCVGenCallingConv.inc&nbsp;-gen-callingconv)<br>tablegen(LLVM&nbsp;MyRISCVGenDAGISel.inc&nbsp;-gen-dag-isel)<br>tablegen(LLVM&nbsp;MyRISCVGenInstrInfo.inc&nbsp;-gen-instr-info)<br>tablegen(LLVM&nbsp;MyRISCVGenMCPseudoLowering.inc&nbsp;-gen-pseudo-lowering)<br>tablegen(LLVM&nbsp;MyRISCVGenRegisterInfo.inc&nbsp;-gen-<span class="hljs-keyword">register</span>-info)<br>tablegen(LLVM&nbsp;MyRISCVGenSubtargetInfo.inc&nbsp;-gen-subtarget)<br><br>add_public_tablegen_target(MyRISCVCommonTableGen)<br><br><span class="hljs-built_in">set</span>(sources<br>&nbsp;&nbsp;MyRISCVTargetMachine.cpp<br>&nbsp;&nbsp;MyRISCVISelDAGToDAG.cpp<br>&nbsp;&nbsp;MyRISCVAsmPrinter.cpp<br>&nbsp;&nbsp;MyRISCVSubtarget.cpp<br>&nbsp;&nbsp;MyRISCVISelLowering.cpp<br>&nbsp;&nbsp;MyRISCVFrameLowering.cpp<br>&nbsp;&nbsp;MyRISCVInstrInfo.cpp<br>&nbsp;&nbsp;MyRISCVRegisterInfo.cpp<br>&nbsp;&nbsp;MyRISCVMCInstLower.cpp<br>)<br><br>add_llvm_target(MyRISCVCodeGen&nbsp;${sources}<br>&nbsp;&nbsp;LINK_COMPONENTS<br>&nbsp;&nbsp;AsmPrinter<br>&nbsp;&nbsp;Core<br>&nbsp;&nbsp;CodeGen<br>&nbsp;&nbsp;MC<br>&nbsp;&nbsp;MyRISCVDesc<br>&nbsp;&nbsp;MyRISCVInfo<br>&nbsp;&nbsp;SelectionDAG<br>&nbsp;&nbsp;Support<br>&nbsp;&nbsp;Target<br><br>&nbsp;&nbsp;ADD_TO_COMPONENT<br>&nbsp;&nbsp;MyRISCV<br>)<br><br>add_subdirectory(MCTargetDesc)<br>add_subdirectory(TargetInfo)<br></code></pre>
<p><strong>step 19：</strong> MyRISCVMCTargetDesc.h</p>
<p>llvm/lib/Target/MyRISCV/MCTargetDesc/MyRISCVMCTargetDesc.h 的内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MCTARGETDESC_MYRISCVMCTARGETDESC_H</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MCTARGETDESC_MYRISCVMCTARGETDESC_H</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_REGINFO_ENUM</span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenRegisterInfo.inc"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_INSTRINFO_ENUM</span><br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenInstrInfo.inc"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_SUBTARGETINFO_ENUM</span><br>&nbsp;<span class="hljs-number">11</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenSubtargetInfo.inc"</span></span><br>&nbsp;<span class="hljs-number">12</span>&nbsp;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;<span class="hljs-comment">//&nbsp;LLVM_LIB_TARGET_MYRISCV_MCTARGETDESC_MYRISCVMCTARGETDESC_H</span></span><br></code></pre>
<p><strong>step 20：</strong> MyRISCVMCTargetDesc.cpp</p>
<p>llvm/lib/Target/MyRISCV/MCTargetDesc/MyRISCVMCTargetDesc.cpp 的内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVMCTargetDesc.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVMCAsmInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVInstPrinter.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"TargetInfo/MyRISCVTargetInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/MC/MCInstrInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/MC/MCRegisterInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/MC/MCSubtargetInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/Support/TargetRegistry.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_INSTRINFO_MC_DESC</span><br>&nbsp;<span class="hljs-number">11</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenInstrInfo.inc"</span></span><br>&nbsp;<span class="hljs-number">12</span>&nbsp;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_REGINFO_MC_DESC</span><br>&nbsp;<span class="hljs-number">14</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenRegisterInfo.inc"</span></span><br>&nbsp;<span class="hljs-number">15</span>&nbsp;<br>&nbsp;<span class="hljs-number">16</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;GET_SUBTARGETINFO_MC_DESC</span><br>&nbsp;<span class="hljs-number">17</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenSubtargetInfo.inc"</span></span><br>&nbsp;<span class="hljs-number">18</span>&nbsp;<br>&nbsp;<span class="hljs-number">19</span>&nbsp;<span class="hljs-keyword">using</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm;<br>&nbsp;<span class="hljs-number">20</span>&nbsp;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;{<br>&nbsp;<span class="hljs-number">22</span>&nbsp;<br>&nbsp;<span class="hljs-number">23</span>&nbsp;<span class="hljs-function">MCInstrInfo&nbsp;*<span class="hljs-title">createMyRISCVMCInstrInfo</span><span class="hljs-params">()</span>&nbsp;</span>{<br>&nbsp;<span class="hljs-number">24</span>&nbsp;&nbsp;&nbsp;MCInstrInfo&nbsp;*X&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;MCInstrInfo();<br>&nbsp;<span class="hljs-number">25</span>&nbsp;&nbsp;&nbsp;InitMyRISCVMCInstrInfo(X);<br>&nbsp;<span class="hljs-number">26</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;X;<br>&nbsp;<span class="hljs-number">27</span>&nbsp;}<br>&nbsp;<span class="hljs-number">28</span>&nbsp;<br>&nbsp;<span class="hljs-number">29</span>&nbsp;<span class="hljs-function">MCRegisterInfo&nbsp;*<span class="hljs-title">createMyRISCVMCRegisterInfo</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;TT)</span>&nbsp;</span>{<br>&nbsp;<span class="hljs-number">30</span>&nbsp;&nbsp;&nbsp;MCRegisterInfo&nbsp;*X&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;MCRegisterInfo();<br>&nbsp;<span class="hljs-number">31</span>&nbsp;&nbsp;&nbsp;InitMyRISCVMCRegisterInfo(X,&nbsp;MyRISCV::X1);<br>&nbsp;<span class="hljs-number">32</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;X;<br>&nbsp;<span class="hljs-number">33</span>&nbsp;}<br>&nbsp;<span class="hljs-number">34</span>&nbsp;<br>&nbsp;<span class="hljs-number">35</span>&nbsp;<span class="hljs-function">MCAsmInfo&nbsp;*<span class="hljs-title">createMyRISCVMCAsmInfo</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;MCRegisterInfo&nbsp;&amp;MRI,&nbsp;<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;TT,<br>&nbsp;<span class="hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;MCTargetOptions&nbsp;&amp;Options)</span>&nbsp;</span>{<br>&nbsp;<span class="hljs-number">37</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-keyword">new</span>&nbsp;MyRISCVMCAsmInfo(TT);<br>&nbsp;<span class="hljs-number">38</span>&nbsp;}<br>&nbsp;<span class="hljs-number">39</span>&nbsp;<br>&nbsp;<span class="hljs-number">40</span>&nbsp;<span class="hljs-function">MCSubtargetInfo&nbsp;*<span class="hljs-title">createMyRISCVMCSubtargetInfo</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;TT,<br>&nbsp;<span class="hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringRef&nbsp;CPU,&nbsp;StringRef&nbsp;FS)</span>&nbsp;</span>{<br>&nbsp;<span class="hljs-number">42</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(CPU.empty())&nbsp;{<br>&nbsp;<span class="hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(TT.isArch32Bit()&nbsp;&amp;&amp;&nbsp;<span class="hljs-string">"Only&nbsp;RV32&nbsp;is&nbsp;currently&nbsp;supported!"</span>);<br>&nbsp;<span class="hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CPU&nbsp;=&nbsp;<span class="hljs-string">"generic-rv32"</span>;<br>&nbsp;<span class="hljs-number">45</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">46</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;createMyRISCVMCSubtargetInfoImpl(TT,&nbsp;CPU,&nbsp;CPU,&nbsp;FS);<br>&nbsp;<span class="hljs-number">47</span>&nbsp;}<br>&nbsp;<span class="hljs-number">48</span>&nbsp;<br>&nbsp;<span class="hljs-number">49</span>&nbsp;<span class="hljs-function">MCInstPrinter&nbsp;*<span class="hljs-title">createMyRISCVMCInstPrinter</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;T,<br>&nbsp;<span class="hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">unsigned</span>&nbsp;SyntaxVariant,<br>&nbsp;<span class="hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;MCAsmInfo&nbsp;&amp;MAI,<br>&nbsp;<span class="hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;MCInstrInfo&nbsp;&amp;MII,<br>&nbsp;<span class="hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;MCRegisterInfo&nbsp;&amp;MRI)</span>&nbsp;</span>{<br>&nbsp;<span class="hljs-number">54</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-keyword">new</span>&nbsp;MyRISCVInstPrinter(MAI,&nbsp;MII,&nbsp;MRI);<br>&nbsp;<span class="hljs-number">55</span>&nbsp;}<br>&nbsp;<span class="hljs-number">56</span>&nbsp;<br>&nbsp;<span class="hljs-number">57</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;anonymous&nbsp;namespace</span><br>&nbsp;<span class="hljs-number">58</span>&nbsp;<br>&nbsp;<span class="hljs-number">59</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-string">"C"</span>&nbsp;<span class="hljs-function">LLVM_EXTERNAL_VISIBILITY&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">LLVMInitializeMyRISCVTargetMC</span><span class="hljs-params">()</span>&nbsp;</span>{<br>&nbsp;<span class="hljs-number">60</span>&nbsp;&nbsp;&nbsp;Target&nbsp;&amp;RV32&nbsp;=&nbsp;getMyRISCV32Target();<br>&nbsp;<span class="hljs-number">61</span>&nbsp;&nbsp;&nbsp;TargetRegistry::RegisterMCAsmInfo(RV32,&nbsp;createMyRISCVMCAsmInfo);<br>&nbsp;<span class="hljs-number">62</span>&nbsp;&nbsp;&nbsp;TargetRegistry::RegisterMCInstrInfo(RV32,&nbsp;createMyRISCVMCInstrInfo);<br>&nbsp;<span class="hljs-number">63</span>&nbsp;&nbsp;&nbsp;TargetRegistry::RegisterMCRegInfo(RV32,&nbsp;createMyRISCVMCRegisterInfo);<br>&nbsp;<span class="hljs-number">64</span>&nbsp;&nbsp;&nbsp;TargetRegistry::RegisterMCSubtargetInfo(RV32,&nbsp;createMyRISCVMCSubtargetInfo);<br>&nbsp;<span class="hljs-number">65</span>&nbsp;&nbsp;&nbsp;TargetRegistry::RegisterMCInstPrinter(RV32,&nbsp;createMyRISCVMCInstPrinter);<br>&nbsp;<span class="hljs-number">66</span>&nbsp;}<br></code></pre>
<p><strong>step 21：</strong> MyRISCVMCAsmInfo.h</p>
<p>llvm/lib/Target/MyRISCV/MCTargetDesc/MyRISCVMCAsmInfo.h 的内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MCTARGETDESC_MYRISCVMCASMINFO_H</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MCTARGETDESC_MYRISCVMCASMINFO_H</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/MC/MCAsmInfoELF.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Triple</span>;</span><br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVMCAsmInfo</span>&nbsp;:</span>&nbsp;<span class="hljs-keyword">public</span>&nbsp;MCAsmInfoELF&nbsp;{<br>&nbsp;<span class="hljs-number">11</span>&nbsp;<span class="hljs-keyword">public</span>:<br>&nbsp;<span class="hljs-number">12</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">explicit</span>&nbsp;<span class="hljs-title">MyRISCVMCAsmInfo</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;TT)</span></span>;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;};<br>&nbsp;<span class="hljs-number">14</span>&nbsp;<br>&nbsp;<span class="hljs-number">15</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;namespace&nbsp;llvm</span><br>&nbsp;<span class="hljs-number">16</span>&nbsp;<br>&nbsp;<span class="hljs-number">17</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;<span class="hljs-comment">//&nbsp;LLVM_LIB_TARGET_MYRISCV_MCTARGETDESC_MYRISCVMCASMINFO_H</span></span><br></code></pre>
<p><strong>step 22：</strong> MyRISCVMCAsmInfo.cpp</p>
<p>llvm/lib/Target/MyRISCV/MCTargetDesc/MyRISCVMCAsmInfo.cpp 的内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVMCAsmInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/ADT/Triple.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-keyword">using</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm;<br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;MyRISCVMCAsmInfo::MyRISCVMCAsmInfo(<span class="hljs-keyword">const</span>&nbsp;Triple&nbsp;&amp;TT)&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;&nbsp;&nbsp;assert(TT.isArch32Bit()&nbsp;&amp;&amp;&nbsp;<span class="hljs-string">"Only&nbsp;RV32&nbsp;is&nbsp;currently&nbsp;supported!"</span>);<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;&nbsp;&nbsp;CodePointerSize&nbsp;=&nbsp;CalleeSaveStackSlotSize&nbsp;=&nbsp;TT.isArch32Bit()&nbsp;?&nbsp;<span class="hljs-number">4</span>&nbsp;:&nbsp;<span class="hljs-number">4</span>;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;&nbsp;&nbsp;CommentString&nbsp;=&nbsp;<span class="hljs-string">"#"</span>;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;&nbsp;&nbsp;Data16bitsDirective&nbsp;=&nbsp;<span class="hljs-string">"\t.half\t"</span>;<br>&nbsp;<span class="hljs-number">11</span>&nbsp;&nbsp;&nbsp;Data32bitsDirective&nbsp;=&nbsp;<span class="hljs-string">"\t.word\t"</span>;<br>&nbsp;<span class="hljs-number">12</span>&nbsp;}<br></code></pre>
<p><strong>step 23：</strong> MyRISCVInstPrinter.h</p>
<p><code>MyRISCVInstPrinter.h</code>用于声明继承自<code>llvm::MCInstPrinter</code>的派生类<code>MyRISCVInstPrinter</code>，该类负责打印汇编代码，位于<code>llvm/lib/Target/MyRISCV</code>目录中，其内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MCTARGETDESC_MYRISCVINSTPRINTER_H</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_MCTARGETDESC_MYRISCVINSTPRINTER_H</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/MC/MCInstPrinter.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">MyRISCVInstPrinter</span>&nbsp;:</span>&nbsp;<span class="hljs-keyword">public</span>&nbsp;MCInstPrinter&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-keyword">public</span>:<br>&nbsp;<span class="hljs-number">10</span>&nbsp;&nbsp;&nbsp;MyRISCVInstPrinter(<span class="hljs-keyword">const</span>&nbsp;MCAsmInfo&nbsp;&amp;MAI,&nbsp;<span class="hljs-keyword">const</span>&nbsp;MCInstrInfo&nbsp;&amp;MII,<br>&nbsp;<span class="hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;MCRegisterInfo&nbsp;&amp;MRI)<br>&nbsp;<span class="hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;MCInstPrinter(MAI,&nbsp;MII,&nbsp;MRI)&nbsp;{}<br>&nbsp;<span class="hljs-number">13</span>&nbsp;<br>&nbsp;<span class="hljs-number">14</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">printInst</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;MCInst&nbsp;*MI,&nbsp;<span class="hljs-keyword">uint64_t</span>&nbsp;Address,&nbsp;StringRef&nbsp;Annot,<br>&nbsp;<span class="hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;MCSubtargetInfo&nbsp;&amp;STI,&nbsp;raw_ostream&nbsp;&amp;OS)</span>&nbsp;override</span>;<br>&nbsp;<span class="hljs-number">16</span>&nbsp;<br>&nbsp;<span class="hljs-number">17</span>&nbsp;<span class="hljs-keyword">private</span>:<br>&nbsp;<span class="hljs-number">18</span>&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;*,&nbsp;<span class="hljs-keyword">uint64_t</span>&gt;&nbsp;getMnemonic(<span class="hljs-keyword">const</span>&nbsp;MCInst&nbsp;*MI)&nbsp;override;<br>&nbsp;<span class="hljs-number">19</span>&nbsp;<br>&nbsp;<span class="hljs-number">20</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">printInstruction</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;MCInst&nbsp;*MI,&nbsp;<span class="hljs-keyword">uint64_t</span>&nbsp;Address,&nbsp;raw_ostream&nbsp;&amp;O)</span></span>;<br>&nbsp;<span class="hljs-number">21</span>&nbsp;<br>&nbsp;<span class="hljs-number">22</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">printAliasInstr</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;MCInst&nbsp;*MI,&nbsp;<span class="hljs-keyword">uint64_t</span>&nbsp;Address,&nbsp;raw_ostream&nbsp;&amp;O)</span></span>;<br>&nbsp;<span class="hljs-number">23</span>&nbsp;<br>&nbsp;<span class="hljs-number">24</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;*<span class="hljs-title">getRegisterName</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span>&nbsp;RegNo,&nbsp;<span class="hljs-keyword">unsigned</span>&nbsp;AltIdx)</span></span>;<br>&nbsp;<span class="hljs-number">25</span>&nbsp;<br>&nbsp;<span class="hljs-number">26</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">printCustomAliasOperand</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;MCInst&nbsp;*MI,&nbsp;<span class="hljs-keyword">uint64_t</span>&nbsp;Address,<br>&nbsp;<span class="hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">unsigned</span>&nbsp;OpIdx,&nbsp;<span class="hljs-keyword">unsigned</span>&nbsp;PrintMethodIdx,<br>&nbsp;<span class="hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raw_ostream&nbsp;&amp;O)</span></span>;<br>&nbsp;<span class="hljs-number">29</span>&nbsp;<br>&nbsp;<span class="hljs-number">30</span>&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">printOperand</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;MCInst&nbsp;*MI,&nbsp;<span class="hljs-keyword">unsigned</span>&nbsp;OpNo,&nbsp;raw_ostream&nbsp;&amp;O)</span></span>;<br>&nbsp;<span class="hljs-number">31</span>&nbsp;};<br>&nbsp;<span class="hljs-number">32</span>&nbsp;<br>&nbsp;<span class="hljs-number">33</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;namespace&nbsp;llvm</span><br>&nbsp;<span class="hljs-number">34</span>&nbsp;<br>&nbsp;<span class="hljs-number">35</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;<span class="hljs-comment">//&nbsp;LLVM_LIB_TARGET_MYRISCV_MCTARGETDESC_MYRISCVINSTPRINTER_H</span></span><br></code></pre>
<ul>
<li><p>第 14～15 行，每个目标后端至少需要覆写基类<code>llvm::MCInstPrinter</code>中的虚函数<code>printInst()</code>。该函数用于打印汇编代码。</p></li>
<li><p>第 20～28 行，这些函数由 TableGen 生成的，其实现位于<code>MyRISCVGenAsmWriter.inc</code>文件，这里需要提供其函数声明。</p></li>
<li><p>第 30 行，自定义私有成员函数<code>printOperand()</code>，用于打印指令的操作数。</p></li>
</ul>
<p><strong>step 24：</strong> MyRISCVInstPrinter.cpp</p>
<p>llvm/lib/Target/MyRISCV/MCTargetDesc/MyRISCVInstPrinter.cpp 的内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVInstPrinter.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MCTargetDesc/MyRISCVMCTargetDesc.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/MC/MCInst.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/MC/MCExpr.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/Support/FormattedStream.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<span class="hljs-keyword">using</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm;<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;PRINT_ALIAS_INSTR</span><br>&nbsp;<span class="hljs-number">10</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"MyRISCVGenAsmWriter.inc"</span></span><br>&nbsp;<span class="hljs-number">11</span>&nbsp;<br>&nbsp;<span class="hljs-number">12</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;MyRISCVInstPrinter::printInst(<span class="hljs-keyword">const</span>&nbsp;MCInst&nbsp;*MI,&nbsp;<span class="hljs-keyword">uint64_t</span>&nbsp;Address,<br>&nbsp;<span class="hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringRef&nbsp;Annot,&nbsp;<span class="hljs-keyword">const</span>&nbsp;MCSubtargetInfo&nbsp;&amp;STI,<br>&nbsp;<span class="hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raw_ostream&nbsp;&amp;OS)&nbsp;{<br>&nbsp;<span class="hljs-number">15</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!printAliasInstr(MI,&nbsp;Address,&nbsp;OS))&nbsp;{<br>&nbsp;<span class="hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printInstruction(MI,&nbsp;Address,&nbsp;OS);<br>&nbsp;<span class="hljs-number">17</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">18</span>&nbsp;}<br>&nbsp;<span class="hljs-number">19</span>&nbsp;<br>&nbsp;<span class="hljs-number">20</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;MyRISCVInstPrinter::printOperand(<span class="hljs-keyword">const</span>&nbsp;MCInst&nbsp;*MI,&nbsp;<span class="hljs-keyword">unsigned</span>&nbsp;OpNo,<br>&nbsp;<span class="hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raw_ostream&nbsp;&amp;OS)&nbsp;{<br>&nbsp;<span class="hljs-number">22</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span>&nbsp;MCOperand&nbsp;&amp;MO&nbsp;=&nbsp;MI-&gt;getOperand(OpNo);<br>&nbsp;<span class="hljs-number">23</span>&nbsp;<br>&nbsp;<span class="hljs-number">24</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(MO.isReg())&nbsp;{<br>&nbsp;<span class="hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OS&nbsp;&lt;&lt;&nbsp;getRegisterName(MO.getReg(),&nbsp;MyRISCV::ABIRegAltName);<br>&nbsp;<span class="hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>;<br>&nbsp;<span class="hljs-number">27</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">28</span>&nbsp;<br>&nbsp;<span class="hljs-number">29</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(MO.isImm())&nbsp;{<br>&nbsp;<span class="hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OS&nbsp;&lt;&lt;&nbsp;MO.getImm();<br>&nbsp;<span class="hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>;<br>&nbsp;<span class="hljs-number">32</span>&nbsp;&nbsp;&nbsp;}<br>&nbsp;<span class="hljs-number">33</span>&nbsp;<br>&nbsp;<span class="hljs-number">34</span>&nbsp;&nbsp;&nbsp;assert(MO.isExpr()&nbsp;&amp;&amp;&nbsp;<span class="hljs-string">"Unknown&nbsp;operand&nbsp;kind&nbsp;in&nbsp;printOperand!"</span>);<br>&nbsp;<span class="hljs-number">35</span>&nbsp;&nbsp;&nbsp;MO.getExpr()-&gt;print(OS,&nbsp;&amp;MAI);<br>&nbsp;<span class="hljs-number">36</span>&nbsp;}<br></code></pre>
<ul>
<li><p>第 15～17 行，优先打印指令的别名，如果失败，则根据汇编格式打印指令。</p></li>
<li><p>第 20～36 行，目前仅支持打印指令的操作数为<code>寄存器</code>、<code>立即数</code>或<code>表达式</code>的情形。</p></li>
</ul>
<p><strong>step 25：</strong> MCTargetDesc/CMakeLists.txt</p>
<p>llvm/lib/Target/MyRISCV/MCTargetDesc/CMakeLists.txt 的内容如下：</p>
<pre><code class="hljs css"><span class="hljs-selector-tag">add_llvm_component_library</span>(<span class="hljs-selector-tag">LLVMMyRISCVDesc</span><br>&nbsp;&nbsp;<span class="hljs-selector-tag">MyRISCVMCTargetDesc</span><span class="hljs-selector-class">.cpp</span><br>&nbsp;&nbsp;<span class="hljs-selector-tag">MyRISCVMCAsmInfo</span><span class="hljs-selector-class">.cpp</span><br>&nbsp;&nbsp;<span class="hljs-selector-tag">MyRISCVInstPrinter</span><span class="hljs-selector-class">.cpp</span><br><br>&nbsp;&nbsp;<span class="hljs-selector-tag">LINK_COMPONENTS</span><br>&nbsp;&nbsp;<span class="hljs-selector-tag">MC</span><br>&nbsp;&nbsp;<span class="hljs-selector-tag">MyRISCVInfo</span><br>&nbsp;&nbsp;<span class="hljs-selector-tag">Support</span><br><br>&nbsp;&nbsp;<span class="hljs-selector-tag">ADD_TO_COMPONENT</span><br>&nbsp;&nbsp;<span class="hljs-selector-tag">MyRISCV</span><br>)<br></code></pre>
<p><strong>step 26：</strong> MyRISCVTargetInfo.h</p>
<p>llvm/lib/Target/MyRISCV/TargetInfo/MyRISCVTargetInfo.h 的内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_TARGETINFO_MYRISCVTARGETINFO_H</span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LLVM_LIB_TARGET_MYRISCV_TARGETINFO_MYRISCVTARGETINFO_H</span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Target</span>;</span><br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-function">Target&nbsp;&amp;<span class="hljs-title">getMyRISCV32Target</span><span class="hljs-params">()</span></span>;<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;namespace&nbsp;llvm</span><br>&nbsp;<span class="hljs-number">11</span>&nbsp;<br>&nbsp;<span class="hljs-number">12</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>&nbsp;<span class="hljs-comment">//&nbsp;LLVM_LIB_TARGET_MYRISCV_TARGETINFO_MYRISCVTARGETINFO_H</span></span><br></code></pre>
<p><strong>step 27：</strong> MyRISCVTargetInfo.cpp</p>
<p>llvm/lib/Target/MyRISCV/TargetInfo/MyRISCVTargetInfo.cpp 的内容如下：</p>
<pre><code class="hljs cpp">&nbsp;&nbsp;<span class="hljs-number">1</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"TargetInfo/MyRISCVTargetInfo.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">2</span>&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"llvm/Support/TargetRegistry.h"</span></span><br>&nbsp;&nbsp;<span class="hljs-number">3</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">4</span>&nbsp;<span class="hljs-keyword">using</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm;<br>&nbsp;&nbsp;<span class="hljs-number">5</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">6</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;llvm&nbsp;{<br>&nbsp;&nbsp;<span class="hljs-number">7</span>&nbsp;<br>&nbsp;&nbsp;<span class="hljs-number">8</span>&nbsp;<span class="hljs-function">Target&nbsp;&amp;<span class="hljs-title">getMyRISCV32Target</span><span class="hljs-params">()</span>&nbsp;</span>{<br>&nbsp;&nbsp;<span class="hljs-number">9</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">static</span>&nbsp;Target&nbsp;MyRISCV32Target;<br>&nbsp;<span class="hljs-number">10</span>&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;MyRISCV32Target;<br>&nbsp;<span class="hljs-number">11</span>&nbsp;}<br>&nbsp;<span class="hljs-number">12</span>&nbsp;<br>&nbsp;<span class="hljs-number">13</span>&nbsp;}&nbsp;<span class="hljs-comment">//&nbsp;end&nbsp;namespace&nbsp;llvm</span><br>&nbsp;<span class="hljs-number">14</span>&nbsp;<br>&nbsp;<span class="hljs-number">15</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-string">"C"</span>&nbsp;<span class="hljs-function">LLVM_EXTERNAL_VISIBILITY&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">LLVMInitializeMyRISCVTargetInfo</span><span class="hljs-params">()</span>&nbsp;</span>{<br>&nbsp;<span class="hljs-number">16</span>&nbsp;&nbsp;&nbsp;RegisterTarget&lt;Triple::myriscv32&gt;&nbsp;X(getMyRISCV32Target(),&nbsp;<span class="hljs-string">"myriscv32"</span>,<br>&nbsp;<span class="hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"32-bit&nbsp;RISC-V"</span>,&nbsp;<span class="hljs-string">"RISCV"</span>);<br>&nbsp;<span class="hljs-number">18</span>&nbsp;}<br></code></pre>
<p><strong>step 28：</strong> TargetInfo/CMakeLists.txt</p>
<p>llvm/lib/Target/MyRISCV/TargetInfo/CMakeLists.txt 的内容如下：</p>
<pre><code class="hljs css"><span class="hljs-selector-tag">add_llvm_component_library</span>(<span class="hljs-selector-tag">LLVMMyRISCVInfo</span><br>&nbsp;&nbsp;<span class="hljs-selector-tag">MyRISCVTargetInfo</span><span class="hljs-selector-class">.cpp</span><br><br>&nbsp;&nbsp;<span class="hljs-selector-tag">LINK_COMPONENTS</span><br>&nbsp;&nbsp;<span class="hljs-selector-tag">Support</span><br><br>&nbsp;&nbsp;<span class="hljs-selector-tag">ADD_TO_COMPONENT</span><br>&nbsp;&nbsp;<span class="hljs-selector-tag">MyRISCV</span><br>)<br></code></pre>
<hr>
<h3 id="hspanidjump6span"><span><span id="jump6">构建并运行</span></span></h3>
<p><strong>step 1：</strong> 编译</p>
<p>在构建目录中执行如下命令：</p>
<pre><code class="hljs php">$&nbsp;ninja<br></code></pre>
<p><strong>step 2：</strong> 运行</p>
<p>在构建目录的子目录<code>bin</code>中执行如下命令：</p>
<pre><code class="hljs cpp">$&nbsp;llc&nbsp;-march=myriscv32&nbsp;-filetype=<span class="hljs-keyword">asm</span>&nbsp;test.ll&nbsp;-o&nbsp;test_my.s<br></code></pre>
<p>test_my.s 的内容如下：</p>
<pre><code class="hljs bash">&nbsp;&nbsp;&nbsp;&nbsp;.text<br>&nbsp;&nbsp;&nbsp;&nbsp;.file&nbsp;&nbsp;&nbsp;<span class="hljs-string">"test.ll"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;.globl&nbsp;&nbsp;<span class="hljs-built_in">test</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;--&nbsp;Begin&nbsp;function&nbsp;test</span><br>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="hljs-built_in">type</span>&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">test</span>,@<span class="hljs-keyword">function</span><br><span class="hljs-built_in">test</span>:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;@test</span><br><span class="hljs-comment">#&nbsp;%bb.0:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;addi&nbsp;a0,&nbsp;zero,&nbsp;1<br>&nbsp;&nbsp;&nbsp;&nbsp;ret<br>.Lfunc_end0:<br>&nbsp;&nbsp;&nbsp;&nbsp;.size&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">test</span>,&nbsp;.Lfunc_end0-test<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#&nbsp;--&nbsp;End&nbsp;function</span><br>&nbsp;&nbsp;&nbsp;&nbsp;.section&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">".note.GNU-stack"</span>,<span class="hljs-string">""</span>,@progbits<br></code></pre>
<p>从上面的结果可以看出，目标后端<code>MyRISCV</code>也将 LLVM IR 语句<code>ret i32 1</code>翻译成了<code>addi    a0, zero, 1</code>和<code>ret</code>两条汇编代码。</p>
<hr>
<h3 id="hspanidjumpreferencesreferencesspan"><span><span id="jumpReferences">References</span></span></h3>
<ul>
<li><a href="https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMAFDQC/riscv-spec-20191213.pdf"><font size="4">riscv-spec-20191213</font></a></li>
</ul>
<hr>
<p><font size="4"><strong>下一篇：</strong><a href="https://csstormq.github.io/blog/LLVM%20%E4%B9%8B%E5%90%8E%E7%AB%AF%E7%AF%87%EF%BC%884%EF%BC%89%EF%BC%9A%E7%90%86%E8%A7%A3%E6%8C%87%E4%BB%A4%E9%80%89%E6%8B%A9%E7%9A%84%20dump%20%E8%BE%93%E5%87%BA">LLVM 之后端篇（4）：理解指令选择的 dump 输出</a></font></p>
<p><font size="4"><strong>上一篇：</strong><a href="https://csstormq.github.io/blog/LLVM%20%E4%B9%8B%E5%90%8E%E7%AB%AF%E7%AF%87%EF%BC%882%EF%BC%89%EF%BC%9A%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95%20llc%20%E7%9A%84%E7%9B%AE%E6%A0%87%E5%90%8E%E7%AB%AF">LLVM 之后端篇（2）：如何扩展 llc 的目标后端</a></font></p>
<p><font size="4"></font></p><p align="center"><font size="4"><a href="https://csstormq.github.io"><strong>首页</strong></a> </font></p><p></p></div></div></body>
</html>
